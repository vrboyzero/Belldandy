<!doctype html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Belldandy WebChat</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="/styles.css?v=10.0" />
</head>

<body>
  <main class="layout">
    <header class="header">
      <div class="title">Belldandy WebChat (MVP)</div>
      <div style="display: flex; gap: 8px; align-items: center;">
        <div class="token-usage" id="tokenUsage" title="Token Usage">
          <span class="token-label">SYS</span><span class="token-val" id="tuSys">--</span>
          <span class="token-sep">|</span>
          <span class="token-label">CTX</span><span class="token-val" id="tuCtx">--</span>
          <span class="token-sep">|</span>
          <span class="token-label">IN</span><span class="token-val" id="tuIn">--</span>
          <span class="token-sep">|</span>
          <span class="token-label">OUT</span><span class="token-val" id="tuOut">--</span>
          <span class="token-sep">|</span>
          <span class="token-label">ALL</span><span class="token-val token-val-all" id="tuAll">--</span>
        </div>
        <div class="status" id="status">disconnected</div>
        <button id="openSettings" class="settings-btn" title="Settings">&#x2699;&#xFE0F;</button>
      </div>
    </header>

    <section class="panel">
      <!-- è¾“å…¥è¡Œ -->
      <div class="row panel-input-row">
        <!-- å¯æ“ä½œåŒºè¾“å…¥ + ä¿å­˜æŒ‰é’® -->
        <div class="panel-input-group workspace-input-group">
          <div class="input-label-row">
            <span class="panel-label">å¯æ“ä½œåŒº<span class="panel-hint">ï¼šé¢å¤–å…è®¸è¯»å†™çš„ç›˜ç¬¦ä¸ç›®å½•</span></span>
          </div>
          <div class="input-with-btn">
            <input id="workspaceRoots" class="input input-sm" placeholder="E:/,D:/Game"
              title="é¢å¤–å…è®¸ Agent è¯»å†™çš„æ ¹ç›®å½•ï¼Œé€—å·åˆ†éš”" />
            <button id="saveWorkspaceRoots" class="save-link" title="ä¿å­˜åˆ° .env"><u>ä¿å­˜</u></button>
          </div>
        </div>
        <!-- Auth é€‰æ‹© -->
        <div class="panel-input-group auth-input-group">
          <div class="input-label-row">
            <span class="panel-label">Auth</span>
          </div>
          <div class="auth-controls">
            <select id="authMode" class="select select-sm">
              <option value="none">none</option>
              <option value="token">token</option>
              <option value="password">password</option>
            </select>
            <input id="authValue" class="input input-sm" placeholder="token / password" />
          </div>
        </div>
        <button id="connect" class="button">Connect</button>
      </div>
    </section>

    <div class="main-content">
      <!-- å·¦ä¾§è¾¹æ ï¼šæ™ºèƒ½ä½“è®¾ç½® -->
      <aside class="sidebar" id="sidebar">
        <!-- å¯¼èˆªåŒºåŸŸ -->
        <div style="padding: 12px 16px 0; display: flex; flex-direction: column; gap: 8px;">
          <button id="switchRoot" class="sidebar-action-btn"
            style="text-align: left; font-weight: 600; background: rgba(255,255,255,0.1); justify-content: flex-start;">ğŸ“‚
            æ™ºèƒ½ä½“è®¾ç½®</button>
          <button id="switchFacet" class="sidebar-action-btn"
            style="text-align: left; opacity: 0.7; justify-content: flex-start;">ğŸ§© æ¨¡ç»„ç¼–è¾‘</button>
        </div>

        <!-- æ ‘å¤´éƒ¨ -->
        <div class="sidebar-header"
          style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.05);">
          <span class="sidebar-title" id="treeTitle" style="font-size: 0.85em; opacity: 0.5;">æ–‡ä»¶åˆ—è¡¨</span>
          <div style="display: flex; gap: 4px;">
            <!-- é…ç½®æŒ‰é’®ç§»åˆ°è¿™é‡Œ -->
            <button id="openEnvEditor" class="sidebar-btn" title="ç¼–è¾‘ .env é…ç½®">âš™</button>
            <button id="refreshTree" class="sidebar-btn" title="åˆ·æ–°">âŸ³</button>
          </div>
        </div>

        <div class="file-tree" id="fileTree">
          <div class="tree-loading">åŠ è½½ä¸­...</div>
        </div>
      </aside>

      <!-- ä¸»åŒºåŸŸ -->
      <div class="main-area">
        <!-- èŠå¤©æ¨¡å¼ï¼šæ¶ˆæ¯åˆ—è¡¨ -->
        <section class="chat" id="chatSection">
          <div class="messages" id="messages"></div>
        </section>

        <!-- ç¼–è¾‘æ¨¡å¼ï¼šæ–‡ä»¶ç¼–è¾‘å™¨ -->
        <section class="editor-section hidden" id="editorSection">
          <div class="editor-header">
            <span class="editor-path" id="editorPath">æ–‡ä»¶è·¯å¾„</span>
          </div>
          <textarea class="editor-textarea" id="editorTextarea" spellcheck="false"></textarea>
        </section>
      </div>
    </div>

    <!-- èŠå¤©æ¨¡å¼ï¼šè¾“å…¥æ¡† -->
    <section class="composer" id="composerSection">
      <!-- é™„ä»¶é¢„è§ˆåŒº -->
      <div class="attachments-preview" id="attachmentsPreview"></div>
      <!-- è¾“å…¥åŒº -->
      <div class="composer-input-row">
        <button id="attachBtn" class="attach-btn" title="æ·»åŠ é™„ä»¶">+</button>
        <input type="file" id="fileInput" class="hidden" multiple
          accept=".jpg,.jpeg,.png,.gif,.webp,.txt,.md,.json,.log,.mp4,.mov,.avi,.webm,.mkv" />
        <textarea id="prompt" class="input" placeholder="è¾“å…¥æ¶ˆæ¯â€¦ (å¯æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤)" rows="1"></textarea>
        <button id="send" class="button" disabled>Send</button>
      </div>
    </section>

    <!-- ç¼–è¾‘æ¨¡å¼ï¼šæ“ä½œæŒ‰é’® -->
    <section class="editor-actions hidden" id="editorActions">
      <button id="cancelEdit" class="button editor-cancel">å–æ¶ˆ</button>
      <button id="saveEdit" class="button editor-save">ä¿å­˜</button>
    </section>
  </main>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal-overlay hidden">
    <div class="modal">
      <div class="modal-header">
        <span>Settings</span>
        <button id="closeSettings" class="settings-btn">âœ•</button>
      </div>
      <div class="modal-body">
        <!-- Doctor Status -->
        <div class="form-group">
          <label class="form-label">System Doctor</label>
          <div id="doctorStatus" style="display: flex; flex-wrap: wrap; gap: 8px;">
            <span class="badge">Checking...</span>
          </div>
        </div>
        <hr style="width: 100%; border: 0; border-top: 1px solid #eee;">

        <!-- Config Fields -->
        <div class="form-group">
          <label class="form-label">OpenAI API Key</label>
          <input id="cfgApiKey" class="input" type="password" placeholder="sk-..." />
        </div>
        <div class="form-group">
          <label class="form-label">OpenAI Base URL</label>
          <input id="cfgBaseUrl" class="input" placeholder="https://api.openai.com/v1" />
        </div>
        <div class="form-group">
          <label class="form-label">OpenAI Model</label>
          <input id="cfgModel" class="input" placeholder="gpt-4o" />
        </div>
        <div class="form-group">
          <label class="form-label">Heartbeat Interval</label>
          <input id="cfgHeartbeat" class="input" placeholder="30m" />
        </div>
      </div>
      <div class="modal-footer">
        <button id="restartBtn" class="button" style="color: #666;">Restart Server</button>
        <button id="saveSettings" class="button" style="background: #333; color: white;">Save</button>
      </div>
    </div>
  </div>

  <!-- Awakening Overlay -->
  <div id="awakening" class="awakening-overlay hidden">
    <div class="scanline"></div>
    <div class="terminal-container">
      <div id="bootLog" class="boot-log"></div>
    </div>
  </div>

  <!-- Restart Countdown Overlay -->
  <div id="restartOverlay" class="restart-overlay hidden">
    <div class="restart-content">
      <div class="restart-icon">âŸ³</div>
      <div class="restart-title">Service Restarting</div>
      <div id="restartReason" class="restart-reason"></div>
      <div id="restartCountdown" class="restart-countdown">3</div>
    </div>
  </div>

  <script type="module" src="/app.js"></script>
</body>

</html>