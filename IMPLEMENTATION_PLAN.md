# Belldandy å®æ–½è®¡åˆ’

## 1. èŒƒå›´ä¸çº¦æŸ

- **å¼€å‘ç›®å½•**ï¼š`e:\project\Belldandy`
- **å‚è€ƒç›®å½•ï¼ˆåªè¯»ï¼‰**ï¼š`E:\project\belldandy\openclaw`ï¼ˆä¸ä¿®æ”¹ã€ä¸ç¼–ç ï¼‰
- **å‚è€ƒç›®å½•ï¼ˆåªè¯»ï¼‰**ï¼š`E:\project\belldandy\UI-TARS-desktop-main`ï¼ˆä¸ä¿®æ”¹ã€ä¸ç¼–ç ï¼‰


## 1.1 æŠ€æœ¯æ ˆä¸å·¥ç¨‹å½¢æ€ï¼ˆå»ºè®®ï¼‰

- Runtimeï¼šNode.jsï¼ˆå¯¹é½ moltbot çš„æ€è·¯ï¼Œä¼˜å…ˆä½¿ç”¨è¾ƒæ–°ç‰ˆæœ¬ï¼‰
- è¯­è¨€ï¼šTypeScriptï¼ˆESMï¼‰
- åŒ…ç®¡ç†ï¼špnpm workspaceï¼ˆä¾¿äºæ‹†åˆ† `core/agent/channels/skills/memory/ui`ï¼‰
- æµ‹è¯•ï¼švitestï¼ˆå•æµ‹ + æœ€å°é›†æˆï¼‰
- ç›®å½•ç»„ç»‡ï¼ˆè§„åˆ’ï¼‰ï¼š
  - `packages/belldandy-core`
  - `packages/belldandy-agent`
  - `packages/belldandy-channels`
  - `packages/belldandy-skills`
  - `packages/belldandy-memory`
  - `apps/web`

## 2. æ€»ä½“æ¶æ„è‰å›¾

```mermaid
flowchart TB
  subgraph Channels
    WebChat[WebChat UI]
    TG[Telegram Bot (phase 2)]
  end

  WebChat -->|WS| GW[Gateway]
  TG -->|inbound/outbound| GW

  GW -->|RPC/Invoke| AG[Agent Runtime]
  AG -->|tools| SK[Skills/Tools]
  AG -->|retrieve| MEM[Memory Index]

  GW -->|events chat/agent/presence| WebChat
```

## 2.5 Phase æ€»è§ˆä¸ç´¢å¼•

> æœ¬èŠ‚æä¾›æ‰€æœ‰ Phase çš„ç®€è¦ç´¢å¼•ï¼Œæ–¹ä¾¿å¿«é€Ÿå®šä½è¯¦ç»†è¯´æ˜ï¼›ç¼–å·ä¿æŒåŸæœ‰é¡ºåºï¼Œä»…åœ¨ä¸ªåˆ«å®‰å…¨å­é˜¶æ®µæ ‡æ³¨å­ç¼–å·ï¼ˆå¦‚ 3Sï¼‰ã€‚

- **Phase 0**ï¼šæ–‡æ¡£ä¸è¾¹ç•Œ
- **Phase 1 / 1.5 / 2 / 2.5 / 2.6 / 3ï¼ˆUIï¼‰**ï¼šå·¥ç¨‹éª¨æ¶ â†’ æœ€å°é—­ç¯ â†’ æé€Ÿå¯åŠ¨ â†’ é…ç½® & Doctor â†’ å·¥å…·ç®¡ç† â†’ æè‡´ç¾å­¦é‡æ„
- **Phase 3Sï¼ˆå®‰å…¨å­é˜¶æ®µï¼‰**ï¼šé»˜è®¤å®‰å…¨ç­–ç•¥ï¼ˆpairing/allowlistï¼‰
- **Phase 4 / 4.5 / 4.6**ï¼šSkills + Memory â†’ Vector Memory â†’ Session Persistence
- **Phase 5**ï¼šSOUL / Persona äººæ ¼ç³»ç»Ÿ
- **Phase 6 / 7**ï¼šé£ä¹¦æ¸ é“ã€Heartbeat å®šæ—¶ä»»åŠ¡
- **Phase 8â€“10â€“11â€“12â€“13â€“13.5â€“13.6**ï¼šMoltbot èƒ½åŠ›å¯¹æ ‡ã€æµè§ˆå™¨æ‰©å±•ã€ç³»ç»Ÿæ‰§è¡Œã€å®æ—¶æ–‡ä»¶æ„ŸçŸ¥ã€å‘é‡åŠ é€Ÿã€å¤šåª’ä½“ä¸è§†è§‰ã€Kimi åŸç”Ÿè§†è§‰
- **Phase 14**ï¼šæ–¹æ³•è®ºç³»ç»Ÿï¼ˆè‡ªæˆ‘è¿›åŒ–ï¼‰
- **Phase 15**ï¼šæ¸ é“æ¶æ„å‡çº§ï¼ˆChannel Architectureï¼‰
- **Phase 16**ï¼šå­ Agent ç¼–æ’ï¼ˆè§„åˆ’ä¸­ï¼‰
- **Phase 17â€“18**ï¼šMCP æ”¯æŒã€æ—¥å¿—ç³»ç»Ÿ
- **Phase 19**ï¼šå®‰å…¨åŠ å›ºï¼ˆSecurity Hardeningï¼‰âœ… å·²å®Œæˆ
- **Phase 20**ï¼šWebChat UI å¢å¼º âœ… å·²å®Œæˆ
- **Phase 21**ï¼šæœåŠ¡é‡å¯å·¥å…·ï¼ˆService Restart Toolï¼‰âœ… å·²å®Œæˆ
- **Phase 22**ï¼šFACET æ¨¡ç»„åˆ‡æ¢å·¥å…·ï¼ˆswitch_facetï¼‰âœ… å·²å®Œæˆ
- **Phase 23**ï¼šä¸Šä¸‹æ–‡è‡ªåŠ¨å‹ç¼©ï¼ˆContext Compactionï¼‰âœ… å·²å®Œæˆ
- **Windows å…¼å®¹æ€§å¢å¼º**ï¼šå¯¹åº” Roadmap Phase 15 çš„å¹³å°å…¼å®¹ä»»åŠ¡ï¼Œè¯¦è§åæ–‡

## 3. é‡Œç¨‹ç¢‘ä¸é˜¶æ®µåˆ’åˆ†

### Phase 0ï¼šæ–‡æ¡£ä¸è¾¹ç•Œï¼ˆå·²å®Œæˆï¼‰

- PRDã€å®æ–½è®¡åˆ’ã€README åœ¨ `Belldandy/` ç›®å½•è½ç›˜
- æ˜ç¡®â€œmoltbot åªè¯»å‚è€ƒâ€çš„è¾¹ç•Œä¸æ¨¡å—å¯¹ç…§è¡¨

### Phase 1ï¼šå·¥ç¨‹éª¨æ¶ï¼ˆMVP åŸºç¡€è®¾æ–½ï¼Œå·²å®Œæˆï¼‰

**ç›®æ ‡**ï¼šèƒ½ç¼–è¯‘ã€èƒ½è·‘æœ€å°æœåŠ¡ï¼Œå…·å¤‡åŸºç¡€é…ç½®ä¸æ—¥å¿—æ¡†æ¶ã€‚

- åˆå§‹åŒ–å·¥ç¨‹ç»“æ„ï¼ˆå»ºè®® monorepo æˆ–å•ä»“åˆ†åŒ…ï¼Œå–å†³äºåç»­æ‰©å±•ï¼‰
- çº¦å®šæ¨¡å—è¾¹ç•Œï¼š
  - `gateway`ï¼šWS/HTTPã€é‰´æƒã€äº‹ä»¶æ€»çº¿
  - `agent`ï¼šæ¨¡å‹è°ƒç”¨ä¸æµå¼è¾“å‡ºã€å·¥å…·æ‰§è¡Œ
  - `skills`ï¼šskills loader + è¿è¡Œæ²™ç›’/ç™½åå•
  - `memory`ï¼šåŸºç¡€ç´¢å¼•ä¸æ£€ç´¢æ¥å£ï¼ˆå…ˆ keywordï¼‰
  - `ui`ï¼šWebChat æœ€å°ç•Œé¢
- é…ç½® schemaï¼šå‚è€ƒ moltbot çš„ zod schema è®¾è®¡å‡º Belldandy æœ€å° configï¼ˆgateway/auth/logging/models/channels/skillsï¼‰

**éªŒæ”¶**ï¼š
- `gateway` å¯ä»¥å¯åŠ¨å¹¶è¾“å‡ºå¯åŠ¨ä¿¡æ¯
- é…ç½®è¯»å–ä¸æ ¡éªŒå¯è¿è¡Œï¼ˆé”™è¯¯æç¤ºå¯è¡ŒåŠ¨ï¼‰

**å·²è½åœ°ï¼ˆå½“å‰ä»“åº“çŠ¶æ€ï¼‰**ï¼š
- å·²å»ºç«‹ pnpm workspace + TypeScript project references åŸºç¡€å·¥ç¨‹éª¨æ¶
- å·²å®ç° Gateway å¯å¯åŠ¨å¹¶æœåŠ¡é™æ€ WebChat
- å·²è¡¥é½æœ€å° vitest é›†æˆæµ‹è¯•ä¸ build é€šè¿‡

### Phase 2ï¼šç«¯åˆ°ç«¯æœ€å°é—­ç¯ï¼ˆWebChatï¼Œå·²å®Œæˆï¼šMockAgentï¼‰

**ç›®æ ‡**ï¼šWebChat è¾“å…¥ä¸€å¥è¯ï¼Œçœ‹åˆ°æµå¼å›å¤ï¼›æ‰€æœ‰æ•°æ®æµèµ° Gatewayã€‚

- Gatewayï¼šå®ç° WS æ¡æ‰‹/é‰´æƒ/req-res + äº‹ä»¶å¹¿æ’­
- UIï¼šå®ç°æœ€å° chat é¡µé¢ï¼š
  - è¿æ¥ WS
  - å‘é€ message
  - è®¢é˜… chat delta/final å¹¶æ¸²æŸ“
- Agentï¼šå®ç°å• provider çš„æ¨¡å‹è°ƒç”¨ï¼ˆå…ˆé€‰ä¸€ä¸ªï¼‰ï¼Œå¹¶æŠŠè¾“å‡ºè½¬æˆ Gateway äº‹ä»¶

**å…³é”®æ—¶åºï¼ˆå»ºè®®ï¼‰**ï¼š

```mermaid
sequenceDiagram
  participant UI as WebChat UI
  participant GW as Gateway (WS)
  participant AG as Agent Runtime

  UI->>GW: connect
  GW-->>UI: hello-ok (features/methods/events)
  UI->>GW: req message.send {text, conversationId}
  GW->>AG: run {prompt, context, conversationId}
  AG-->>GW: event chat.delta {conversationId, textDelta}
  GW-->>UI: event chat.delta {conversationId, textDelta}
  AG-->>GW: event chat.final {conversationId, textFinal}
  GW-->>UI: event chat.final {conversationId, textFinal}
```

**éªŒæ”¶ï¼ˆE2Eï¼‰**ï¼š
- WebChat â†’ å‘é€æ¶ˆæ¯ â†’ æ”¶åˆ°å¢é‡è¾“å‡ºï¼ˆdeltaï¼‰â†’ æ”¶åˆ° final
- æ–­çº¿é‡è¿åèƒ½ç»§ç»­å·¥ä½œï¼ˆå¯å…ˆç®€åŒ–ä¸ºæ‰‹åŠ¨åˆ·æ–°ï¼‰

**å·²è½åœ°ï¼ˆå½“å‰ä»“åº“çŠ¶æ€ï¼‰**ï¼š
- å·²å®ç° `message.send` + `chat.delta/chat.final` äº‹ä»¶æµ
- Agent é»˜è®¤ä½¿ç”¨ **MockAgent**ï¼ˆç”¨äºæœ¬åœ°è·‘é€šåè®®ä¸æµå¼ç®¡é“ï¼‰ï¼Œå¹¶æ”¯æŒåˆ‡æ¢åˆ° OpenAI åè®®å…¼å®¹ Provider
- WS é‰´æƒå·²æ”¯æŒ `none | token | password`ï¼ˆé»˜è®¤ noneï¼‰

**Phase 2.1ï¼ˆçœŸå®æ¨¡å‹ Providerï¼Œå·²è½åœ°ï¼šOpenAI åè®®ï¼‰**ï¼š
- å·²æ”¯æŒ OpenAI åè®® `chat.completions`ï¼ˆå¯é…ç½® base_url/api_key/modelï¼‰
- é»˜è®¤ä½¿ç”¨ SSE æµå¼è¿”å›å¹¶è½¬å‘ä¸º `chat.delta/chat.final`
- é€šè¿‡ç¯å¢ƒå˜é‡å¯ç”¨ï¼ˆä¸åœ¨ä»“åº“ä¿å­˜ keyï¼‰

### Phase 1.5: æé€Ÿå¯åŠ¨ (One-Click Launchers) [å·²å®Œæˆ]

**æ ¸å¿ƒç›®æ ‡**ï¼šè®©ç”¨æˆ·æ— éœ€æ‰“å¼€ç»ˆç«¯å³å¯å¯åŠ¨ Belldandyï¼Œå¹¶å…·å¤‡è‡ªåŠ¨ç¯å¢ƒæ£€æŸ¥ä¸ä¾èµ–å®‰è£…èƒ½åŠ›ã€‚

**å·²è½åœ° (2026-02-04)**ï¼š
- **è„šæœ¬å®ç°**ï¼š
    - Windows (`start.bat`): åŒå‡»å¯åŠ¨ -> æ£€æŸ¥ node/pnpm -> `pnpm install` (å¦‚æœ‰å¿…è¦) -> å¯åŠ¨ Gateway -> è‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨ã€‚
    - macOS/Linux (`start.sh`): åŒä¸Šã€‚
- **è¿ç»´èƒ½åŠ›**ï¼š
    - **è‡ªåŠ¨é‡å¯ç¯ (Restart Loop)**ï¼šè„šæœ¬åŒ…å« `while` å¾ªç¯ï¼Œå½“ Gateway è¿›ç¨‹ä»¥çŠ¶æ€ç  `100` é€€å‡ºæ—¶ï¼Œè‡ªåŠ¨é‡æ–°æ‹‰èµ·è¿›ç¨‹ã€‚
    - **Magic Link**: å¯åŠ¨æ—¶ç”Ÿæˆä¸€æ¬¡æ€§ Token å¹¶è‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨ï¼Œè·³è¿‡ WebUI çš„æ‰‹åŠ¨ Pairing è¿‡ç¨‹ï¼Œç›´æ¥è¿›å…¥ã€‚

### Phase 2.5: å¯è§†åŒ–é…ç½® & åŒ»ç”Ÿ (Settings & Doctor) [å·²å®Œæˆ]

**æ ¸å¿ƒç›®æ ‡**ï¼šæä¾›ä¸€ä¸ªç®€å•çš„ Web ç•Œé¢ï¼Œè®©ç”¨æˆ·èƒ½ç›´è§‚åœ°ä¿®æ”¹é…ç½®ã€è¯Šæ–­é—®é¢˜ã€‚

**å·²è½åœ° (2026-02-04)**ï¼š
- **Prerequisite (Startup Optimization)**:
    - **å®½å®¹å¯åŠ¨ (Lenient Mode)**ï¼šä¿®æ”¹ `gateway.ts`ï¼Œåœ¨ç¼ºå°‘ Key æ—¶ä¸å† Crashï¼Œè€Œæ˜¯æ­£å¸¸å¯åŠ¨ Web åŠ WS æœåŠ¡ã€‚
    - **æƒ°æ€§æ£€æŸ¥ (Lazy Check)**ï¼šå°† API Key æ ¡éªŒæ¨è¿Ÿåˆ° `message.send` è¯·æ±‚æ—¶åˆ»ã€‚è‹¥é…ç½®ç¼ºå¤±ï¼Œè¿”å› `config_required` é”™è¯¯ç ã€‚
- **Feature: Doctor (è´è´åŒ»ç”Ÿ)**:
    - **Backend**: æ–°å¢ `system.doctor` æ¥å£ï¼Œæ£€æŸ¥ Node ç‰ˆæœ¬ã€ç½‘ç»œè¿é€šæ€§ã€å‘é‡åº“çŠ¶æ€ã€Agenté…ç½®çŠ¶æ€ã€‚
    - **Frontend**: åœ¨ WebChat è®¾ç½®é¡µæ·»åŠ â€œä½“æ£€â€æŒ‰é’®ï¼Œä»¥å¯è§†åŒ–æ–¹å¼å±•ç¤ºæ£€æŸ¥é¡¹ã€‚
- **Feature: Settings (é…ç½®)**:
    - æä¾› API Keyã€Modelã€Heartbeat ç­‰é…ç½®çš„å¯è§†åŒ–ä¿®æ”¹ã€‚
    - **é‡å¯æŒ‰é’®**: ç•Œé¢ç‚¹å‡»â€œä¿å­˜å¹¶é‡å¯â€ -> åç«¯ `process.exit(100)` -> è§¦å‘å¤–éƒ¨è„šæœ¬çš„ Restart Loopã€‚
- **Feature: Awakening (å”¤é†’ä¸å¼•å¯¼ - One Time)**:
    - **Magic Link**: é…åˆ Phase 1.5 å®ç°ï¼Œé€šè¿‡ URL Token è‡ªåŠ¨é‰´æƒã€‚

### Phase 2.6: å¯è§†åŒ–å·¥å…·ç®¡ç† (Tool & MCP Management UI) [å·²å®Œæˆ]

**æ ¸å¿ƒç›®æ ‡**ï¼šèµ‹äºˆç”¨æˆ·ç²¾ç»†æ§åˆ¶ Agent èƒ½åŠ›è¾¹ç•Œçš„æƒé™ï¼Œå…è®¸åœ¨è¿è¡Œæ—¶åŠ¨æ€å¯ç”¨/ç¦ç”¨ç‰¹å®šçš„å·¥å…·ã€MCP æœåŠ¡å™¨æˆ–æ’ä»¶ã€‚

**å·²è½åœ° (2026-02-15)**ï¼š
- **UI å®ç°**:
    - WebChat é¡¶éƒ¨æ–°å¢å·¥å…·è®¾ç½®å…¥å£ (ğŸ› ï¸)ã€‚
    - æ”¯æŒ Builtin / MCP / Plugins åˆ†ç±»ç®¡ç†ã€‚
- **é…ç½®æŒä¹…åŒ–**:
    - å®æ—¶å¼€å…³å·¥å…·çŠ¶æ€ï¼Œå¹¶æŒä¹…åŒ–åˆ° Server é…ç½®ã€‚
    - åç«¯æ–°å¢ `tools.list` / `tools.update` åè®®ã€‚

### Phase 3: æè‡´ç¾å­¦é‡æ„ (Ethereal Digital UI) [å·²å®Œæˆ]

**æ ¸å¿ƒç›®æ ‡**ï¼šå°† MVP ç‰ˆæœ¬çš„ç®€é™‹ç•Œé¢å‡çº§ä¸º"Fashionable & Beautiful"çš„æå®¢ç¾å­¦ä½“éªŒã€‚

**å·²è½åœ° (2026-02-04)**ï¼š
- **è®¾è®¡é£æ ¼ (Ethereal Digital)**:
    - **Deep Void**: æ·±ç©ºé»‘èƒŒæ™¯ï¼Œæ²‰æµ¸å¼ä½“éªŒã€‚
    - **Glassmorphism**: æ¶ˆæ¯æ°”æ³¡ä¸è®¾ç½®é¢æ¿é‡‡ç”¨ç£¨ç ‚ç»ç’ƒæ‹Ÿæ€ã€‚
    - **Typography**: å¼•å…¥ `Outfit` (æ ‡é¢˜) å’Œ `Inter` (æ­£æ–‡) å­—ä½“ï¼Œæå‡é˜…è¯»è´¨æ„Ÿã€‚
- **äº¤äº’ä¼˜åŒ–**:
    - **Awakening Ritual (å”¤é†’ä»ªå¼)**: é¦–æ¬¡è¿æ¥æ—¶çš„ Cyber-terminal é£æ ¼å¯åŠ¨è‡ªæ£€åŠ¨ç”» (`Initializing Neural Interface...`)ã€‚
    - **Smart Input**: æ”¯æŒè‡ªåŠ¨å˜é«˜çš„å¤šè¡Œè¾“å…¥æ¡† (Shift+Enter æ¢è¡Œ)ã€‚
    - **Smooth Motion**: æ¶ˆæ¯æ°”æ³¡çš„å¹³æ»‘ä¸Šæµ®åŠ¨ç”» ä¸ å‘¼å¸ç¯çŠ¶æ€æŒ‡ç¤ºã€‚

### Phase 3Sï¼šé»˜è®¤å®‰å…¨ç­–ç•¥ï¼ˆpairing/allowlistï¼‰

> è¯´æ˜ï¼šæœ¬èŠ‚è§†ä¸º Phase 3 çš„å®‰å…¨å­é˜¶æ®µï¼ˆSafety Sub-phaseï¼‰ï¼Œç¼–å· **3S**ï¼Œä¸ UI å‘å‰ç«¯ç¾å­¦é‡æ„çš„ Phase 3 å¹¶è¡Œã€‚

**ç›®æ ‡**ï¼šæœªçŸ¥å…¥ç«™é»˜è®¤ä¸è§¦å‘ agentï¼›å¿…é¡»é€šè¿‡ pairing æ‰æ”¾è¡Œã€‚

- è®¾è®¡ allowlist å­˜å‚¨ï¼ˆæ–‡ä»¶æƒé™ + æ–‡ä»¶é”ï¼‰
- ä¸º WebChat æˆ– Telegramï¼ˆè‹¥å·²å¼•å…¥ï¼‰åŠ å…¥ pairing æµç¨‹ï¼š
  - æœªçŸ¥æ¥æºè¿”å› pairing code
  - approve ååŠ å…¥ allowlist
- CLI æˆ– UI æä¾› approve ç®¡ç†å…¥å£ï¼ˆMVP æ¨è CLIï¼‰

**éªŒæ”¶**ï¼š
- æœªé…å¯¹æ¥æºä¸ä¼šè§¦å‘ agent
- approve åå¯æ­£å¸¸å¯¹è¯

**å½“å‰è¿›åº¦ï¼ˆå·²è½åœ°ï¼‰**ï¼š
- Gateway å·²å¯¹ `message.send` å¼ºåˆ¶ allowlistï¼šæœªæˆæƒè¿”å› `pairing_required`ï¼Œå¹¶æ¨é€ `pairing.required` äº‹ä»¶ï¼ˆå«é…å¯¹ç ï¼‰
- WebChat å·²æ”¯æŒæŒä¹… `clientId`ï¼Œå¹¶ä¼šå±•ç¤ºé…å¯¹ç ä¸æœ¬æœº approve å‘½ä»¤æç¤º
- å·²æä¾›æœ¬æœºå‘½ä»¤ï¼š
  - `corepack pnpm pairing:approve <CODE>`
  - `corepack pnpm pairing:revoke <CLIENT_ID>`
- å·²åœ¨é›†æˆæµ‹è¯•ä¸­è¦†ç›–â€œå…ˆè§¦å‘ pairing â†’ approve â†’ å†æ¬¡å‘é€æ¶ˆæ¯æˆåŠŸâ€çš„æµç¨‹

### Phase 3.1ï¼šPairing ç®¡ç†å®Œå–„ï¼ˆä¸‹ä¸€æ­¥ï¼‰

**ç›®æ ‡**ï¼šè®© pairing/allowlist å¯è§‚æµ‹ã€å¯ç»´æŠ¤ã€å¯è¿ç§»ï¼›é¿å…â€œé…å¯¹å¡æ­»/æ•°æ®ä¸å¯æ§/éš¾ä»¥æ’æŸ¥â€ã€‚

**åŠŸèƒ½æ¸…å•ï¼ˆå¯éªŒæ”¶ï¼‰**ï¼š
- åˆ—å‡º allowlistï¼šæ”¯æŒæŸ¥çœ‹å·²æˆæƒçš„ `clientId` åˆ—è¡¨
- åˆ—å‡º pendingï¼šæ”¯æŒæŸ¥çœ‹æœª approve çš„ pairing code åˆ—è¡¨ï¼ˆå«åˆ›å»ºæ—¶é—´ã€clientIdï¼‰
- æ¸…ç†è¿‡æœŸ pendingï¼šæä¾›å‘½ä»¤æ¸…ç†è¿‡æœŸ pairingï¼ˆé»˜è®¤ TTL 1hï¼‰ï¼Œå¹¶æ”¯æŒ dry-run
- æ’¤é”€æˆæƒï¼šæ”¯æŒæŒ‰ `clientId` revokeï¼ˆå·²å…·å¤‡ï¼‰ï¼Œå¹¶åœ¨è¾“å‡ºä¸­æ ‡æ˜æ˜¯å¦å‘½ä¸­
- å¯¼å‡º/å¯¼å…¥ï¼šæ”¯æŒæŠŠ allowlist/pending å¯¼å‡ºä¸º JSONï¼Œå¹¶æ”¯æŒä» JSON å¯¼å…¥ï¼ˆæ”¯æŒè¦†ç›–/åˆå¹¶ä¸¤ç§æ¨¡å¼ï¼‰
- å­˜å‚¨ä½ç½®å¯æ§ï¼šé€šè¿‡ `BELLDANDY_STATE_DIR` æŒ‡å®šå­˜å‚¨ç›®å½•ï¼Œå¹¶åœ¨å‘½ä»¤è¾“å‡ºä¸­æç¤ºå½“å‰ç”Ÿæ•ˆè·¯å¾„

**å»ºè®®å‘½ä»¤å½¢å¼ï¼ˆMVPï¼‰**ï¼š
- `corepack pnpm pairing:list`
- `corepack pnpm pairing:pending`
- `corepack pnpm pairing:cleanup [--dry-run]`
- `corepack pnpm pairing:approve <CODE>`ï¼ˆå·²å…·å¤‡ï¼‰
- `corepack pnpm pairing:revoke <CLIENT_ID>`ï¼ˆå·²å…·å¤‡ï¼‰
- `corepack pnpm pairing:export --out <FILE> [--include-pending]`
- `corepack pnpm pairing:import --in <FILE> [--mode merge|replace]`

**éªŒæ”¶ç”¨ä¾‹**ï¼š
- åˆæ¬¡å‘é€æ¶ˆæ¯è§¦å‘ pairing codeï¼›`pairing:pending` èƒ½çœ‹åˆ°è¯¥ code
- `pairing:approve <CODE>` åï¼Œcode ä» pending æ¶ˆå¤±ï¼ŒclientId å‡ºç°åœ¨ allowlist
- `pairing:export` ååˆ é™¤æœ¬åœ° stateDirï¼Œæ‰§è¡Œ `pairing:import` æ¢å¤åä»å¯å¯¹è¯
- `pairing:cleanup --dry-run` åªæ‰“å°å°†æ¸…ç†é¡¹ï¼Œä¸ä¿®æ”¹æ–‡ä»¶ï¼›ä¸å¸¦ `--dry-run` æ‰å®é™…åˆ é™¤

### Phase 4ï¼šSkills + Memoryï¼ˆå¯ç”¨æ€§å¢å¼ºï¼Œè¿›è¡Œä¸­ï¼‰

**ç›®æ ‡**ï¼šè®©åŠ©æ‰‹å¯æ‰§è¡Œå—æ§å·¥å…·ã€å¯æ£€ç´¢æœ¬åœ°è®°å¿†ã€‚

#### 4.1 æ–°å¢åŒ…ç»“æ„ï¼ˆå½“å‰è½åœ°ï¼‰

```
packages/
â”œâ”€â”€ belldandy-skills/       # æ–°å»ºï¼šå·¥å…·ç³»ç»Ÿï¼ˆå·²å®Œæˆï¼‰
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ index.ts        # å¯¼å‡º
â”‚       â”œâ”€â”€ types.ts        # Tool æ¥å£å®šä¹‰
â”‚       â”œâ”€â”€ executor.ts     # æ‰§è¡Œå™¨ï¼ˆå«æƒé™æ£€æŸ¥ï¼‰
â”‚       â””â”€â”€ builtin/
â”‚           â”œâ”€â”€ fetch.ts    # ç½‘ç»œè®¿é—®å·¥å…·
â”‚           â””â”€â”€ file.ts     # æ–‡ä»¶è¯»å†™å·¥å…·
â””â”€â”€ belldandy-memory/       # æ–°å»ºï¼šè®°å¿†ç³»ç»Ÿï¼ˆå·²å®Œæˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
    â””â”€â”€ src/
        â”œâ”€â”€ index.ts        # å¯¼å‡º
        â”œâ”€â”€ types.ts        # Memory ç±»å‹
        â”œâ”€â”€ store.ts        # SQLite + FTS5 å­˜å‚¨å±‚
        â”œâ”€â”€ chunker.ts      # æ–‡æœ¬åˆ†å—å™¨
        â”œâ”€â”€ indexer.ts      # ç›®å½•/æ–‡ä»¶ç´¢å¼•å™¨
        â””â”€â”€ *.test.ts       # æµ‹è¯•æ–‡ä»¶
```

#### 4.2 å®ç°æ­¥éª¤ï¼ˆæ›´æ–°ï¼‰

| Step | å†…å®¹ | çŠ¶æ€ |
|------|------|------|
| 1 | Skills ç±»å‹ä¸æ‰§è¡Œå™¨ | âœ… å·²å®Œæˆ |
| 2 | å†…ç½® web_fetch å·¥å…·ï¼ˆå®‰å…¨çº¦æŸï¼šåè®®/åŸŸå/å†…ç½‘/è¶…æ—¶ï¼‰ | âœ… å·²å®Œæˆ |
| 3 | å†…ç½® file_read/file_write å·¥å…·ï¼ˆè·¯å¾„éå†é˜²æŠ¤ã€æ•æ„Ÿæ–‡ä»¶é»‘åå•ï¼‰ | âœ… å·²å®Œæˆ |
| 4 | ToolEnabledAgentï¼ˆfunction calling å¾ªç¯ï¼‰ | âœ… å·²å®Œæˆ |
| 5 | Memory å­˜å‚¨å±‚ï¼ˆSQLite + FTS5ï¼‰ | âœ… å·²å®Œæˆ |
| 6 | Memory ç´¢å¼•å™¨ï¼ˆåˆ†å— + å¢é‡æ›´æ–°ï¼‰ | âœ… å·²å®Œæˆ |
| 7 | Memory ä¸ Agent é›†æˆ | âœ… å·²å®Œæˆ |

**Step 1-4 å·²è½åœ°å†…å®¹**ï¼š

```
packages/belldandy-skills/
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â””â”€â”€ src/
    â”œâ”€â”€ index.ts           # å¯¼å‡º
    â”œâ”€â”€ types.ts           # Tool/ToolPolicy/ToolCallResult ç­‰ç±»å‹
    â”œâ”€â”€ executor.ts        # ToolExecutorï¼ˆæƒé™æ£€æŸ¥ + å®¡è®¡æ—¥å¿— + æ•æ„Ÿå‚æ•°è„±æ•ï¼‰
    â”œâ”€â”€ executor.test.ts   # 8 ä¸ªæµ‹è¯•
    â””â”€â”€ builtin/
        â”œâ”€â”€ fetch.ts       # web_fetchï¼ˆåè®®/åŸŸå/å†…ç½‘/è¶…æ—¶/å“åº”å¤§å°é™åˆ¶ï¼‰
        â”œâ”€â”€ fetch.test.ts  # 16 ä¸ªæµ‹è¯•
        â”œâ”€â”€ file.ts        # file_read/file_writeï¼ˆè·¯å¾„éå†/æ•æ„Ÿæ–‡ä»¶/ç™½åå•ï¼‰
        â””â”€â”€ file.test.ts   # 19 ä¸ªæµ‹è¯•

packages/belldandy-agent/src/
â”œâ”€â”€ index.ts               # æ–°å¢ AgentToolCall/AgentToolResult
â””â”€â”€ tool-agent.ts          # ToolEnabledAgent
```

**å…± 43 ä¸ªå•å…ƒæµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼›ToolEnabledAgent æ„å»ºé€šè¿‡ã€‚**

#### 4.3 Skills å®‰å…¨çº¦æŸ

- **web_fetch**ï¼šä»… HTTP/HTTPSã€ç¦æ­¢å†…ç½‘ IPï¼ˆ127.0.0.1/192.168.x/10.x/172.16-31.xï¼‰ã€åŸŸåç™½/é»‘åå•ã€è¶…æ—¶é™åˆ¶ã€å“åº”å¤§å°é™åˆ¶ã€ç¦æ­¢è‡ªåŠ¨é‡å®šå‘
- **file_read**ï¼šè·¯å¾„éå†é˜²æŠ¤ã€å·¥ä½œåŒºè¾¹ç•Œæ£€æŸ¥ã€æ•æ„Ÿæ–‡ä»¶é»‘åå•ï¼ˆ.env, .key, credentialsï¼‰
- **file_write**ï¼šåŒä¸Š + å†™å…¥éœ€æ˜¾å¼ç™½åå•ç›®å½•

#### 4.4 Memory è®¾è®¡ï¼ˆå½“å‰å®ç°ï¼‰

- **å­˜å‚¨å±‚**ï¼š`node:sqlite`ï¼ˆNode 22 å†…ç½®ï¼‰+ FTS5 å…¨æ–‡ç´¢å¼•ã€å…³é”®è¯æ£€ç´¢ï¼ˆBM25ï¼‰ã€å­˜å‚¨ç»Ÿè®¡
- **åˆ†å—å™¨**ï¼š`Chunker` ç±»æ”¯æŒæŒ‰ token ä¼°ç®—åˆ†å—ã€å¯é…ç½® overlap ä¸æœ€å¤§é•¿åº¦
- **ç´¢å¼•å™¨**ï¼š`MemoryIndexer` ç±»æ”¯æŒé€’å½’ç›®å½•ç´¢å¼•ã€å¢é‡æ›´æ–°ï¼ˆåŸºäºæ–‡ä»¶ mtimeï¼‰ã€å¯é…ç½®æ–‡ä»¶æ‰©å±•åè¿‡æ»¤
- **æµ‹è¯•è¯´æ˜**ï¼šç”±äº vitest å¯¹ `node:sqlite` æ”¯æŒä¸å®Œå–„ï¼Œç›¸å…³æµ‹è¯•æš‚æ—¶æ ‡è®°ä¸º skippedï¼Œä½†ä»£ç å·²é€šè¿‡ç‹¬ç«‹è„šæœ¬éªŒè¯å¯ç”¨
- **ä¸‹ä¸€æ­¥**ï¼šä¸ Agent é›†æˆï¼Œå®ç°å¯¹è¯æ—¶è‡ªåŠ¨æ£€ç´¢ç›¸å…³è®°å¿†å¹¶æ³¨å…¥ system prompt

### Phase 4.5ï¼šMemory å‡çº§ï¼ˆå‘é‡æ£€ç´¢ + moltbot å¯¹é½ï¼‰

**ç›®æ ‡**ï¼šå¯¹é½ moltbot çš„åŒå±‚è®°å¿†è®¾è®¡ï¼Œæ”¯æŒå‘é‡æ£€ç´¢ + æ··åˆæœç´¢ã€‚

#### 4.5.1 moltbot Memory è®¾è®¡ï¼ˆå‚è€ƒï¼‰

moltbot ä½¿ç”¨åŒå±‚è®°å¿†ç»“æ„ï¼š

| å±‚çº§ | æ–‡ä»¶ | ç”¨é€” | ç‰¹ç‚¹ |
|------|------|------|------|
| **é•¿æœŸè®°å¿†** | `MEMORY.md` | æ ¸å¿ƒäº‹å®ã€åå¥½ã€å†³ç­– | curated wisdomï¼ˆç²¾é€‰æ™ºæ…§ï¼‰ |
| **æ—¥å¸¸è®°å¿†** | `memory/YYYY-MM-DD.md` | æ¯å¤©çš„å¯¹è¯ç¬”è®°ã€äº‹ä»¶ | raw notesï¼ˆåŸå§‹ç¬”è®°ï¼‰ï¼Œappend-only |

æ ¸å¿ƒæœºåˆ¶ï¼š
- Session å¯åŠ¨æ—¶è¯»å– today + yesterday + MEMORY.md
- å‘é‡æ£€ç´¢ï¼ˆ~400 token åˆ†å—ï¼Œ80 token é‡å ï¼‰
- æ··åˆæœç´¢ï¼ˆBM25 0.3 + Vector 0.7ï¼‰
- Memory Flushï¼šcompaction å‰é™é»˜å†™å…¥è®°å¿†
- Memory Toolsï¼š`memory_search` + `memory_get`

#### 4.5.2 Belldandy å½“å‰å·®è·

| åŠŸèƒ½ | moltbot | Belldandy | çŠ¶æ€ |
|------|---------|-----------|------|
| FTS5 å…³é”®è¯æ£€ç´¢ | âœ… | âœ… | å·²å®ç° |
| åˆ†å—å™¨ | âœ… ~400 token | âœ… 1000 å­—ç¬¦ | å·²å®ç° |
| ç´¢å¼•å™¨ï¼ˆå¢é‡ï¼‰ | âœ… | âœ… | å·²å®ç° |
| `memory_search` å·¥å…· | âœ… | âœ… | å·²å®ç° |
| **MEMORY.md é•¿æœŸè®°å¿†** | âœ… | âœ… | å·²å®ç° |
| **memory/YYYY-MM-DD æ—¥å¸¸** | âœ… | âœ… | å·²å®ç° |
| **`memory_get` å·¥å…·** | âœ… | âœ… | å·²å®ç° |
| **å‘é‡æ£€ç´¢** | âœ… | âœ… | å·²å®ç° |
| **Embedding Provider** | âœ… OpenAI/Gemini/Local | âœ… OpenAI/Local | å·²å®ç° |
| **æ··åˆæ£€ç´¢** | âœ… BM25+Vector | âœ… | å·²å®ç° |
| **sqlite-vec åŠ é€Ÿ** | âœ… | âœ… | å·²å®ç° |
| **Memory Flush** | âœ… | âŒ | ä½ä¼˜å…ˆ |

#### 4.5.3 å‡çº§è·¯çº¿å›¾

| Step | å†…å®¹ | ä¼˜å…ˆçº§ | çŠ¶æ€ |
|------|------|--------|------|
| 1 | å¢åŠ  `MEMORY.md` + `memory/YYYY-MM-DD.md` çº¦å®šï¼Œè‡ªåŠ¨ç´¢å¼• | å¿…é¡» | âœ… å·²å®Œæˆ |
| 2 | æ·»åŠ  `memory_get` å·¥å…·ï¼ˆè¯»å–ç‰¹å®šæ–‡ä»¶å†…å®¹ï¼‰ | å¿…é¡» | âœ… å·²å®Œæˆ |
| 3 | å‘é‡æ£€ç´¢åŸºç¡€æ¶æ„ï¼ˆEmbedding æ¥å£å®šä¹‰ï¼‰ | é«˜ | âœ… å·²å®Œæˆ |
| 4 | OpenAI embedding provider å®ç° | é«˜ | âœ… å·²å®Œæˆ |
| 5 | JS cosine similarity å‘é‡æœç´¢ | ä¸­ | âœ… å·²å®Œæˆ |
| 6 | æ··åˆæ£€ç´¢ï¼ˆBM25 + Vectorï¼ŒRRF èåˆï¼‰ | ä¸­ | âœ… å·²å®Œæˆ |
| 7 | æœ¬åœ° Embedding Providerï¼ˆfastembed + BAAI/bge ç³»åˆ—ï¼‰ | ä½ | âœ… å·²å®Œæˆ |
| 8 | Memory Flush æœºåˆ¶ï¼ˆcompaction å‰å†™å…¥ï¼‰ | ä½ | å¾…å¼€å§‹ |
| 9 | æœ¬åœ°æ¨ç†ï¼ˆnode-llama-cpp ç­‰ï¼‰ | ä½ | å¾…å¼€å§‹ |


#### 4.5.4 éªŒæ”¶ç”¨ä¾‹

- å¯åŠ¨æ—¶è‡ªåŠ¨æ‰«æ `~/.belldandy/MEMORY.md` å’Œ `~/.belldandy/memory/*.md`
- `memory_search` è¿”å›è¯­ä¹‰ç›¸å…³ç‰‡æ®µï¼ˆå³ä½¿å…³é”®è¯ä¸å®Œå…¨åŒ¹é…ï¼‰
- `memory_get` æŒ‰æ–‡ä»¶è·¯å¾„ + è¡Œå·èŒƒå›´è¯»å– memory å†…å®¹
- è¯¢é—®"ä¸Šå‘¨æˆ‘ä»¬è®¨è®ºäº†ä»€ä¹ˆ"èƒ½æ‰¾åˆ°ç›¸å…³æ—¥æœŸæ–‡ä»¶

#### 4.6 æ–°å¢ç¯å¢ƒå˜é‡

| å˜é‡ | è¯´æ˜ |
|------|------|
| `BELLDANDY_TOOLS_ENABLED` | å¯ç”¨å·¥å…·è°ƒç”¨ï¼ˆé»˜è®¤ falseï¼‰ |
| `BELLDANDY_TOOLS_POLICY_FILE` | è‡ªå®šä¹‰ç­–ç•¥æ–‡ä»¶è·¯å¾„ |
| `BELLDANDY_MEMORY_ENABLED` | å¯ç”¨è®°å¿†æ£€ç´¢ï¼ˆé»˜è®¤ falseï¼‰ |
| `BELLDANDY_MEMORY_DIR` | è®°å¿†ç›®å½•ï¼ˆé»˜è®¤ .belldandy/memoryï¼‰ |
| `BELLDANDY_MEMORY_DB` | SQLite è·¯å¾„ï¼ˆé»˜è®¤ ~/.belldandy/memory.dbï¼‰ |
| `BELLDANDY_EMBEDDING_MODEL` | åµŒå…¥æ¨¡å‹åç§°ï¼ˆå¦‚ text-embedding-v1ï¼‰ |
| `BELLDANDY_EMBEDDING_OPENAI_API_KEY` | åµŒå…¥ä¸“ç”¨ API Keyï¼ˆå¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨é€šç”¨ Keyï¼‰ |
| `BELLDANDY_EMBEDDING_OPENAI_BASE_URL` | åµŒå…¥ä¸“ç”¨ Base URLï¼ˆå¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨é€šç”¨ URLï¼‰ |

#### 4.7 éªŒæ”¶ç”¨ä¾‹

- å·¥å…·è°ƒç”¨å¯è¿½è¸ªã€å¯å®¡è®¡ï¼ˆç»“æ„åŒ–æ—¥å¿—ï¼‰
- Memory æ£€ç´¢è¿”å›å¯è§£é‡Šç‰‡æ®µï¼ˆå«æ¥æºè·¯å¾„ã€è¡Œå·ï¼‰
- ç«¯åˆ°ç«¯ï¼šWebChat å‘é€"è¯»å– README.md"è§¦å‘ file_read å·¥å…·
- ç«¯åˆ°ç«¯ï¼šç”¨æˆ·æé—®æ—¶è‡ªåŠ¨æ£€ç´¢ç›¸å…³è®°å¿†å¹¶å¼•ç”¨

### Phase 4.6ï¼šä¼šè¯æŒä¹…åŒ–ä¸å‘é‡è®°å¿† (Persistence & Vector Memory)
- **Status**: âœ… å·²å®Œæˆ (2026-02-08)
- **Goal**: å®ç°ä¼šè¯æ•°æ®çš„æŒä¹…åŒ–å­˜å‚¨ï¼Œå¹¶åˆ©ç”¨å‘é‡ç´¢å¼•å®ç°â€œæ— é™â€çš„è®°å¿† recallã€‚
- **Core Strategy**:
    - **Session Persistence**: `ConversationStore` å‡çº§ä¸ºæ–‡ä»¶æ”¯æŒ (`.jsonl`)ï¼Œé‡å¯ä¸ä¸¢å¤±ã€‚
    - **Feishu Integrated**: å®ç°äº†é£ä¹¦æ¶ˆæ¯çš„åŒå‘æŒä¹…åŒ–ï¼ˆUser + Assistantï¼‰ï¼Œç¡®ä¿è·¨æ¸ é“è®°å¿†ä¸€è‡´æ€§ã€‚
    - **Configurable Embedding**: æ”¯æŒé€šè¿‡ `BELLDANDY_EMBEDDING_MODEL` è‡ªå®šä¹‰æ¨¡å‹ï¼ˆå¦‚ `text-embedding-v1`ï¼‰ã€‚
    - **Session Indexing**: `MemoryIndexer` è‡ªåŠ¨ç›‘å¬ `sessions` ç›®å½•ï¼Œå¢é‡ç”Ÿæˆå‘é‡ç´¢å¼•ã€‚
    - **Vector Bootstrap**: è§£å†³é¦–æ¬¡å¯åŠ¨å‘é‡è¡¨åˆå§‹åŒ–é—®é¢˜ï¼Œå¢å¼ºå·¥ç¨‹å¥å£®æ€§ã€‚
    - **Global MemoryManager**: ç»Ÿä¸€ Gateway ä¸ Skills çš„ MemoryManager å®ä¾‹ï¼Œè®© `memory_search` å·¥å…·èƒ½è®¿é—®ä¼šè¯å‘é‡ç´¢å¼•ã€‚

### Phase 4.7ï¼šè®°å¿†æ£€ç´¢å¢å¼º (Memory Retrieval Enhancement) [Proposed]
- **Goal**: è®© Agent æ›´ä¸»åŠ¨ã€æ›´æ™ºèƒ½åœ°ä½¿ç”¨é•¿æœŸè®°å¿†ï¼Œä»"è¢«åŠ¨å›å¿†"å‡çº§ä¸º"ä¸»åŠ¨å…³è”"ã€‚
- **Core Features**:
    - **æ–¹æ¡ˆ A - Prompt å¼•å¯¼ï¼ˆå·²å®Œæˆï¼‰**:
        - åœ¨ `AGENTS.md` ä¸­æ·»åŠ è®°å¿†æ£€ç´¢ç­–ç•¥è§„åˆ™ï¼Œå¼•å¯¼ Agent åœ¨é‡åˆ°å›å¿†ç±»é—®é¢˜æ—¶ä¸»åŠ¨ä½¿ç”¨ `memory_search`ã€‚
        - çŠ¶æ€ï¼šâœ… å·²å®Œæˆï¼ˆ2026-02-08ï¼‰
    - **æ–¹æ¡ˆ B - Context Injectionï¼ˆè§„åˆ’ä¸­ï¼‰**:
        - æ¯æ¬¡å¯¹è¯å¼€å§‹æ—¶ï¼Œè‡ªåŠ¨ä» sessions ä¸­æå–æœ€è¿‘å¯¹è¯æ‘˜è¦ï¼Œæ³¨å…¥ System Promptã€‚
        - å®ç°ä½ç½®ï¼š`packages/belldandy-agent/src/agent.ts`
        - é¢„æœŸæ•ˆæœï¼šAgent æ— éœ€å·¥å…·è°ƒç”¨å³å¯æ„ŸçŸ¥è¿‘æœŸè¯é¢˜ï¼Œæå‡è¿ç»­æ€§ã€‚
    - **æ–¹æ¡ˆ C - Auto-Recallï¼ˆè§„åˆ’ä¸­ï¼‰**:
        - ä½¿ç”¨ NLP æ£€æµ‹ç”¨æˆ·è¾“å…¥ä¸­çš„"å›å¿†ç±»"å…³é”®è¯ï¼ˆå¦‚"ä¹‹å‰"ã€"ä¸Šæ¬¡"ã€"è¿˜è®°å¾—"ï¼‰ã€‚
        - è‡ªåŠ¨è§¦å‘ `memory_search` å¹¶å°†ç»“æœæ³¨å…¥ä¸Šä¸‹æ–‡ã€‚
        - å®ç°ä½ç½®ï¼š`packages/belldandy-agent/src/agent.ts` æ¶ˆæ¯å¤„ç†æµç¨‹ã€‚
        - é¢„æœŸæ•ˆæœï¼šAgent æ— éœ€ä¸»åŠ¨å†³ç­–ï¼Œç³»ç»Ÿè‡ªåŠ¨ä¸ºå…¶"å›å¿†"ç›¸å…³ä¸Šä¸‹æ–‡ã€‚

### Phase 4.8ï¼šè®°å¿†ç³»ç»Ÿæ·±åº¦ä¼˜åŒ– (Advanced Memory Optimization) [Planned]
- **Goal**: æå‡é•¿æ—¶è®°å¿†çš„æ£€ç´¢è´¨é‡ä¸æ•ˆç‡ï¼Œæ¥è¿‘äººç±»çš„è”æƒ³è®°å¿†èƒ½åŠ›ï¼Œè§£å†³ç¢ç‰‡åŒ–ä¸æŒ‡ä»£ä¸æ¸…é—®é¢˜ã€‚
- **Core Features**:
    - [ ] **Auto-Summarization**: æ¯æ—¥/å®šæœŸç”Ÿæˆ High-Level Summaryï¼Œè§£å†³è®°å¿†ç¢ç‰‡åŒ–é—®é¢˜ã€‚
    - [ ] **Metadata Filtering**: å†™å…¥æ—¶æ³¨å…¥ `channel`/`topic`/`timestamp`ï¼Œæ£€ç´¢æ—¶æ”¯æŒ `WHERE` ç²¾ç¡®è¿‡æ»¤ã€‚
    - [ ] **Query Rewrite**: åˆ©ç”¨ LLM æ”¹å†™ç”¨æˆ·æŸ¥è¯¢ï¼ˆæ¶ˆé™¤æŒ‡ä»£æ­§ä¹‰ï¼‰ï¼Œæå‡æ£€ç´¢ä¸Šä¸‹æ–‡ç›¸å…³æ€§ã€‚
    - [ ] **Rerank Model**: å¼•å…¥ Reranker å¯¹å‘é‡ç»“æœäºŒæ¬¡æ‰“åˆ†ï¼Œæå‡ Top-N å‡†ç¡®ç‡ã€‚



## 3.1 ä¸‹ä¸€æ­¥æ‰§è¡Œé¡ºåºï¼ˆå»ºè®®ï¼‰

1. ~~Phase 4ï¼šè¡¥ skillsï¼ˆå—æ§æ–‡ä»¶/ç½‘ç»œå·¥å…·ï¼‰ä¸ memoryï¼ˆkeyword æ£€ç´¢ï¼‰~~ âœ… å·²å®Œæˆ
2. ~~Phase 5ï¼šSOUL/Persona äººæ ¼ç³»ç»Ÿ~~ âœ… å·²å®Œæˆ
3. ~~Phase 4.5ï¼šMemory å‡çº§ï¼ˆå‘é‡æ£€ç´¢ + moltbot å¯¹é½ï¼‰~~ âœ… å·²å®Œæˆ
4. ~~Phase 4.6ï¼šä¼šè¯æŒä¹…åŒ–ä¸å‘é‡è®°å¿†~~ âœ… å·²å®Œæˆ
5. ~~Phase 2.2ï¼šå¯¹è¯ä¸Šä¸‹æ–‡åˆ†å±‚~~ âœ… å·²å®Œæˆ
5. ~~Phase 3.1ï¼šå®Œå–„ pairing ç®¡ç†å…¥å£~~ âœ… å·²å®Œæˆï¼ˆlist/pending/cleanup/export/import å·²è½åœ°ï¼‰
6. ~~**Phase 6**ï¼šé£ä¹¦ (Feishu) æ¸ é“ï¼ˆæ— éœ€å†…ç½‘ç©¿é€ï¼‰~~ âœ… å·²å®Œæˆ
7. ~~**Phase 7**ï¼šHeartbeat å®šæ—¶ä»»åŠ¡~~ âœ… å·²å®Œæˆï¼ˆå¿ƒè·³ Runner + Gateway é›†æˆï¼‰
8. ~~**Phase 17**ï¼šMCP (Model Context Protocol) æ”¯æŒ~~ âœ… å·²å®Œæˆï¼ˆ@belldandy/mcp åŒ… + Gateway é›†æˆï¼‰

### Phase 6ï¼šé£ä¹¦ (Feishu) æ¸ é“ï¼ˆå·²å®Œæˆï¼‰

**ç›®æ ‡**ï¼šæ”¯æŒé€šè¿‡é£ä¹¦ä¸ Belldandy å¯¹è¯ï¼Œæ— éœ€å…¬ç½‘ IP æˆ–å†…ç½‘ç©¿é€ã€‚

**å®ç°å†…å®¹**ï¼š

| Step | å†…å®¹ | çŠ¶æ€ |
|------|------|------|
| 1 | `@belldandy/channels` åŒ…ç»“æ„ | âœ… å·²å®Œæˆ |
| 2 | FeishuChannel å®ç°ï¼ˆ@larksuiteoapi/node-sdkï¼‰ | âœ… å·²å®Œæˆ |
| 3 | WebSocket é•¿è¿æ¥æ¨¡å¼ | âœ… å·²å®Œæˆ |
| 4 | Gateway é›†æˆï¼ˆç¯å¢ƒå˜é‡é…ç½®ï¼‰ | âœ… å·²å®Œæˆ |
| 5 | æ¶ˆæ¯å»é‡æœºåˆ¶ï¼ˆé˜²æ­¢äº‹ä»¶é‡è¯•å¯¼è‡´é‡å¤å›å¤ï¼‰ | âœ… å·²å®Œæˆ |
| 6 | Kimi K2.5 å·¥å…·è°ƒç”¨å…¼å®¹ï¼ˆç¦ç”¨ thinking æ¨¡å¼ï¼‰ | âœ… å·²å®Œæˆ |

**å…³é”®æ–‡ä»¶**ï¼š

```
packages/
â”œâ”€â”€ belldandy-channels/
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ tsconfig.json
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ index.ts          # å¯¼å‡º
â”‚       â””â”€â”€ feishu.ts         # FeishuChannel å®ç°
â””â”€â”€ belldandy-agent/src/
    â””â”€â”€ tool-agent.ts         # Kimi å…¼å®¹æ€§ä¿®å¤
```

**æ–°å¢ç¯å¢ƒå˜é‡**ï¼š

| å˜é‡ | è¯´æ˜ |
|------|------|
| `BELLDANDY_FEISHU_APP_ID` | é£ä¹¦åº”ç”¨ App ID |
| `BELLDANDY_FEISHU_APP_SECRET` | é£ä¹¦åº”ç”¨ App Secret |

**éªŒæ”¶ç”¨ä¾‹**ï¼š
- Gateway å¯åŠ¨æ—¶è‡ªåŠ¨è¿æ¥é£ä¹¦ WebSocket
- åœ¨é£ä¹¦å‘é€æ¶ˆæ¯ï¼ŒBelldandy æ­£ç¡®å›å¤
- å·¥å…·è°ƒç”¨ï¼ˆfile_read/file_writeï¼‰æ­£å¸¸å·¥ä½œ
- é‡å¤æ¶ˆæ¯ä¸ä¼šè§¦å‘é‡å¤å›å¤

### Phase 7ï¼šHeartbeat å®šæ—¶ä»»åŠ¡ï¼ˆå·²å®Œæˆï¼‰

**ç›®æ ‡**ï¼šè®© Agent èƒ½å¤Ÿå®šæœŸ"é†’æ¥"æ£€æŸ¥ä»»åŠ¡å¹¶ä¸»åŠ¨è”ç³»ç”¨æˆ·ã€‚

**å®ç°å†…å®¹**ï¼š

| Step | å†…å®¹ | çŠ¶æ€ |
|------|------|------|
| 1 | Heartbeat Runner æ ¸å¿ƒï¼ˆå®šæ—¶è§¦å‘ï¼‰ | âœ… å·²å®Œæˆ |
| 2 | HEARTBEAT.md å†…å®¹è§£æï¼ˆç©º/æ³¨é‡Šè·³è¿‡ï¼‰ | âœ… å·²å®Œæˆ |
| 3 | æ´»è·ƒæ—¶æ®µæ”¯æŒï¼ˆæ·±å¤œä¸æ‰“æ‰°ï¼‰ | âœ… å·²å®Œæˆ |
| 4 | Agent é›†æˆï¼ˆsendMessageï¼‰ | âœ… å·²å®Œæˆ |
| 5 | å“åº”æ£€æµ‹ï¼ˆHEARTBEAT_OK é™é»˜ï¼Œå¦åˆ™æ¨é€ï¼‰ | âœ… å·²å®Œæˆ |
| 6 | Gateway é›†æˆï¼ˆé…ç½® + å¯åŠ¨ï¼‰ | âœ… å·²å®Œæˆ |

**å…³é”®æ–‡ä»¶**ï¼š

```
packages/
â””â”€â”€ belldandy-core/src/
    â”œâ”€â”€ heartbeat/
    â”‚   â”œâ”€â”€ index.ts      # æ¨¡å—å¯¼å‡º
    â”‚   â”œâ”€â”€ runner.ts     # å¿ƒè·³ Runner
    â”‚   â””â”€â”€ content.ts    # å†…å®¹è§£æ
    â””â”€â”€ bin/gateway.ts    # é›†æˆå…¥å£
```

**æ–°å¢ç¯å¢ƒå˜é‡**ï¼š

| å˜é‡ | è¯´æ˜ |
|------|------|
| `BELLDANDY_HEARTBEAT_ENABLED` | å¯ç”¨å¿ƒè·³ï¼ˆé»˜è®¤ falseï¼‰ |
| `BELLDANDY_HEARTBEAT_INTERVAL` | é—´éš”ï¼ˆå¦‚ 30m, 1h, 300sï¼‰ |
| `BELLDANDY_HEARTBEAT_ACTIVE_HOURS` | æ´»è·ƒæ—¶æ®µï¼ˆå¦‚ 08:00-23:00ï¼‰ |

**éªŒæ”¶ç”¨ä¾‹**ï¼š
- è®¾ç½® `HEARTBEAT_INTERVAL=1m` åï¼Œæ¯åˆ†é’Ÿæ—¥å¿—è¾“å‡º `[heartbeat] running...`
- HEARTBEAT.md ä¸ºç©ºæ—¶è·³è¿‡ï¼Œä¸è§¦å‘ Agent
- Agent å›å¤ HEARTBEAT_OK æ—¶é™é»˜ï¼Œä¸æ‰“æ‰°ç”¨æˆ·
- Agent å›å¤å…¶ä»–å†…å®¹æ—¶æ¨é€åˆ°ç”¨æˆ·ï¼ˆé¢„ç•™æ¥å£ï¼‰

### Phase 5ï¼šSOUL/Persona äººæ ¼ç³»ç»Ÿï¼ˆå·²å®Œæˆï¼‰

**ç›®æ ‡**ï¼šè®©åŠ©æ‰‹å…·æœ‰å¯é…ç½®çš„äººæ ¼ç‰¹å¾ã€è¡Œä¸ºå‡†åˆ™ä¸è¿ç»­æ€§è®°å¿†ã€‚

**å‚è€ƒè®¾è®¡ï¼ˆmoltbotï¼‰**ï¼š

moltbot é€šè¿‡ Workspace å¼•å¯¼æ–‡ä»¶ä½“ç³»å®ç° Agent äººæ ¼åŒ–ï¼š

| æ–‡ä»¶ | ç”¨é€” |
|------|------|
| `SOUL.md` | æ ¸å¿ƒäººæ ¼å®šä¹‰ï¼šè¡Œä¸ºå‡†åˆ™ã€è¾¹ç•Œã€è¯­è°ƒé£æ ¼ |
| `IDENTITY.md` | èº«ä»½ä¿¡æ¯ï¼šåå­—ã€ç§°å‘¼ã€emojiã€å¤´åƒ |
| `USER.md` | ç”¨æˆ·æ¡£æ¡ˆï¼šç”¨æˆ·åå¥½ã€æ—¶åŒºã€ä¸Šä¸‹æ–‡ |
| `BOOTSTRAP.md` | é¦–æ¬¡å¼•å¯¼ä»ªå¼ï¼ˆå®Œæˆååˆ é™¤ï¼‰ |
| `HEARTBEAT.md` | å¿ƒè·³/å®šæ—¶ä»»åŠ¡é…ç½® |
| `AGENTS.md` | å·¥ä½œç©ºé—´æŒ‡å—ï¼šAgent çš„æ“ä½œæ‰‹å†Œä¸ç¯å¢ƒæŒ‡å¼• |
| `TOOLS.md` | å·¥å…·ä½¿ç”¨æŒ‡å¼• |

**æ ¸å¿ƒæœºåˆ¶**ï¼š
- å¯åŠ¨æ—¶åŠ è½½ Workspace æ–‡ä»¶å¹¶æ³¨å…¥ system prompt
- è‹¥å­˜åœ¨ `SOUL.md`ï¼ŒAgent ä¼šä½“ç°å…¶äººæ ¼ç‰¹å¾
- ç”¨æˆ·å¯é€šè¿‡å¯¹è¯å¼•å¯¼ Agent æ›´æ–°èº«ä»½ä¿¡æ¯
- æ”¯æŒ"SOUL_EVIL"å½©è›‹ï¼ˆå¯é€‰ï¼‰

**Belldandy å®ç°è®¡åˆ’**ï¼š

| Step | å†…å®¹ | çŠ¶æ€ |
|------|------|------|
| 1 | Workspace æ–‡ä»¶åŠ è½½å™¨ï¼ˆè¯»å– `~/.belldandy/*.md`ï¼‰ | âœ… å·²å®Œæˆ |
| 2 | é»˜è®¤æ¨¡æ¿ï¼ˆSOUL.md / IDENTITY.md / USER.md / BOOTSTRAP.mdï¼‰ | âœ… å·²å®Œæˆ |
| 3 | System Prompt æ„å»ºå™¨ï¼ˆå°† Workspace å†…å®¹æ³¨å…¥æç¤ºè¯ï¼‰ | âœ… å·²å®Œæˆ |
| 4 | Bootstrap å¼•å¯¼æµç¨‹ï¼ˆé¦–æ¬¡ä½¿ç”¨çš„èº«ä»½ç¡®è®¤ä»ªå¼ï¼‰ | âœ… å·²å®Œæˆ |
| 5 | Agent é›†æˆï¼ˆGateway ä½¿ç”¨åŠ¨æ€ system promptï¼‰ | âœ… å·²å®Œæˆ |

**éªŒæ”¶ç”¨ä¾‹**ï¼š
- ä¿®æ”¹ `SOUL.md` åé‡å¯ï¼ŒAgent è¯­è°ƒ/é£æ ¼å‘ç”Ÿå˜åŒ–
- é¦–æ¬¡ä½¿ç”¨æ—¶è§¦å‘ Bootstrap å¼•å¯¼ï¼Œå®Œæˆåè‡ªåŠ¨æ›´æ–° `IDENTITY.md` å’Œ `USER.md`
- è¯¢é—®"ä½ æ˜¯è°"æ—¶ï¼ŒAgent èƒ½å›ç­”å…¶èº«ä»½ä¿¡æ¯

### 3.2 åŸºäº OpenClaw å¯¹æ ‡çš„ Roadmap æ’æœŸï¼ˆæ–°å¢ï¼‰

> ä¾æ® `openclawVSBelldandyå®ç°å¯¹æ¯”è¯´æ˜.md` ä¸­æ‰€æœ‰ **âš ï¸/âŒ** èƒ½åŠ›é¡¹ï¼Œå¯¹åç»­å¼€å‘è¿›è¡Œä¼˜å…ˆçº§åˆ†ç»„ä¸é˜¶æ®µè§„åˆ’ã€‚æœ¬èŠ‚ä½œä¸ºã€Œå®æ–½è®¡åˆ’ã€çš„æ±‡æ€»è§†å›¾ï¼Œç”¨äº Roadmap æ’æœŸä¸æ’é˜Ÿã€‚

#### 3.2.1 è¿‘æœŸï¼ˆä¼˜å…ˆçº§ P1ï¼Œå½“å‰/ä¸‹ä¸€ä¸ªå¤§ç‰ˆæœ¬å†…å®Œæˆï¼‰

| ç¼–å· | ä¸»é¢˜ | å¯¹åº”å¯¹æ¯”ç« èŠ‚ | ä¸»è¦ç›®æ ‡ | å¤‡æ³¨ |
|------|------|--------------|----------|------|
| P1-1 | å®‰å…¨åŠ å›ºï¼ˆworkspace / config / browserï¼‰ | Â§10 å®‰å…¨ã€é˜²æŠ¤ | è½å®å®‰å…¨è·¯çº¿å›¾ä¸­çš„ P0/P1/P2 é¡¹ï¼šå°† `workspace.read/list` çº³å…¥ secureMethods å¹¶å±è”½ `allowlist.json/mcp.json` ç­‰æ•æ„Ÿæ–‡ä»¶ï¼›è°ƒæ•´é»˜è®¤ `AUTH_MODE`ï¼ˆé¿å… `none`ï¼‰ï¼›å¯¹ `config.read/update` åšè„±æ•å’Œå­—æ®µç™½åå•ï¼›ä¸º `web_fetch` å’Œæµè§ˆå™¨å·¥å…·å¢åŠ æ›´ä¸¥å¯†çš„ SSRF/åŸŸåç­–ç•¥ã€‚ | âœ… **å·²å®Œæˆ (Phase 19)** <br> workspace æƒé™ã€é…ç½®è„±æ•ã€SSRF é˜²æŠ¤ã€æµè§ˆå™¨åŸŸåæ§åˆ¶å‡å·²è½åœ°ã€‚ |
| P1-2 | CLI å‘½ä»¤æ ‘ä¸ Onboarding Wizard | Â§1 æ ¸å¿ƒå¹³å° | åœ¨ç°æœ‰ `pnpm dev:gateway` å’Œ pairing/skills å‘½ä»¤åŸºç¡€ä¸Šï¼Œè®¾è®¡å¹¶å®ç°ç»Ÿä¸€çš„ `belldandy` CLI å…¥å£ï¼ˆæˆ– `belldandy gateway/agent/send/config/doctor` å­å‘½ä»¤ï¼‰ï¼Œå¹¶æ–°å¢äº¤äº’å¼ Onboarding Wizardï¼ˆå¯¹æ ‡ `openclaw onboard`ï¼‰ï¼Œè¦†ç›– gatewayã€workspaceã€channelsã€skills çš„å¼•å¯¼é…ç½®ã€‚ | Wizard UI å¯å…ˆèµ° CLI æ–‡æœ¬æ¨¡å¼ï¼Œåç»­å†è€ƒè™‘ Web å‘å¯¼ï¼›éœ€ä¸ç°æœ‰ Settings/Doctor é¢æ¿é…åˆã€‚ |
| P1-3 | æ¸ é“æ‰©å±•ï¼ˆä¸€çº¿ IM æœ€å°æ”¯æ’‘ï¼‰ | Â§3 Channels | åœ¨ `belldandy-channels` ç°æœ‰æ¥å£åŸºç¡€ä¸Šï¼Œæ–°å¢è‡³å°‘ 1â€“2 ä¸ªéé£ä¹¦æ¸ é“ï¼ˆå»ºè®® Telegram + Slack æˆ– Discordï¼‰ï¼Œå½¢æˆâ€œå¤šæ¸ é“æ”¶ä»¶ç®±â€çš„æœ€å°é—­ç¯ï¼Œå¯¹é½ OpenClaw çš„å¤šæ¸ é“èƒ½åŠ›ã€‚ | ä¼˜å…ˆé€‰æŠ€æœ¯é—¨æ§›ä½ã€å®˜æ–¹ SDK æˆç†Ÿçš„æ¸ é“ï¼›å¯å…ˆå®ç°åªæ”¶æ¶ˆæ¯ + å›å¤çš„ MVPï¼Œåç»­å†è¡¥ç¾¤è·¯ç”±ç»†èŠ‚ã€‚ |
| P1-4 | å®šæ—¶ä»»åŠ¡ / Cron å·¥å…·ï¼ˆè½¯ç¡¬ç»“åˆï¼‰ | Â§8 å®šæ—¶ä»»åŠ¡ | åœ¨ Heartbeat Runner ä¹‹ä¸Šï¼ŒæŠ½è±¡å‡ºé€šç”¨ Cron å·¥å…·ä¸é…ç½®ï¼ˆä¾‹å¦‚ `cron.list` / `cron.set`ï¼‰ï¼Œå¯¹æ¥ Gateway é…ç½®ï¼Œè®©éå¿ƒè·³ç±»ä»»åŠ¡ä¹Ÿèƒ½æŒ‰è®¡åˆ’è§¦å‘ï¼ˆå¯¹æ ‡ OpenClaw çš„ cron jobsï¼‰ã€‚ | âœ… **æ–¹æ¡ˆ A (è½»é‡ MVP) å·²å®Œæˆ (2026-02-10)** <br> å®ç°äº† `at`ï¼ˆä¸€æ¬¡æ€§ï¼‰+ `every`ï¼ˆå‘¨æœŸï¼‰ä¸¤ç§è°ƒåº¦ï¼Œ`systemEvent` Payloadï¼ŒJSON æ–‡ä»¶æŒä¹…åŒ–ï¼ˆ`cron-jobs.json`ï¼‰ï¼ŒAgent `cron` å·¥å…·ï¼ˆ`list/add/remove/status`ï¼‰ï¼ŒGateway `BELLDANDY_CRON_ENABLED` å¼€å…³ã€‚ <br><br> **æ–¹æ¡ˆ B å‡çº§è·¯å¾„ï¼ˆæœªæ¥æŒ‰éœ€ï¼‰ï¼š** <br> â‘  å¼•å…¥ `croner` åº“æ”¯æŒ cron è¡¨è¾¾å¼ï¼ˆå¦‚ `0 9 * * 1`ï¼‰ <br> â‘¡ `main`/`isolated` ä¼šè¯éš”ç¦»ï¼ˆé¿å…å®šæ—¶ä»»åŠ¡æ±¡æŸ“ä¸»ä¼šè¯ï¼‰ <br> â‘¢ `agentTurn` Payload æ”¯æŒç‹¬ç«‹ Agent å¯¹è¯ + æ¨¡å‹/thinking è¦†ç›– <br> â‘£ `announce`/`none` + æ¸ é“å®šå‘æ¨é€ï¼ˆå¦‚æ¨é€åˆ°é£ä¹¦/Telegramï¼‰ <br> â‘¤ `cron.*` Gateway åè®®æ–¹æ³•ï¼ˆå‰ç«¯ UI ç®¡ç†ï¼‰ <br> â‘¥ `run`/`runs` actionï¼ˆæ‰‹åŠ¨è§¦å‘ + æ‰§è¡Œå†å²æŸ¥è¯¢ï¼‰ |
| P1-5 | ä¼šè¯æ¨¡å‹æ¢³ç†ä¸å¤š Agent é¢„å¤‡ | Â§2 ä¼šè¯æ¨¡å‹ | åœ¨ä¿æŒå½“å‰å•ä¸» Agent çš„å‰æä¸‹ï¼Œæ¢³ç† `ConversationStore` ä¸ workspace ç»“æ„ï¼Œä¸ºæœªæ¥å¤š Agent è·¯ç”±é¢„ç•™é…ç½®ä½ï¼ˆå¦‚ `agent.main`ã€`agent.work` ç­‰ï¼‰ï¼Œå¹¶åœ¨ System Prompt ä¸­æ˜ç¡®ä¸»/å­ä¼šè¯è§’è‰²ã€‚ | ä¸å¿…ä¸€æ¬¡æ€§å®ç°å®Œæ•´ multi-agent routingï¼Œä½†è¦é¿å…æœªæ¥æ‰©å±•æ—¶ç ´åç°æœ‰ APIã€‚ |

#### 3.2.2 ä¸­æœŸï¼ˆä¼˜å…ˆçº§ P2ï¼Œ1â€“2 ä¸ªå¤§ç‰ˆæœ¬å†…æ»šåŠ¨æ¨è¿›ï¼‰

| ç¼–å· | ä¸»é¢˜ | å¯¹åº”å¯¹æ¯”ç« èŠ‚ | ä¸»è¦ç›®æ ‡ | å¤‡æ³¨ |
|------|------|--------------|----------|------|
| P2-1 | Multi-Agent è·¯ç”±ä¸ Session ç¼–æ’ | Â§2 ä¼šè¯æ¨¡å‹ | å¼•å…¥å¤š Agent / å¤š workspace é…ç½®ï¼ˆä¾‹å¦‚æŒ‰ channel/account/peer è·¯ç”±ä¸åŒ personaï¼‰ï¼Œå¹¶å®ç° `sessions_list`ã€`sessions_history`ã€`sessions_send` ç­‰ Session å·¥å…·ï¼Œå¯¹é½ OpenClaw çš„ Agent-to-Agent åä½œèƒ½åŠ›ã€‚ | éœ€è¦ä¸ Methods/Memory/Logs ååŒè®¾è®¡ï¼Œé¿å…ä¸åŒ Agent é—´è®°å¿†å’Œæ–¹æ³•æ±¡æŸ“ã€‚ |
| P2-2 | Channels è·¯ç”±å¼•æ“å‡çº§ | Â§3 Channels | åœ¨ç°æœ‰ Channel æ¥å£ä¸Šå®ç° mention gatingã€allowlist/allowFromã€ç¾¤èŠè·¯ç”±è§„åˆ™ç­‰ï¼Œæ”¯æŒæŒ‰ç¾¤/ä¼šè¯ç²¾ç¡®æ§åˆ¶å“ªäº›æ¶ˆæ¯ä¼šè§¦å‘ Agentï¼ˆå¯¹é½ OpenClaw çš„ group routingï¼‰ã€‚ | äººæ ¼æ–‡æ¡£ï¼ˆAGENTS.mdï¼‰ä¸­å·²æœ‰è¡Œä¸ºå‡†åˆ™ï¼Œå¯ä½œä¸ºè§„åˆ™é»˜è®¤å€¼ï¼›å®ç°æ—¶æ³¨æ„ä¸å®‰å…¨ç­–ç•¥ç»Ÿä¸€ã€‚ |
| P2-3 | Skills ç”Ÿæ€ä¸ã€ŒæŠ€èƒ½æ³¨å†Œä¸­å¿ƒã€ | Â§5 å·¥å…· / Skills | åœ¨æœ¬åœ° skills åŸºç¡€ä¸Šï¼Œè®¾è®¡ ClawHub å¼æŠ€èƒ½ registryï¼šæ”¯æŒåˆ—å‡º/æœç´¢/å®‰è£…/å¯ç”¨æŠ€èƒ½ï¼ˆæœ¬åœ° + MCP serverï¼‰ï¼Œå¹¶åœ¨ UI æˆ– CLI ä¸­æä¾›å¯è§†åŒ–ç®¡ç†ã€‚ | MCP å·²ç»å…·å¤‡ï¼Œå¯ä¼˜å…ˆåšâ€œæœ¬åœ° catalogue + MCP skill æ˜ å°„â€ï¼Œè¿œç¨‹å…¬å…± registry å¯ä»¥åç½®ã€‚ |
| P2-4 | Canvas / å¯è§†åŒ–å·¥ä½œåŒºï¼ˆåŸºç¡€ç‰ˆï¼‰ | Â§7 æµè§ˆå™¨/Canvas | è®¾è®¡å¹¶å®ç°ä¸€ä¸ªåŸºç¡€ Canvas / Board åŠŸèƒ½ï¼ˆå¯ä»¥åµŒåœ¨ WebChat æˆ–ç‹¬ç«‹é¡µé¢ï¼‰ï¼Œæ”¯æŒç®€å•çš„å¡ç‰‡/è¿çº¿/æ ‡æ³¨ï¼Œå¯¹æ ‡ OpenClaw çš„ A2UI æ–¹å‘ã€‚ | åˆæœŸå¯ä»¥åªåšâ€œé™æ€ç”»å¸ƒ + å¿«ç…§â€ï¼Œåç»­å†è€ƒè™‘ A2UI å¼ä»£ç é©±åŠ¨ç•Œé¢ã€‚ |
| P2-5 | Webhooks ä¸å¤–éƒ¨è§¦å‘ | Â§8 å®šæ—¶ä»»åŠ¡ | åœ¨é€šç”¨ Cron å®Œæˆåï¼Œè¡¥å…… Webhook å…¥å£ï¼ˆå¦‚ `POST /api/webhook/:id`ï¼‰å’Œæœ€å° Gmail/é€šçŸ¥è§¦å‘æœºåˆ¶ï¼Œä½¿ Belldandy èƒ½åƒ OpenClaw ä¸€æ ·å“åº”å¤–éƒ¨äº‹ä»¶ã€‚ | æ³¨æ„ä¸å®‰å…¨/é‰´æƒé›†æˆï¼Œé¿å… Webhook æˆä¸ºç»•è¿‡ Pairing çš„å…¥å£ã€‚ |
| P2-6 | Nodes é£æ ¼çš„ Memory/Knowledge Graph | Â§6 è®°å¿† | åœ¨ç°æœ‰ Memoryï¼ˆFTS5 + å‘é‡ï¼‰ä¹‹ä¸Šå¢åŠ  `nodes` é£æ ¼çš„çŸ¥è¯†å›¾è°±å·¥å…·ï¼ˆå¦‚ `nodes.create/link/query`ï¼‰ï¼Œä»¥æ”¯æŒæ›´å¤æ‚çš„é•¿æœŸç»“æ„åŒ–çŸ¥è¯†ï¼Œå¯¹é½ OpenClaw çš„ nodes æ¦‚å¿µã€‚ | ä¸æ–¹æ³•è®ºç³»ç»Ÿç»“åˆè‰¯å¥½ï¼Œå¯ç”¨äºæ²‰æ·€â€œæ¦‚å¿µ/å®ä½“/å…³ç³»çº§â€çŸ¥è¯†ã€‚ |

#### 3.2.3 è¿œæœŸï¼ˆä¼˜å…ˆçº§ P3ï¼Œå¯æŒ‰èµ„æºä¸ç”¨æˆ·éœ€æ±‚æ‹©æœºæ¨è¿›ï¼‰

| ç¼–å· | ä¸»é¢˜ | å¯¹åº”å¯¹æ¯”ç« èŠ‚ | ä¸»è¦ç›®æ ‡ | å¤‡æ³¨ |
|------|------|--------------|----------|------|
| P3-1 | Apps & Nodesï¼ˆmacOS/iOS/Android åŸç”Ÿåº”ç”¨ï¼‰ | Â§4 Apps & Nodes | è®¾è®¡ Belldandy è‡ªæœ‰çš„ macOS èœå•æ  app åŠ iOS/Android èŠ‚ç‚¹ï¼Œæš´éœ² `system.run`ã€é€šçŸ¥ã€æ‘„åƒå¤´ã€å±å¹•å½•åˆ¶ç­‰æœ¬åœ°èƒ½åŠ›ï¼Œä¸ Gateway é€šè¿‡ node åè®®äº¤äº’ã€‚ | å·¥ç¨‹é‡è¾ƒå¤§ï¼Œéœ€åœ¨æ ¸å¿ƒä½“éªŒç¨³å®šåå†å¯åŠ¨ï¼›å¯ä»¥ä¼˜å…ˆåˆ©ç”¨ç°æœ‰æµè§ˆå™¨/æ¡Œé¢ç¯å¢ƒæ›¿ä»£ã€‚ |
| P3-2 | è¿œç¨‹ Gateway ä¸éƒ¨ç½²å·¥å…·é“¾ | Â§1 / Â§11 å¹³å°ä¸è¿ç»´ | å¯¹æ ‡ OpenClaw çš„ remote gateway + Tailscale + Docker/Nix æ”¯æŒï¼Œä¸º Belldandy è®¾è®¡è¿œç¨‹éƒ¨ç½²ä¸è®¿é—®æ–¹æ¡ˆï¼ˆä¾‹å¦‚ Docker é•œåƒã€Cloud å®ä¾‹ã€Tailscale Serve/Funnel é›†æˆï¼‰ã€‚ | é€‚åˆæœ‰å¤šè®¾å¤‡/è¿œç¨‹æœåŠ¡å™¨éœ€æ±‚çš„é«˜çº§ç”¨æˆ·ï¼›éœ€ä¸å®‰å…¨ç« èŠ‚ï¼ˆè®¤è¯/æš´éœ²é¢ï¼‰è”åŠ¨ã€‚ |
| P3-3 | é«˜é˜¶ Canvas & å¤šèŠ‚ç‚¹è§†è§‰ | Â§7 æµè§ˆå™¨/Canvas | åœ¨åŸºç¡€ Canvas ä¸Šæ‰©å±•å¤šèŠ‚ç‚¹ï¼ˆæ¡Œé¢/ç§»åŠ¨ï¼‰ååŒè§†å›¾ï¼Œä»¥åŠæ›´ä¸°å¯Œçš„è§†è§‰èƒ½åŠ›ï¼ˆå¤šç›¸æœºã€å±å¹•æµã€å®æ—¶æ ‡æ³¨ï¼‰ï¼Œæ¥è¿‘ OpenClaw çš„ A2UI + nodes ç»„åˆä½“éªŒã€‚ | å¼ºä¾èµ– Apps & Nodes çš„è½åœ°ï¼Œå¯ä¸ Voice/TTS/æ–¹æ³•è®ºç»“åˆåšæ›´å¤æ‚çš„ã€Œä»ªè¡¨ç›˜ã€åœºæ™¯ã€‚ |
| P3-4 | IDE åè®®æ¡¥æ¥ï¼ˆACP æˆ–ç­‰ä»·ï¼‰ | Â§9 MCP/ACP | è¯„ä¼°æ˜¯å¦éœ€è¦åœ¨ MCP ä¹‹å¤–å¢åŠ  ACP/OpenClaw é£æ ¼çš„ IDE åè®®æ¡¥æ¥ï¼ˆå¦‚ `belldandy acp`ï¼‰ï¼Œè®©å¤–éƒ¨ IDE èƒ½é€šè¿‡ç»Ÿä¸€åè®®é©±åŠ¨ Gatewayã€‚ | å½“å‰ MCP å·²å¯è¦†ç›–å¤šæ•°ã€Œå·¥å…·æ¥å…¥ã€åœºæ™¯ï¼Œæ­¤é¡¹ä¼˜å…ˆçº§å¯ä»¥ä¿æŒè¾ƒä½ã€‚ |

ä»¥ä¸Šåˆ†ç»„å¹¶ä¸è¦æ±‚ä¸€æ¬¡æ€§å®ŒæˆæŸä¸€å±‚çº§ä¸‹çš„å…¨éƒ¨æ¡ç›®ï¼Œå¯ä»¥æŒ‰ã€ŒP1 å…¨è¦†ç›– â†’ P2/P3 æŒ‰éœ€åˆ‡å—ã€çš„æ–¹å¼æ»šåŠ¨æ¨è¿›ï¼›åç»­è‹¥å¯¹æ¯”æ–‡æ¡£æ›´æ–°ï¼Œåªéœ€åœ¨æœ¬å°èŠ‚è¿½åŠ /è°ƒæ•´å¯¹åº”æ¡ç›®å³å¯ã€‚

## 4. é£é™©ç‚¹ä¸åº”å¯¹

- **Prompt Injection**ï¼šå…¥ç«™å†…å®¹ä¸å¯ä¿¡ï¼›agent ç³»ç»Ÿæç¤ºå¿…é¡»æ¸…æ™°åˆ†å±‚ï¼›å·¥å…·è°ƒç”¨éœ€è¦äºŒæ¬¡çº¦æŸï¼ˆå‚æ•°æ ¡éªŒã€allowlistï¼‰ã€‚
- **å·¥å…·æ»¥ç”¨é£é™©**ï¼šç¦æ­¢ä»»æ„å‘½ä»¤æ‰§è¡Œï¼›æ–‡ä»¶/ç½‘ç»œå·¥å…·æœ€å°æƒé™ï¼›æ•æ„Ÿä¿¡æ¯è„±æ•ã€‚
- **é…ç½®å¤æ‚åº¦**ï¼šschema æ ¡éªŒä¸é»˜è®¤å€¼è¦æ—©åšï¼›é”™è¯¯ä¿¡æ¯å¯è¡ŒåŠ¨ã€‚
- **å¯æµ‹è¯•æ€§ä¸è¶³**ï¼šPhase 2 èµ·å°±è¦æœ‰æœ€å°é›†æˆæµ‹è¯•ï¼Œé¿å…åæœŸå›å½’æˆæœ¬çˆ†ç‚¸ã€‚
- **æ•æ„Ÿä¿¡æ¯æ³„éœ²**ï¼šæ—¥å¿—ä¸ UI ä¸å›æ˜¾ token/key/å¯†ç ï¼›å¿…è¦æ—¶åšå¯é…ç½®è„±æ•è§„åˆ™ã€‚
- **é”™è¯¯å¤„ç†ä¸ä¸€è‡´**ï¼šå®šä¹‰ç»Ÿä¸€é”™è¯¯åˆ†çº§ï¼ˆP0-P3ï¼‰ä¸å¯¹ç”¨æˆ·å¯è¯»çš„æç¤ºæ ¼å¼ï¼Œé¿å…â€œå¤±è´¥é™é»˜â€æˆ–å †æ ˆç›´å‡ºã€‚

### 4.1 å®‰å…¨åŠ å›ºè·¯çº¿å›¾ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰

> æœ¬å°èŠ‚åŸºäºå½“å‰å®ç°çš„å®‰å…¨è¯„ä¼°ç»“æœï¼ŒæŒ‰ä¼˜å…ˆçº§åˆ—å‡ºéœ€è¦åœ¨åç»­ Phase ä¸­è½å®çš„æœ€å°æ”¹åŠ¨æ–¹æ¡ˆï¼Œæ–¹ä¾¿åç»­æ’æœŸä¸å®æ–½ã€‚

1. **P0ï¼šé…å¯¹ç»•è¿‡é£é™©ï¼ˆworkspace.read æš´éœ² allowlist/mcp é…ç½®ï¼‰**
   - **é—®é¢˜æè¿°**ï¼š
     - å½“å‰ `workspace.read` / `workspace.list` **æœªçº³å…¥ secureMethods æ£€æŸ¥**ï¼Œæœªé…å¯¹å®¢æˆ·ç«¯ä¹Ÿå¯è¯»å– `stateDir` ä¸‹çš„ `.json` æ–‡ä»¶ã€‚
     - ç”±äº `allowlist.json`ï¼ˆå·²æˆæƒ clientId åˆ—è¡¨ï¼‰ä¸ `mcp.json`ï¼ˆMCP é…ç½®ï¼‰éƒ½ä½äº `stateDir` ä¸”æ‰©å±•åä¸º `.json`ï¼Œå­˜åœ¨è¢«æœªæˆæƒå®¢æˆ·ç«¯è¯»å–çš„é£é™©ï¼Œä»è€Œé€šè¿‡ä¼ªé€  `clientId` ç»•è¿‡ Pairing æœºåˆ¶ã€‚
   - **æœ€å°æ”¹åŠ¨æ–¹æ¡ˆ**ï¼š
     - **4.1.1** åœ¨ `packages/belldandy-core/src/server.ts` ä¸­ï¼š
       - å°† `"workspace.read"`ã€`"workspace.list"` åŠ å…¥ `secureMethods` åˆ—è¡¨ï¼Œä½¿å…¶ä¸ `message.send/config.read/config.update/system.restart/workspace.write` ä¸€æ ·å— `isClientAllowed` ä¿æŠ¤ã€‚
       - æˆ–è€…ï¼šä»…å¯¹ `.json` è¯»å–åš allowlist æ ¡éªŒï¼Œä¿ç•™å¯¹ Markdown/æ–‡æœ¬çš„å¼€æ”¾è¯»å–èƒ½åŠ›ï¼ˆéœ€åœ¨æ–‡æ¡£ä¸­è¯´æ˜å·®å¼‚ï¼‰ã€‚
     - **4.1.2** åœ¨ `handleReq` çš„ `case "workspace.read"` åˆ†æ”¯ä¸­ï¼Œæ˜¾å¼æ‹’ç»è®¿é—®ä»¥ä¸‹å›ºå®šæ–‡ä»¶åï¼š
       - `allowlist.json`ã€`pairing.json`ã€`mcp.json`ã€‚
       - ä½ç½®ï¼š`packages/belldandy-core/src/server.ts`ï¼Œ`switch (req.method)` ä¸­ workspace åˆ†æ”¯ã€‚
     - **4.1.3** è§„åˆ’ä¸€ä¸ªâ€œå†…éƒ¨çŠ¶æ€ç›®å½•â€ï¼ˆå¦‚ `stateDir/internal/`ï¼‰ï¼Œå­˜æ”¾ allowlist/pairing/mcp ç­‰å†…éƒ¨æ–‡ä»¶ï¼Œå¹¶åœ¨ `workspace.*` çš„è·¯å¾„è§£æé€»è¾‘ä¸­æ’é™¤è¯¥ç›®å½•ã€‚

2. **P1ï¼šæœ¬åœ° WebSocket è¢«æµè§ˆå™¨è„šæœ¬åŠ«æŒï¼ˆCSWSHï¼‰ + é»˜è®¤ AUTH_MODE=none**
   - **é—®é¢˜æè¿°**ï¼š
     - é»˜è®¤é…ç½®ä¸º `HOST=127.0.0.1`ã€`AUTH_MODE=none`ï¼Œä»»ä½•åœ¨æœ¬æœºæµè§ˆå™¨é‡Œè¿è¡Œçš„ JS éƒ½å¯ä»¥å°è¯•è¿æ¥ `ws://127.0.0.1:28889`ã€‚
     - ç»“åˆä¸Šé¢çš„ P0 æ¼æ´ï¼Œæ¶æ„ç½‘é¡µè„šæœ¬å¯ä»¥ï¼šè¿ä¸Š Gateway â†’ è°ƒç”¨ `workspace.read` è¯»å– `allowlist.json` â†’ ä¼ªé€ å·²é…å¯¹ `clientId` â†’ è·å–å®Œæ•´æ§åˆ¶æƒã€‚
   - **æœ€å°æ”¹åŠ¨æ–¹æ¡ˆ**ï¼š
     - **4.1.4** å¼ºåŒ–é»˜è®¤é…ç½®ä¸å¯åŠ¨æ ¡éªŒï¼š
       - åœ¨ `packages/belldandy-core/src/bin/gateway.ts` ä¸­ï¼š
         - å°† `BELLDANDY_AUTH_MODE` çš„é»˜è®¤å€¼ä» `none` è°ƒæ•´ä¸º `token`ã€‚
         - å¯åŠ¨æ—¶è‹¥æ£€æµ‹åˆ° `HOST=0.0.0.0` ä¸” `AUTH_MODE=none`ï¼Œç›´æ¥æ‹’ç»å¯åŠ¨å¹¶æ‰“å°æ˜ç¡®é”™è¯¯ï¼ˆè€Œéä»… Warningï¼‰ã€‚
       - åœ¨ `.env.example` å’Œæ–‡æ¡£ä¸­åŒæ­¥æ›´æ–°é»˜è®¤æ¨èå€¼ä¸º `AUTH_MODE=token`ï¼Œå¹¶å¼ºè°ƒ `none` ä»…é€‚ç”¨äº**æœ¬æœºå¼€å‘ + å¯ä¿¡æµè§ˆå™¨ç¯å¢ƒ**ã€‚
     - **4.1.5** WebSocket æ¡æ‰‹å¢å¼ºï¼š
       - åœ¨ `server.ts` çš„ `acceptConnect` ä¸­å¼•å…¥ä¸€ä¸ªä»…æœåŠ¡å™¨çŸ¥æ™“çš„éšæœº `serverNonce` æˆ– `sessionToken`ï¼Œè¦æ±‚å®¢æˆ·ç«¯åœ¨ `connect` å¸§ä¸­è¿”å›ï¼›
       - è¯¥ token é€šè¿‡ CLI æˆ–å¯åŠ¨è„šæœ¬ï¼ˆ`start.sh/start.bat`ï¼‰å®‰å…¨æ³¨å…¥ï¼Œè€Œä¸ç»ç”± `workspace.*` æš´éœ²ã€‚

3. **P1ï¼šé…ç½®ä¸ Secrets é€šè¿‡ config.read/config.update æš´éœ²æˆ–è¢«ç¯¡æ”¹**
   - **é—®é¢˜æè¿°**ï¼š
     - `config.read` ä¼šç›´æ¥è¯»å–å¹¶è§£æ `process.cwd()/.env.local`ï¼Œå°†æ‰€æœ‰é”®å€¼è¿”å›ç»™å®¢æˆ·ç«¯ï¼›`config.update` å¯å†™å…¥ä»»æ„é…ç½®é¡¹ã€‚
     - åœ¨ P0 ç»•è¿‡å­˜åœ¨æ—¶ï¼Œè¿™æ„å‘³ç€ `.env.local` ä¸­çš„ API Keyã€Token ç­‰éƒ½å¯èƒ½è¢«æœªæˆæƒå®¢æˆ·ç«¯è¯»å–æˆ–æ”¹å†™ã€‚
   - **æœ€å°æ”¹åŠ¨æ–¹æ¡ˆ**ï¼š
     - **4.1.6** åœ¨ `packages/belldandy-core/src/server.ts` ä¸­ï¼š
       - ä¿æŒ `config.read/config.update` åœ¨ `secureMethods` ä¸­ï¼ˆç°çŠ¶å¦‚æ­¤ï¼‰ï¼ŒåŒæ—¶åœ¨å…¶å®ç°å†…å¢åŠ å¯¹æ•æ„Ÿé”®çš„è„±æ•å¤„ç†ï¼Œä¸ `ToolExecutor.audit` çš„é€»è¾‘å¯¹é½ï¼š
         - ä¾‹å¦‚å¯¹åŒ…å« `password/token/api_key/secret` ç­‰å­—æ®µåçš„å€¼ç»Ÿä¸€è¿”å› `[REDACTED]`ã€‚
     - **4.1.7** ä¸º `config.update` å¢åŠ â€œå…è®¸ä¿®æ”¹çš„ key ç™½åå•â€ï¼Œé™åˆ¶åªèƒ½å†™å…¥ä¸ Agent è¿è¡Œç›¸å…³çš„å°‘æ•°é…ç½®ï¼ˆå¦‚æ¨¡å‹/å¿ƒè·³/æµè§ˆå™¨ä¸­ç»§ï¼‰ï¼Œè€Œä¸å…è®¸è¿œç¨‹ä¿®æ”¹æ—¥å¿—ç›®å½•ã€stateDir ç­‰å®‰å…¨æ•æ„Ÿé…ç½®ã€‚

4. **P2ï¼šMCP ä¸é«˜æƒé™å·¥å…·çš„è¾¹ç•Œæ”¶ç´§ï¼ˆæ˜¾å¼ Opt-inï¼‰**
   - **é—®é¢˜æè¿°**ï¼š
     - MCP æœåŠ¡å™¨ä¸€æ—¦å¯ç”¨ï¼Œå…¶æ‰€æœ‰å·¥å…·ä¼šè¢«æ¡¥æ¥ä¸ºæœ¬åœ°å·¥å…·ï¼Œèƒ½åŠ›å–å†³äºè¿œç«¯å®ç°ï¼ˆå¯èƒ½åŒ…å«æ–‡ä»¶/å‘½ä»¤/ç½‘ç»œç­‰é«˜æƒé™æ“ä½œï¼‰ã€‚
     - åº“å±‚é¢çš„é«˜æƒé™å·¥å…·ï¼ˆ`run_command`ã€`terminal`ã€`code_interpreter`ï¼‰å¯¹é›†æˆè€…å¼€æ”¾ï¼Œæœªæ¥æœ‰è¢«é”™è¯¯æ³¨å†Œè¿› Gateway çš„é£é™©ã€‚
   - **æœ€å°æ”¹åŠ¨æ–¹æ¡ˆ**ï¼š
     - **4.1.8** åœ¨ `packages/belldandy-core/src/bin/gateway.ts` ä¸­ï¼š
       - æ˜ç¡®å°† MCP å·¥å…·çš„æ³¨å†Œä¸å¦ç»‘å®šåˆ° `BELLDANDY_MCP_ENABLED` ä¸ `BELLDANDY_TOOLS_ENABLED`ï¼Œå¹¶åœ¨æ—¥å¿—ä¸­æ‰“å°å½“å‰å¯ç”¨çš„ MCP æœåŠ¡å™¨ä¸å·¥å…·æ•°é‡ï¼ˆç°å·²éƒ¨åˆ†å®ç°ï¼Œå¯å¼ºåŒ–æ–‡æ¡£ä¸æ—¥å¿—ï¼‰ã€‚
     - **4.1.9** åœ¨ `packages/belldandy-skills/src/index.ts` ä¸æ–‡æ¡£ä¸­ï¼š
       - å¯¹ `run_command` / `terminal` / `code_interpreter` æ ‡æ³¨ä¸ºâ€œé«˜é£é™©å·¥å…·ï¼Œä»…é™æœ¬åœ°å¼€å‘è°ƒè¯•ä½¿ç”¨â€ï¼Œå¹¶å»ºè®®é›†æˆè€…åœ¨è‡ªå·±çš„ Agent ä¸­æ˜¾å¼ Opt-inï¼Œè€Œéé»˜è®¤æ³¨å†Œåˆ°ç”¨æˆ·æš´éœ²çš„ Gatewayã€‚

5. **P2ï¼šweb_fetch SSRF ç»†èŠ‚ä¿®è¡¥**
   - **é—®é¢˜æè¿°**ï¼š
     - ç›®å‰çš„å†…ç½‘åœ°å€æ‹¦æˆªåŸºäº host å­—ç¬¦ä¸²åŒ¹é…ï¼Œå¯¹å½¢å¦‚ `http://2130706433/`ï¼ˆåè¿›åˆ¶ IPï¼‰æˆ–æŸäº› DNS è§£æåˆ°å†…ç½‘åœ°å€çš„æƒ…å†µç¼ºä¹é˜²æŠ¤ã€‚
   - **æœ€å°æ”¹åŠ¨æ–¹æ¡ˆ**ï¼š
     - **4.1.10** åœ¨ `packages/belldandy-skills/src/builtin/fetch.ts` ä¸­ï¼š
       - åœ¨å‘é€è¯·æ±‚å‰å¢åŠ å¯¹ `URL.hostname` çš„è¿›ä¸€æ­¥è§£æï¼š
         - è‹¥ä¸ºçº¯æ•°å­—æˆ–éæ ‡å‡† IP å­—ç¬¦ä¸²ï¼Œå°è¯•ç”¨ `net.isIP` æˆ–æ‰‹åŠ¨è§£æä¸º IP åå†èµ° `isPrivateHost` æ£€æŸ¥ï¼›
         - å¯¹éœ€è¦ DNS è§£æçš„åŸŸåï¼Œå¯é€‰åœ°å¢åŠ ä¸€æ¬¡ `dns.lookup`ï¼Œå°†è¿”å› IP å†è¿‡ä¸€éå†…ç½‘èŒƒå›´åˆ¤æ–­ï¼ˆä½œä¸ºå¯é…ç½®å¼€å…³ï¼‰ã€‚

6. **P3ï¼šæµè§ˆå™¨è‡ªåŠ¨åŒ–çš„åŸŸå/é¡µé¢è®¿é—®æ§åˆ¶**
   - **é—®é¢˜æè¿°**ï¼š
     - å¯ç”¨ Browser Relay åï¼ŒAgent å¯ä»¥åœ¨ç”¨æˆ·æµè§ˆå™¨ä¸­æ‰“å¼€ä»»æ„ URLã€è¯»å–å†…å®¹ã€æˆªå›¾å¹¶æ‰§è¡Œæ“ä½œï¼Œç›®å‰ç¼ºå°‘åŸŸåæˆ– URL çº§åˆ«çš„é™åˆ¶ã€‚
   - **æœ€å°æ”¹åŠ¨æ–¹æ¡ˆ**ï¼š
     - **4.1.11** åœ¨ `packages/belldandy-skills/src/builtin/browser/tools.ts` ä¸­ï¼š
       - ä¸º `browser_open` / `browser_navigate` å¢åŠ å¯é€‰çš„ `allowedDomains` / `deniedDomains` ç­–ç•¥ï¼ˆç»“æ„å¯ä»¥å¤ç”¨ `web_fetch` çš„ç­–ç•¥ï¼‰ï¼›
       - åœ¨ Gateway å±‚é€šè¿‡ç¯å¢ƒå˜é‡ï¼ˆå¦‚ `BELLDANDY_BROWSER_ALLOWED_DOMAINS`ï¼‰æ³¨å…¥è¯¥ç­–ç•¥ï¼Œé»˜è®¤ä»…å…è®¸è®¿é—® `localhost`/æŒ‡å®šå·¥ä½œåŸŸï¼Œæˆ–è€…è‡³å°‘åœ¨æ–‡æ¡£ä¸­æ˜ç¡®â€œå¯ç”¨æµè§ˆå™¨æ§åˆ¶ç­‰åŒäºç»™äºˆ Agent é«˜æƒé™æ“ä½œæµè§ˆå™¨â€çš„é£é™©æç¤ºã€‚

> æ³¨ï¼šä»¥ä¸Šå„é¡¹ä¸ºâ€œæœ€å°å¯è¡Œæ”¹åŠ¨â€çº§åˆ«çš„è§„åˆ’ï¼Œå…·ä½“å®æ–½æ—¶å¯ä»¥æ‹†è§£ä¸ºå¤šä¸ª Phaseï¼ˆä¾‹å¦‚ Phase 19ï¼šå®‰å…¨åŠ å›ºä¸€æœŸï¼‰ï¼Œå¹¶ä¸ºæ¯ä¸€é¡¹è¡¥å……å•å…ƒ/é›†æˆæµ‹è¯•ç”¨ä¾‹ã€‚ 
### Phase 8ï¼šMoltbot å…¨èƒ½åŠ›å¯¹æ ‡ï¼ˆè¿›è¡Œä¸­ï¼‰

**ç›®æ ‡**ï¼šå®ç°é™¤ç‰¹å®šæ¸ é“æ“ä½œå¤–çš„æ‰€æœ‰ Moltbot æ ¸å¿ƒèƒ½åŠ›ï¼Œèµ‹äºˆ Belldandy çœŸæ­£çš„"å…¨èƒ½"å±æ€§ã€‚

**å®æ–½è·¯çº¿å›¾**ï¼š

| Phase | å†…å®¹ | å…³é”®åŠŸèƒ½ |
|-------|------|----------|
| **Phase 1** | **æ ¸å¿ƒæ–‡ä»¶æ“ä½œè¡¥å…¨** | `list_files` (ç›®å½•éå†) âœ…, `apply_patch` (é‡æ„ä¸º Agent ä¸“ç”¨ DSL) âœ… |
| **Phase 2** | **ç½‘ç»œæœç´¢** | `web_search` (é›†æˆ SerpAPI/Bing/Google) âœ… |
| **Phase 3** | **ç³»ç»Ÿå‘½ä»¤æ‰§è¡Œ (Enhanced)** | `run_command` (Exec), `process_manager` (Kill/List), `terminal` (PTY/Shell) âœ… (Enhanced with Fallback) |
| **Phase 4** | **ä»£ç è§£é‡Šå™¨ (Code Interpreter)** | `code_interpreter` (Python/Node.js) âœ… (Stateless execution supported) |
| **Phase 5** | **å¤šåª’ä½“ä¸åˆ›é€ åŠ›** | `image_generate` (DALL-E), `text_to_speech` (OpenAI TTS) âœ… |
| **Phase 6** | **ä¼šè¯ç¼–æ’** | `sessions_spawn` (å­ä»»åŠ¡), `sessions_history` âœ… (Requires Runtime Injection) |
| **Phase 7** | **é«˜çº§è®°å¿†ä¸çŸ¥è¯†** | `nodes` (çŸ¥è¯†å›¾è°±) -> Hybrid Search RAG (SQLite + Vector) âœ… |
| **Phase 8** | **æ’ä»¶ç³»ç»Ÿ (Plugin System)** | âœ… **å·²å®Œæˆ** <br> - **Phase 8.1 Core Hooks**: `AgentHooks` (`beforeRun`, `beforeToolCall`, `afterToolCall`, `afterRun`) <br> - **Phase 8.2 Plugin Registry**: åŠ¨æ€åŠ è½½ `.js`/`.mjs` æ’ä»¶ï¼Œæ”¯æŒ Tool æ³¨å†Œä¸ Hook èšåˆã€‚ <br> - **Phase 8.3 Hook System Extension**: 13 ç§å®Œæ•´é’©å­ + HookRegistry + HookRunner + ä¼˜å…ˆçº§ + å¤šæ‰§è¡Œæ¨¡å¼ã€‚ |
| **Phase 9** | **æµè§ˆå™¨æ‰©å±• (Browser Extension)** | âœ… **æ ¸å¿ƒå·²å®Œæˆ** <br> - **Phase 9.1 Relay Server**: WebSocket ä¸­ç»§æœåŠ¡ï¼ŒMock HTTP/CDP åè®®ï¼Œæ”¯æŒ Puppeteer è¿æ¥ã€‚ <br> - **Phase 9.2 Chrome Extension**: `chrome.debugger` æ¡¥æ¥ï¼Œå¤„ç† `Target` ç”Ÿå‘½å‘¨æœŸï¼Œè‡ªåŠ¨é™„ç€ã€‚ <br> - **Phase 9.3 Integration**: æˆåŠŸå®ç° Agent -> Relay -> Extension -> Page çš„å…¨é“¾è·¯æ§åˆ¶ã€‚ |

### Phase 8: Model Failover & High Availability [å·²å®Œæˆ]

**ç›®æ ‡**ï¼šå®ç°ç±»ä¼¼ OpenClaw çš„æ¨¡å‹è°ƒç”¨å®¹ç¾æœºåˆ¶ï¼Œç¡®ä¿é«˜å¯ç”¨æ€§ã€‚

**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ (2026-02-10)

**å·²å®ç°å†…å®¹**ï¼š

| Step | å†…å®¹ | çŠ¶æ€ |
|------|------|------|
| 1 | FailoverClient æ ¸å¿ƒç±»ï¼ˆé”™è¯¯åˆ†ç±» + Cooldown + å¤š Profile è½®è¯¢ï¼‰ | âœ… å·²å®Œæˆ |
| 2 | OpenAIChatAgent é›†æˆï¼ˆæµå¼/éæµå¼å‡èµ° FailoverClientï¼‰ | âœ… å·²å®Œæˆ |
| 3 | ToolEnabledAgent é›†æˆï¼ˆcallModel èµ° FailoverClientï¼‰ | âœ… å·²å®Œæˆ |
| 4 | Gateway é…ç½®åŠ è½½ï¼ˆmodels.json / BELLDANDY_MODEL_CONFIG_FILEï¼‰ | âœ… å·²å®Œæˆ |

**æ–‡ä»¶ç»“æ„**ï¼š

```
packages/belldandy-agent/src/
â”œâ”€â”€ failover-client.ts   # [NEW] FailoverClient + CooldownManager + é”™è¯¯åˆ†ç±» + é…ç½®åŠ è½½
â”œâ”€â”€ openai.ts            # [MODIFIED] ä½¿ç”¨ FailoverClient.fetchWithFailover
â”œâ”€â”€ tool-agent.ts        # [MODIFIED] callModel ä½¿ç”¨ FailoverClient
â””â”€â”€ index.ts             # [MODIFIED] å¯¼å‡º FailoverClient ç›¸å…³ç±»å‹

packages/belldandy-core/src/bin/
â””â”€â”€ gateway.ts           # [MODIFIED] åŠ è½½ models.json å¹¶ä¼ å…¥ fallbacks
```

**æ ¸å¿ƒæœºåˆ¶**ï¼š

- **é”™è¯¯åˆ†ç±»**: 429 (rate_limit) / 5xx (server_error) / 408 (timeout) â†’ è§¦å‘ failoverï¼›400 (format) â†’ ä¸å¯é‡è¯•
- **Cooldown**: rate_limit å†·å´ 2 åˆ†é’Ÿï¼Œbilling (402) å†·å´ 10 åˆ†é’Ÿï¼Œå…¶ä»– 1 åˆ†é’Ÿ
- **å‘åå…¼å®¹**: ä¸é…ç½® `models.json` æ—¶è¡Œä¸ºä¸ä¹‹å‰å®Œå…¨ä¸€è‡´

**æ–°å¢ç¯å¢ƒå˜é‡**ï¼š

| å˜é‡ | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `BELLDANDY_MODEL_CONFIG_FILE` | å¤‡ç”¨æ¨¡å‹é…ç½®æ–‡ä»¶è·¯å¾„ | `~/.belldandy/models.json` |

**é…ç½®æ ¼å¼** (`~/.belldandy/models.json`)ï¼š

```json
{
  "fallbacks": [
    {
      "id": "deepseek-backup",
      "baseUrl": "https://api.deepseek.com",
      "apiKey": "sk-your-key",
      "model": "deepseek-chat"
    }
  ]
}
```

**éªŒæ”¶ç”¨ä¾‹**ï¼š
- [x] ç¼–è¯‘é€šè¿‡ (`pnpm run build`)
- [x] ä¸é…ç½® models.json æ—¶è¡Œä¸ºä¸å˜ï¼ˆå‘åå…¼å®¹ï¼‰
- [x] ä¸» Key å¤±è´¥ (401/429/500) åè‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨ Profile
- [x] 400 é”™è¯¯ä¸è§¦å‘ failoverï¼ˆç›´æ¥è¿”å›é”™è¯¯ï¼‰
- [x] æ—¥å¿—æ¸…æ™°è®°å½• failover è¿‡ç¨‹

### Phase 9: æµè§ˆå™¨æ‰©å±• (Browser Extension)ï¼ˆè¿›è¡Œä¸­ï¼‰

**ç›®æ ‡**ï¼šå®ç°å¯¹ç”¨æˆ·çœŸå®æµè§ˆå™¨çš„æ¥ç®¡ä¸æ§åˆ¶ï¼Œå¤ç”¨ç™»å½•æ€ï¼ˆCookies/Local Storageï¼‰ã€‚

**å·²å®Œæˆï¼ˆPhase 9.1 - 9.4ï¼‰**ï¼š
- **æ¶æ„è½åœ°**ï¼šRelay Server (Node.js) + Chrome Extension (MV3)ã€‚
- **æ ¸å¿ƒé“¾è·¯**ï¼šPuppeteer è¿æ¥ Relayï¼ŒRelay è½¬å‘ CDP æŒ‡ä»¤ç»™ Extensionï¼ŒExtension æ§åˆ¶ Tabã€‚
- **éš¾ç‚¹æ”»å…‹**ï¼š
  - ä¿®å¤äº†æ— é™ `setAutoAttach` å¾ªç¯ã€‚
  - è§£å†³äº† Extension/Relay/Puppeteer ä¸‰æ–¹ ID ä¸ä¸€è‡´å¯¼è‡´çš„ç›®æ ‡å‘ç°å¤±è´¥ï¼ˆé…åˆ `waitForTarget` æœºåˆ¶ï¼‰ã€‚
  - å®ç°äº† `browserContextId` æ³¨å…¥ï¼Œæ¬ºéª— Puppeteer è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªåˆæ³•çš„ Browser Contextã€‚
- **é«˜çº§èƒ½åŠ›ï¼ˆPhase 9.4ï¼‰**ï¼š
  - **Robust Navigation**: å°è£… `browser_open` / `browser_navigate`ï¼Œæ”¯æŒè¶…æ—¶ä¸é‡è¯•ã€‚
### Phase 9.5: Browser Vision & Reading (âœ… å·²å®Œæˆ)
- **ç›®æ ‡**ï¼šèµ‹äºˆ Agent "çœ‹"ç½‘é¡µï¼ˆæˆªå›¾ï¼‰å’Œ"è¯»"ç½‘é¡µï¼ˆæå–æ­£æ–‡ï¼‰çš„èƒ½åŠ›ã€‚
- **çŠ¶æ€**ï¼š**å·²å®Œæˆ**ï¼ˆ2026-02-08ï¼‰
- **å®ç°å†…å®¹**ï¼š
    - **Visual Feedback**: å®ç° `browser_screenshot` å¹¶è‡ªåŠ¨å½’æ¡£åˆ° `screenshots/`ã€‚
    - **Enhanced Reading**: å®ç° `browser_get_content` å¹¶æ”¯æŒ Markdown/Readability ä¼˜åŒ–ç®—æ³•ã€‚
    - **Tool Calls**: å…¨é¢é›†æˆ `browser_snapshot` / `browser_click` / `browser_type`ã€‚

### Phase 10: ç³»ç»Ÿçº§æ“ä½œ (System Execution)ï¼ˆå·²å®Œæˆï¼‰

**ç›®æ ‡**ï¼šèµ‹äºˆ Agent åœ¨å®¿ä¸»æœºæ‰§è¡Œ Shell å‘½ä»¤çš„èƒ½åŠ›ï¼Œä½†å¿…é¡»ä¿è¯å®¿ä¸»æœºå®‰å…¨ã€‚

**å·²å®Œæˆ**ï¼š
- **æ ¸å¿ƒå·¥å…·**ï¼š`run_command` (Shell), `process_manager` (Kill), `terminal` (äº¤äº’å¼ PTY)ã€‚
- **å®‰å…¨ç­–ç•¥ (Consumer Safe Mode)**ï¼š
    - **Blocklist**: å¼ºåˆ¶æ‹¦æˆª `sudo`, `mkfs`, `dd` åŠ `rm -r/f`ã€‚
    - **Safelist**: ç™½åå•å…è®¸ `git`, `npm`, `ls`, `cd`, `pwd`, `date` ç­‰å¼€å‘å·¥å…·ã€‚
    - **éªŒè¯**ï¼šå·²é€šè¿‡è‡ªåŠ¨åŒ–è„šæœ¬éªŒè¯æ‹¦æˆªé€»è¾‘çš„æœ‰æ•ˆæ€§ã€‚
- **ä»·å€¼**ï¼šèµ‹äºˆ Agent è¿è¡Œæ„å»ºè„šæœ¬ã€ç®¡ç†è¿›ç¨‹å’Œè¿›è¡Œç¯å¢ƒè¯Šæ–­çš„èƒ½åŠ›ã€‚

### Phase 11: å®æ—¶æ–‡ä»¶æ„ŸçŸ¥ (Real-time File Perception)ï¼ˆå·²å®Œæˆï¼‰

**ç›®æ ‡**ï¼šè®© Memory ç³»ç»Ÿå®æ—¶æ„ŸçŸ¥å·¥ä½œåŒºæ–‡ä»¶çš„å˜åŒ–ï¼ˆå¢/åˆ /æ”¹ï¼‰ï¼Œå®ç°â€œå†™ä»£ç å³ç´¢å¼•â€ã€‚

**å·²å®Œæˆ**ï¼š
- **æŠ€æœ¯é€‰å‹**ï¼šå¼•å…¥ `chokidar` å®ç°è·¨å¹³å°é«˜æ•ˆç›‘å¬ã€‚
- **MemoryIndexer å‡çº§**ï¼šæ•´åˆ Watcherï¼Œæ”¯æŒ `1000ms` debounce é˜²æŠ–æ›´æ–°ã€‚
- **MemoryManager é›†æˆ**ï¼šå¯åŠ¨æ—¶è‡ªåŠ¨å¼€å¯ç›‘å¬ï¼ˆ`startWatching`ï¼‰ã€‚
- **å¢é‡æ›´æ–°**ï¼š
  - `add`/`change` -> è‡ªåŠ¨è°ƒç”¨ `indexFile` é‡æ–°ç”Ÿæˆ Embedding (åŠ Keyword ç´¢å¼•)ã€‚
  - `unlink` -> è‡ªåŠ¨è°ƒç”¨ `deleteBySource` æ¸…ç†å¤±æ•ˆè®°å¿†ã€‚
- **éªŒè¯**ï¼šé€šè¿‡ `verify-watcher.mjs` éªŒè¯äº†æ–‡ä»¶å¢åˆ æ”¹çš„æ¯«ç§’çº§æ„ŸçŸ¥ã€‚

### Phase 13.6: Kimi åŸç”Ÿè§†è§‰ä¸è§†é¢‘ (Native Multimodal Vision & Video)
- **Status**: âœ… å·²å®Œæˆ (2026-02-10)
- **Goal**: èµ‹äºˆ Agent "çœ‹æ‡‚" ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡å’Œè§†é¢‘çš„èƒ½åŠ›ã€‚
- **Implementation**:
    - **Interface**: æ›´æ–° `AgentRunInput` æ”¯æŒ `content: Array<AgentContentPart>` (text/image_url/video_url)ã€‚
    - **Gateway**: ä¿®æ”¹ `handleReq`ï¼Œè¯†åˆ« `image/*` é™„ä»¶è½¬ Base64 DataURIï¼Œè¯†åˆ« `video/*` é™„ä»¶å­˜æœ¬åœ°ä¸´æ—¶æ–‡ä»¶å¹¶ç”Ÿæˆ `file://` URLã€‚
    - **Shared Module** (`multimodal.ts`): æŠ½å–å…±äº«çš„è§†é¢‘ä¸Šä¼ ä¸å¤šæ¨¡æ€é¢„å¤„ç†é€»è¾‘ï¼Œ`OpenAIChatAgent` å’Œ `ToolEnabledAgent` å…±ç”¨ï¼š
      - `buildUrl(baseUrl, endpoint)`: ç»Ÿä¸€å¤„ç† baseUrl æ˜¯å¦å·²å¸¦ `/v1` çš„ URL æ‹¼æ¥ã€‚
      - `uploadFileToMoonshot(filePath, apiKey, baseUrl, purpose)`: ä¸Šä¼ æœ¬åœ°æ–‡ä»¶åˆ° Moonshot `/files` ç«¯ç‚¹ï¼ˆ100MB é™åˆ¶ï¼Œ`purpose="video"`ï¼‰ã€‚
      - `preprocessMultimodalContent(content, profile, uploadOverride?)`: æ‰«æ content æ•°ç»„ï¼Œå°† `file://` è§†é¢‘ä¸Šä¼ åæ›¿æ¢ä¸º `ms://<file_id>` åè®® URLã€‚
    - **VideoUploadConfig**: ç‹¬ç«‹çš„ä¸Šä¼ é…ç½®ï¼ˆ`apiUrl` + `apiKey`ï¼‰ï¼Œè§£å†³ä»£ç†ä¸æ”¯æŒ `/files` ç«¯ç‚¹çš„é—®é¢˜ï¼Œå¯ç›´è¿ Moonshot APIã€‚
    - **Agent é›†æˆ**: ä¸¤ä¸ª Agent å‡åœ¨ `run()` ä¸­æ£€æµ‹ `video_url` + `file://` â†’ yield `uploading_video` çŠ¶æ€ â†’ è°ƒç”¨ `preprocessMultimodalContent` â†’ ä½¿ç”¨è½¬æ¢åçš„ `ms://` URL å‘é€è¯·æ±‚ã€‚
    - **å®¹é”™**: ä¸Šä¼ å¤±è´¥æ—¶é™çº§ä¸ºæ–‡æœ¬å ä½ `[Video: <path> (Upload Failed: <reason>)]`ï¼Œä¸ä¸­æ–­è¯·æ±‚ã€‚
- **ä¿®å¤é“¾è·¯**:
    | é—®é¢˜ | ä¿®å¤ |
    |------|------|
    | ToolEnabledAgent ç¼ºå°‘è§†é¢‘ä¸Šä¼ é€»è¾‘ | æŠ½å–å…±äº« `multimodal.ts`ï¼Œä¸¤ä¸ª Agent å…±ç”¨ |
    | ä»£ç†ä¸æ”¯æŒ `/files` ç«¯ç‚¹ (404) | æ–°å¢ `VideoUploadConfig` ç‹¬ç«‹ä¸Šä¼ é…ç½® |
    | `purpose="file-extract"` ä¸æ”¯æŒè§†é¢‘ (400) | æ”¹ä¸º `purpose="video"` |
    | `video_file` ä¸æ˜¯åˆæ³• content part ç±»å‹ (400) | æ”¹ä¸º `video_url` + `ms://<file_id>` åè®® |
    | ä»£ç†ä¸æ”¯æŒå¤šæ¨¡æ€ content æ•°ç»„ (422) | ç›´è¿ Moonshotï¼Œç»Ÿä¸€ URL + Key |
- **File Structure**:
    ```
    packages/belldandy-agent/src/
    â”œâ”€â”€ multimodal.ts       # [NEW] å…±äº«è§†é¢‘ä¸Šä¼  & å¤šæ¨¡æ€é¢„å¤„ç†
    â”œâ”€â”€ openai.ts           # [MODIFIED] å¼•ç”¨ multimodal.ts
    â”œâ”€â”€ tool-agent.ts       # [MODIFIED] å¼•ç”¨ multimodal.tsï¼ˆè¡¥é½è§†é¢‘é€»è¾‘ï¼‰
    â””â”€â”€ index.ts            # [MODIFIED] å¯¼å‡º multimodal ç›¸å…³ç±»å‹
    ```
- **Validation**:
    - [x] å›¾ç‰‡ç†è§£éªŒè¯é€šè¿‡ï¼ˆBase64 DataURI ç›´ä¼ ï¼‰ã€‚
    - [x] è§†é¢‘ç†è§£éªŒè¯é€šè¿‡ï¼ˆ`file://` â†’ upload â†’ `ms://` â†’ Moonshot APIï¼‰ã€‚
    - [x] ToolEnabledAgent è§†é¢‘ç†è§£éªŒè¯é€šè¿‡ï¼ˆä¸ OpenAIChatAgent å…±ç”¨ multimodal.tsï¼‰ã€‚
    - [x] éªŒè¯è„šæœ¬ `scripts/verify_kimi_video.ts` é€»è¾‘éªŒè¯é€šè¿‡ã€‚
    - [x] ä¸Šä¼ å¤±è´¥å®¹é”™é™çº§éªŒè¯é€šè¿‡ã€‚

### Phase 10.5: OS è®¡ç®—æœºæ“ä½œèƒ½åŠ› (OS Computer Use) [Proposed]
- **Goal**: èµ‹äºˆ Agent åƒäººä¸€æ ·æ“ä½œæ“ä½œç³»ç»Ÿçš„èƒ½åŠ›ï¼ˆçœ‹å±å¹•ã€åŠ¨é¼ æ ‡ã€æ•²é”®ç›˜ï¼‰ï¼Œçªç ´æµè§ˆå™¨é™åˆ¶ã€‚
- **Reference**: `UI-TARS` "çœ‹å¾—å‡† + ç‚¹å¾—å‡†" æœ€ä½³å®è·µã€‚
- **Core Components**:
    - **High-Fidelity Vision**:
        - ä½¿ç”¨ `nut-js` + `Jimp` è·å–ç‰©ç†åˆ†è¾¨ç‡æˆªå›¾ã€‚
        - å¤„ç† DPI Scale Factorï¼Œç¡®ä¿åæ ‡ç³»å¯¹é½ã€‚
    - **Precision Control**:
        - **Box-to-Pixel**: å®ç°ç»Ÿä¸€åæ ‡æ˜ å°„å±‚ï¼ˆVLM [0-1000] -> Screen [x,y]ï¼‰ã€‚
        - **Human-like Input**: é¼ æ ‡å¹³æ»‘ç§»åŠ¨ (`straightTo`)ï¼Œé”®ç›˜ä½¿ç”¨å‰ªè´´æ¿ç²˜è´´ (`Ctrl+V`) é¿å… IME é—®é¢˜ã€‚
    - **Visual Feedback**:
        - **ScreenMarker**: é€æ˜ç½®é¡¶çª—å£ï¼Œå®æ—¶ç»˜åˆ¶ AI çš„â€œæ³¨è§†ç‚¹â€å’Œâ€œæ‹Ÿæ“ä½œæ¡†â€ï¼Œæä¾›å¯è§£é‡Šæ€§ã€‚

### Phase 12: æ€§èƒ½ä¸å‘é‡åŠ é€Ÿ (Phase 12: Vector Optimization)ï¼ˆå·²å®Œæˆï¼‰

**ç›®æ ‡**ï¼šå¼•å…¥ `sqlite-vec` æ›¿æ¢çº¯ JS çš„å‘é‡è®¡ç®—ï¼Œå®ç°ç™¾ä¸‡çº§æ•°æ®çš„é«˜æ€§èƒ½æ£€ç´¢ï¼ˆå¯¹æ ‡ Moltbotï¼‰ã€‚

**å®æ–½è¯¦æƒ…**ï¼š
- **æ ¸å¿ƒç»„ä»¶**ï¼šé›†æˆäº† `sqlite-vec` (v0.1.0) C++ æ‰©å±•ã€‚
- **å­˜å‚¨æ¶æ„**ï¼š
    - åºŸå¼ƒ `BLOB` å­˜å‚¨ï¼Œè¿ç§»è‡³ `vec0` è™šæ‹Ÿè¡¨ (L2/Cosine ä¼˜åŒ–)ã€‚
    - ä½¿ç”¨ `rowid` æ˜ å°„å®ç° `chunks` (å…ƒæ•°æ®) ä¸ `chunks_vec` (å‘é‡) çš„å¼ºä¸€è‡´æ€§ã€‚
- **æ€§èƒ½æŒ‡æ ‡**ï¼š
    - æ£€ç´¢å»¶è¿Ÿï¼š**~12ms** (10k å‘é‡ï¼Œ1536 ç»´)ã€‚
    - QPSï¼š**~80 QPS** (å•çº¿ç¨‹åŸºå‡†)ã€‚
    - å‡†ç¡®æ€§ï¼šTop-1 Recall 100% (éªŒè¯è„šæœ¬é€šè¿‡)ã€‚

### Phase 13: å¤šåª’ä½“å¢å¼º (Advanced Multimedia) [å·²å®Œæˆ]
- **Status**: å·²å®Œæˆ (2026-02-03)
- **Goal**: è®© Agent å…·å¤‡"å¼€å£è¯´è¯"çš„èƒ½åŠ›ï¼Œæ”¯æŒé«˜è´¨é‡ä¸”å…è´¹çš„è¯­éŸ³åˆæˆã€‚
- **Core Strategy**: 
    - **Multi-Provider TTS**: æ”¹é€  `text_to_speech` å·¥å…·ï¼Œæ”¯æŒåˆ‡æ¢ `edge-tts` (å…è´¹/é«˜è´¨é‡) å’Œ `openai` (ä»˜è´¹)ã€‚
    - **Edge TTS**: é›†æˆ `node-edge-tts` åº“ï¼Œåˆ©ç”¨ Azure Neural Voices (å¦‚ `zh-CN-XiaoxiaoNeural`)ã€‚
    - **Static Serving**: Gateway é…ç½® `/generated` é™æ€è·¯ç”±ï¼Œæ”¯æŒéŸ³é¢‘æ–‡ä»¶ Web è®¿é—®ã€‚
    - **Dynamic Toggle**: å®ç°åŸºäºæ–‡ä»¶ä¿¡å· (`TTS_ENABLED`) çš„çƒ­å¼€å…³æœºåˆ¶ï¼Œæ— éœ€é‡å¯å³å¯æ§åˆ¶è¯­éŸ³æ¨¡å¼ã€‚

### Phase 13.5: è§†è§‰æ„ŸçŸ¥ (Vision Perception) [å·²å®Œæˆ]
- **Goal**: èµ‹äºˆ Agent è§†è§‰èƒ½åŠ›ï¼Œä½¿å…¶èƒ½å¤Ÿ"çœ‹åˆ°"ç‰©ç†ä¸–ç•Œï¼ˆé€šè¿‡å®¿ä¸»æœºçš„æ‘„åƒå¤´ï¼‰ã€‚
- **Strategy**: **"Loopback Vision" (å›ç¯è§†è§‰)**
    - **æ— éœ€æ–°åè®®**: åˆ©ç”¨ç°æœ‰çš„ Browser Extension + WebDriver åè®®ã€‚
    - **Implementation**:
        - **Mirror Page**: åœ¨ Gateway æ‰˜ç®¡ä¸€ä¸ª `/mirror.html` é™æ€é¡µé¢ï¼Œè°ƒç”¨ `navigator.mediaDevices.getUserMedia` æ˜¾ç¤ºæ‘„åƒå¤´ç”»é¢ã€‚
        - **Agent Action**: Agent ä½¿ç”¨ `browser_navigate("/mirror.html")` æ‰“å¼€é¡µé¢ï¼Œç„¶åä½¿ç”¨ `browser_screenshot` è·å–è§†è§‰å¸§ã€‚
        - **Privacy**: ç”»é¢ä»…åœ¨æµè§ˆå™¨æœ¬åœ°æ¸²æŸ“ï¼Œä»…åœ¨ Agent ä¸»åŠ¨æˆªå›¾æ—¶ä¼ è¾“å›¾åƒæ•°æ®ã€‚

### Phase 14: æ–¹æ³•è®ºç³»ç»Ÿ (Methodology System) [å·²å®Œæˆ]
- **Status**: å·²å®Œæˆ (2026-02-03)
- **Goal**: è®© Agent å…·å¤‡"è‡ªæˆ‘è¿›åŒ–"ä¸"ç»éªŒæ²‰æ·€"èƒ½åŠ›ï¼Œå»ºç«‹åŸç”Ÿçš„æ–¹æ³•è®ºç®¡ç†æœºåˆ¶ã€‚
- **Core Concept**:
    - **Methods as Code**: å°† `.md` æ–¹æ³•æ–‡ä»¶è§†ä¸º Agent çš„"æ‰§è¡Œè„šæœ¬"ï¼Œå®ç° Create/Read/List/Search çš„å·¥å…·åŒ–ç®¡ç†ã€‚
    - **Self-Refinement Loop**: å°†"æŸ¥é˜…æ–¹æ³• -> æ‰§è¡Œä»»åŠ¡ -> æ²‰æ·€æ–¹æ³•"çš„é—­ç¯é€»è¾‘æ¤å…¥ Agent æ ¸å¿ƒè®¤çŸ¥ã€‚
- **Implementation Strategy**:
    - **1. Skills Extensions (`packages/belldandy-skills`)**:
        - `method_create`: åˆ›å»ºæ–°æ–¹æ³•æ–‡æ¡£ï¼ˆå¸¦æ¨¡æ¿æ ¡éªŒï¼‰ã€‚
        - `method_read`: è¯»å–æŒ‡å®šæ–¹æ³•å†…å®¹ã€‚
        - `method_list`: åˆ—å‡ºå¯ç”¨æ–¹æ³•ï¼ˆæ”¯æŒåˆ†ç±»è¿‡æ»¤ï¼‰ã€‚
        - `method_search`: åŸºäºå‘é‡æˆ–å…³é”®è¯æ£€ç´¢ç›¸å…³æ–¹æ³•ï¼ˆåˆ©ç”¨ç°æœ‰çš„ Memory æœºåˆ¶æˆ–ç®€å•æ–‡æœ¬æœç´¢ï¼‰ã€‚
    - **2. Runtime Integration (`packages/belldandy-core`)**:
        - å¯åŠ¨æ—¶è‡ªåŠ¨å»ºç«‹ `~/.belldandy/methods` ç›®å½•ã€‚
        - åƒåŠ è½½ Skills ä¸€æ ·ï¼Œå»ºç«‹ Methods çš„ç´¢å¼•ã€‚
    - **3. Prompt Engineering (`packages/belldandy-core`)**:
        - ä¿®æ”¹çš„æ ¸å¿ƒ System Prompt æ¨¡æ¿ã€‚
        - æ³¨å…¥"æ–¹æ³•è®ºæ‰§è¡Œåè®®"ï¼šå¼ºåˆ¶ Agent åœ¨å¤æ‚ä»»åŠ¡å‰æŸ¥é˜… Methodsï¼Œä»»åŠ¡åæ›´æ–° Methodsã€‚
        - ä¼˜åŒ–æç¤ºè¯ï¼Œä½¿å…¶æ›´ç¬¦åˆå·¥å…·è°ƒç”¨é€»è¾‘ã€‚

### Phase 15: æ¸ é“æ¶æ„å‡çº§ (Channel Architecture) [å·²å®Œæˆ]
- **Status**: å·²å®Œæˆ (2026-02-05)
- **Goal**: å»ºç«‹æ ‡å‡†åŒ–çš„æ¸ é“æ¥å£ï¼Œä¸ºå¿«é€Ÿæ¥å…¥ Telegramã€Discordã€Slack ç­‰ç¤¾äº¤å¹³å°åšå¥½æ¶æ„å‡†å¤‡ã€‚
- **Core Concept**:
    - **Channel as Interface**: æ‰€æœ‰æ¸ é“å®ç°ç»Ÿä¸€çš„ `Channel` æ¥å£ï¼Œé™ä½æ–°æ¸ é“çš„æ¥å…¥æˆæœ¬ã€‚
    - **ChannelManager**: ç»Ÿä¸€ç®¡ç†å¤šä¸ªæ¸ é“çš„ç”Ÿå‘½å‘¨æœŸï¼ˆå¯åŠ¨ã€åœæ­¢ã€å¹¿æ’­ï¼‰ã€‚
- **Implementation**:
    - **1. æ¥å£å®šä¹‰ (`packages/belldandy-channels/src/types.ts`)**:
        ```typescript
        interface Channel {
            readonly name: string;           // æ¸ é“åç§°
            readonly isRunning: boolean;     // è¿è¡ŒçŠ¶æ€
            start(): Promise<void>;          // å¯åŠ¨æ¸ é“
            stop(): Promise<void>;           // åœæ­¢æ¸ é“
            sendProactiveMessage(content: string, chatId?: string): Promise<boolean>;
        }
        ```
    - **2. ChannelManager (`packages/belldandy-channels/src/manager.ts`)**:
        - `register(channel)`: æ³¨å†Œæ¸ é“
        - `unregister(name)`: æ³¨é”€æ¸ é“
        - `startAll() / stopAll()`: æ‰¹é‡å¯åœ
        - `broadcast(content)`: å…¨æ¸ é“å¹¿æ’­
        - `getStatus()`: è·å–æ‰€æœ‰æ¸ é“çŠ¶æ€
    - **3. FeishuChannel é€‚é…**:
        - å·²å®ç° `Channel` æ¥å£
        - æ–°å¢ `stop()` æ–¹æ³•æ”¯æŒä¼˜é›…å…³é—­
        - å®Œå…¨å‘åå…¼å®¹ç°æœ‰é€»è¾‘
- **ä»·å€¼**: æ–°æ¸ é“æ¥å…¥åªéœ€å®ç° `Channel` æ¥å£ï¼Œé¢„è®¡å¼€å‘å‘¨æœŸ 1-2 å¤©ã€‚

### Phase 16: å­ Agent ç¼–æ’ (Sub-Agent Orchestration) [å¾…å®š]
- **Goal**: è®© Belldandy æ‹¥æœ‰æŒ‡æŒ¥"æ‰‹ä¸‹"çš„èƒ½åŠ›ï¼Œå°†å¤æ‚ä»»åŠ¡åˆ†å‘ç»™ç‹¬ç«‹çš„å­ Agentã€‚
- **Status**: ç§»è‡³ Phase 16ï¼Œä¼˜å…ˆå®ç°æ–¹æ³•è®ºç³»ç»Ÿã€‚
- **Technical Gap**:
    - **Session Manager**: éœ€è¦åœ¨ Gateway å±‚å®ç° Session æ± ã€‚
    - **Tools**: `sessions_spawn`, `sessions_history` éœ€æ¥å…¥ Runtimeã€‚

## æœªæ¥å¢å¼ºè§„åˆ’ï¼šå¤šåª’ä½“èƒ½åŠ› (å‚è€ƒ Moltbot å®ç°)
 
åŸºäºå¯¹ `moltbot` ä»£ç åº“ï¼ˆæˆªè‡³ 2026-02ï¼‰çš„åˆ†æï¼Œä»¥ä¸‹é«˜çº§åŠŸèƒ½æ˜¯æœªæ¥è¿­ä»£çš„å€™é€‰ç‰¹æ€§ï¼š
 
### 1. é«˜çº§è¯­éŸ³åˆæˆ (Advanced TTS)
- **ElevenLabs é›†æˆ**: 
    - å…¨é¢æ”¯æŒ ElevenLabs APIï¼ŒåŒ…æ‹¬ç»†ç²’åº¦çš„è¯­éŸ³è®¾ç½®ï¼š`stability`ï¼ˆç¨³å®šæ€§ï¼‰, `similarity_boost`ï¼ˆç›¸ä¼¼åº¦å¢å¼ºï¼‰, `style`ï¼ˆé£æ ¼ï¼‰, `use_speaker_boost`ï¼ˆæ‰¬å£°å™¨å¢å¼ºï¼‰ã€‚
    - DSL æŒ‡ä»¤æ”¯æŒï¼šåœ¨å¯¹è¯æ¶ˆæ¯ä¸­ä½¿ç”¨ `[[tts:voice=onyx]]` æˆ– `[[tts:provider=elevenlabs]]` åŠ¨æ€æ§åˆ¶è¯­éŸ³ã€‚
- **è‡ªåŠ¨æ‘˜è¦ (Auto-Summarization)**:
    - è‡ªåŠ¨é€»è¾‘æ£€æŸ¥æ–‡æœ¬é•¿åº¦ã€‚å¦‚æœè¶…è¿‡ 1500 å­—ç¬¦ï¼Œå…ˆè°ƒç”¨ LLM å¯¹æ–‡æœ¬è¿›è¡Œæ€»ç»“ï¼Œç„¶åå†å‘é€ç»™ TTSï¼Œä»¥èŠ‚çœæˆæœ¬å¹¶ç¼©çŸ­æ’­æ”¾æ—¶é—´ã€‚
- **åŒå¼•æ“ (Dual Engine)**: æ”¯æŒåœ¨ OpenAI TTS å’Œ ElevenLabs ä¹‹é—´æ— ç¼åˆ‡æ¢ã€‚
 
### Windows å…¼å®¹æ€§å¢å¼º (Windows Compatibility) [å·²å®Œæˆ]

> å¯¹åº” Roadmap ä¸­çš„ **Phase 15ï¼ˆWindows æ”¯æŒï¼‰**ï¼Œåœ¨æ­¤å•ç‹¬å±•å¼€ç»†èŠ‚ï¼Œé¿å…ä¸ã€Œæ¸ é“æ¶æ„å‡çº§ã€çš„ Phase 15 æ··æ·†ã€‚

- **Status**: å·²å®Œæˆ (2026-02-04)
- **Goal**: è§£å†³ Belldandy åœ¨ Windows åŸç”Ÿç¯å¢ƒä¸‹ï¼ˆcmd/powershellï¼‰çš„â€œæ°´åœŸä¸æœâ€é—®é¢˜ï¼Œæä¾›ä¸ Linux åŒç­‰æµç•…çš„è¿ç»´ä½“éªŒã€‚
- **Problem**: 
    - `run_command` ç™½åå•ä¸¥é‡åç§‘ Linuxï¼ˆç¼ºå°‘ `copy`, `del`, `type`, `ipconfig` ç­‰åŸç”Ÿå‘½ä»¤ï¼‰ã€‚
- **Implemented**:
    - **1. Skills Patch (`packages/belldandy-skills`)**:
        - å·²ä¿®æ”¹ `system/exec.ts`ï¼šå°† Windows å¸¸ç”¨å‘½ä»¤ï¼ˆ`copy`, `move`, `del`, `ren`, `type`, `ipconfig`, `netstat`, `tasklist`ï¼‰åŠ å…¥ `SAFELIST`ã€‚
        - å¢å¼ºå®‰å…¨æ€§ï¼šä¸º `del` å‘½ä»¤æ·»åŠ äº†é«˜å±å‚æ•°æ£€æµ‹ï¼ˆæ‹¦æˆª `/s`, `/q`ï¼‰ã€‚
    - **2. Verification**:
        - åˆ›å»ºäº† `exec.test.ts` åŒ…å« Windows ä¸“å±æµ‹è¯•ç”¨ä¾‹ï¼ŒéªŒè¯äº†ç™½åå•æ”¾è¡Œä¸å‚æ•°æ‹¦æˆªé€»è¾‘ã€‚
        - éªŒè¯äº† PowerShell ç¯å¢ƒä¸‹çš„å‘½ä»¤æ‰§è¡Œå…¼å®¹æ€§ã€‚

### 2. é«˜çº§å›¾åƒç”Ÿæˆ (Advanced Image Generation)
- **ç›´æ¥ API è°ƒç”¨**: Moltbot ä½¿ç”¨åŸå§‹ HTTP è°ƒç”¨è€Œé SDK ä»¥è·å¾—æ›´ç²¾ç»†çš„æ§åˆ¶ï¼ˆä¸è¿‡å¯¹ Belldandy æ¥è¯´ SDK å·²ç»è¶³å¤Ÿï¼‰ã€‚
- **ç”»å»Šç”Ÿæˆ**: Python è„šæœ¬ (`gen.py`) ç”¨äºç”Ÿæˆå·²åˆ›å»ºå›¾åƒçš„ HTML ç”»å»Šã€‚
- **æç¤ºè¯å·¥ç¨‹**: å†…ç½®â€œç»“æ„åŒ–éšæœºâ€æç¤ºè¯ç”Ÿæˆå™¨ï¼ˆé£æ ¼ã€å…‰ç…§ã€ä¸»ä½“çš„ç»„åˆï¼‰ï¼Œç”¨äºæ¿€å‘åˆ›ä½œçµæ„Ÿã€‚
 
### 3. å®æ—¶è§†è§‰æµ (Real-time Vision Stream - WebRTC) [ä½ä¼˜å…ˆçº§]
- **é˜¶æ®µ**: Phase 15 (æœªæ¥è§„åˆ’)
- **ç›®æ ‡**: å®ç°ä½å»¶è¿Ÿã€é«˜å¸§ç‡çš„å®æ—¶è§†è§‰æµï¼Œæ”¯æŒ"çœ‹ç€è§†é¢‘ç©æ¸¸æˆ"æˆ–å®æ—¶å®‰é˜²ç›‘æ§åœºæ™¯ã€‚
- **æŠ€æœ¯å·®è·**: 
    - å½“å‰çš„ RPC/æˆªå›¾ æ¨¡å¼å¯¹äºé«˜é¢‘é‡‡æ ·æ¥è¯´ï¼Œåœ¨å¸¦å®½åˆ©ç”¨ç‡å’Œå»¶è¿Ÿä¸Šéƒ½ä¸æ˜¯æœ€ä¼˜è§£ã€‚
- **å»ºè®®æŠ€æœ¯æ ˆ**:
    - **åè®®**: **WebRTC** (æ ‡å‡†åŒ–å®æ—¶é€šä¿¡åè®®)ã€‚
    - **åº“**: **PeerJS** (æŠ½è±¡äº† WebRTC çš„å¤æ‚æ€§ï¼Œä¾¿äºå»ºç«‹ P2P è¿æ¥)ã€‚
    - **æ¶æ„**:
        - **å¹¿æ’­ç«¯ (Broadcaster - æµè§ˆå™¨)**: ä½¿ç”¨ `getUserMedia` è·å–æµï¼Œä½œä¸º Peer Aã€‚
        - **æ¥æ”¶ç«¯ (Receiver - Agent)**: ä½¿ç”¨ `wrtc` (Node.js) æˆ– Headless Browser ä½œä¸º Peer B æ¥æ”¶æµã€‚
        - **å¤„ç† (Processing)**: å°†è§†é¢‘æµå¸§ç›´æ¥è¾“å…¥ç»™ Vision Model (å¦‚ Gemini 1.5 Pro çš„ Video API)ã€‚
- **æŠ€æœ¯æ¥æº**: 
    - **Context7 æœç´¢**: ç¡®è®¤ `PeerJS` ä¸ºé«˜å£°èª‰ã€æ˜“äºå®ç°çš„ Browser-to-Node æµåª’ä½“ä¼ è¾“æ–¹æ¡ˆã€‚
    - **å‚è€ƒ**: https://peerjs.com/

---

### Phase 17: MCP (Model Context Protocol) æ”¯æŒ [å·²å®Œæˆ]

**ç›®æ ‡**ï¼šå®ç° MCP åè®®æ”¯æŒï¼Œè®© Belldandy èƒ½å¤Ÿè¿æ¥å¤–éƒ¨ MCP æœåŠ¡å™¨ï¼Œè·å–ç¬¬ä¸‰æ–¹å·¥å…·å’Œæ•°æ®æºã€‚

**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆï¼ˆ2026-02-05ï¼‰

**èƒŒæ™¯**ï¼š
- MCP æ˜¯ Anthropic æå‡ºçš„æ ‡å‡†åŒ–åè®®ï¼Œç”¨äºè®© AI åŠ©æ‰‹è¿æ¥å¤–éƒ¨æ•°æ®æºå’Œå·¥å…·
- moltbot é€šè¿‡ ACP (Agent Client Protocol) å®ç°äº†ç±»ä¼¼åŠŸèƒ½ï¼Œä½¿ç”¨ `@agentclientprotocol/sdk`
- æ”¯æŒ MCP åï¼Œç”¨æˆ·å¯ä»¥è½»æ¾æ¥å…¥ 1Passwordã€GitHubã€Notionã€Slack ç­‰ç¬¬ä¸‰æ–¹æœåŠ¡

**å·²å®ç°å†…å®¹**ï¼š

| Step | å†…å®¹ | çŠ¶æ€ |
|------|------|------|
| 1 | MCP é…ç½®æ–‡ä»¶ (`~/.belldandy/mcp.json`) | âœ… å·²å®Œæˆ |
| 2 | MCP å®¢æˆ·ç«¯ (stdio/SSE ä¼ è¾“) | âœ… å·²å®Œæˆ |
| 3 | å·¥å…·å‘ç° (ä»æœåŠ¡å™¨è·å–å·¥å…·åˆ—è¡¨) | âœ… å·²å®Œæˆ |
| 4 | å·¥å…·æ¡¥æ¥ (MCP â†’ Belldandy Skills) | âœ… å·²å®Œæˆ |
| 5 | èµ„æºè®¿é—® (MCP Resources åè®®) | âœ… å·²å®Œæˆ |
| 6 | Gateway é›†æˆ (è‡ªåŠ¨åˆå§‹åŒ–) | âœ… å·²å®Œæˆ |

**æŠ€æœ¯æ ˆ**ï¼š
- **åè®®**: MCP (Model Context Protocol) - Anthropic æ ‡å‡†
- **ä¼ è¾“**: stdio (å­è¿›ç¨‹) / SSE (HTTP é•¿è¿æ¥)
- **SDK**: `@modelcontextprotocol/sdk` v1.12.0
- **éªŒè¯**: Zod é…ç½®éªŒè¯

**æ–‡ä»¶ç»“æ„**ï¼š

```
packages/
â”œâ”€â”€ belldandy-mcp/                    # MCP æ”¯æŒåŒ…
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ tsconfig.json
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ index.ts                  # ç»Ÿä¸€å¯¼å‡º
â”‚       â”œâ”€â”€ types.ts                  # MCP ç±»å‹å®šä¹‰
â”‚       â”œâ”€â”€ config.ts                 # é…ç½®åŠ è½½ä¸éªŒè¯
â”‚       â”œâ”€â”€ client.ts                 # MCP å®¢æˆ·ç«¯å°è£…
â”‚       â”œâ”€â”€ tool-bridge.ts            # MCP å·¥å…· -> Skills æ¡¥æ¥
â”‚       â””â”€â”€ manager.ts                # å¤šæœåŠ¡å™¨ç®¡ç†å™¨
â””â”€â”€ belldandy-core/src/
    â””â”€â”€ mcp/
        â””â”€â”€ index.ts                  # Gateway é›†æˆæ¨¡å—
```

**é…ç½®æ–‡ä»¶æ ¼å¼** (`~/.belldandy/mcp.json`)ï¼š

```json
{
  "version": "1.0.0",
  "servers": [
    {
      "id": "filesystem",
      "name": "æ–‡ä»¶ç³»ç»Ÿ",
      "transport": {
        "type": "stdio",
        "command": "npx",
        "args": ["-y", "@modelcontextprotocol/server-filesystem", "/path"]
      },
      "autoConnect": true,
      "enabled": true
    }
  ],
  "settings": {
    "defaultTimeout": 30000,
    "debug": false,
    "toolPrefix": true
  }
}
```

**æ–°å¢ç¯å¢ƒå˜é‡**ï¼š

| å˜é‡ | è¯´æ˜ |
|------|------|
| `BELLDANDY_MCP_ENABLED` | å¯ç”¨ MCP æ”¯æŒï¼ˆé»˜è®¤ falseï¼Œéœ€åŒæ—¶å¯ç”¨ TOOLS_ENABLEDï¼‰ |

**éªŒæ”¶æ ‡å‡†**ï¼š
- [x] èƒ½å¤ŸåŠ è½½ `~/.belldandy/mcp.json` é…ç½®
- [x] èƒ½å¤Ÿé€šè¿‡ stdio è¿æ¥ MCP æœåŠ¡å™¨ï¼ˆå¦‚ `@modelcontextprotocol/server-filesystem`ï¼‰
- [x] èƒ½å¤Ÿå‘ç°å¹¶åˆ—å‡º MCP æœåŠ¡å™¨æä¾›çš„å·¥å…·
- [x] Agent èƒ½å¤Ÿè°ƒç”¨ MCP å·¥å…·å¹¶è·å–ç»“æœ
- [x] æ”¯æŒ MCP èµ„æºè¯»å–

**ä»·å€¼**ï¼š
- å¼€æ”¾ç”Ÿæ€ï¼šç”¨æˆ·å¯ä»¥æ¥å…¥ä»»ä½• MCP å…¼å®¹çš„æœåŠ¡
- èƒ½åŠ›æ‰©å±•ï¼šæ— éœ€ä¿®æ”¹ Belldandy ä»£ç å³å¯è·å¾—æ–°å·¥å…·
- æ ‡å‡†åŒ–ï¼šéµå¾ªä¸šç•Œæ ‡å‡†åè®®ï¼Œå…¼å®¹ Claude Desktop ç­‰å·¥å…·çš„ MCP é…ç½®

---

### Phase 18: æ—¥å¿—ç³»ç»Ÿ (Logging System) [æ ¸å¿ƒå·²å®Œæˆ]

**ç›®æ ‡**ï¼šå®ç°å®Œæ•´çš„æ–‡ä»¶æ—¥å¿—ç³»ç»Ÿï¼Œæ”¯æŒ Agent å›æº¯åˆ†æä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ã€é”™è¯¯æ’æŸ¥å’Œæ€§èƒ½åˆ†æï¼Œä¸æ–¹æ³•è®ºç³»ç»ŸååŒå®ç°è‡ªæˆ‘è¿›åŒ–ã€‚

**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ

**èƒŒæ™¯**ï¼š
- ~~å½“å‰ç³»ç»Ÿä½¿ç”¨åŸç”Ÿ `console` è¾“å‡ºæ—¥å¿—ï¼Œæ— æŒä¹…åŒ–èƒ½åŠ›~~ âœ… å·²æ¥å…¥ç»Ÿä¸€ Logger
- ~~Agent æ— æ³•å›æº¯æŸ¥çœ‹å†å²æ‰§è¡Œè®°å½•ï¼Œéš¾ä»¥è¿›è¡Œæ–¹æ³•è®ºæ²‰æ·€~~ âœ… log_read/log_search å·²å°±ç»ª
- ~~ç¼ºå°‘æ—¥å¿—è½®è½¬å’Œæ¸…ç†æœºåˆ¶ï¼Œé•¿æœŸè¿è¡Œä¼šé€ æˆé—®é¢˜~~ âœ… å·²å®ç°

**æ ¸å¿ƒåŠŸèƒ½**ï¼š

| åŠŸèƒ½ | è¯´æ˜ | çŠ¶æ€ |
|------|------|------|
| **å…¨çº§åˆ«è®°å½•** | debug/info/warn/error å…¨éƒ¨è®°å½• | âœ… |
| **åŒè¾“å‡º** | æ§åˆ¶å°ï¼ˆå½©è‰²ï¼‰+ æ–‡ä»¶ï¼ˆæŒä¹…åŒ–ï¼‰ | âœ… |
| **æŒ‰æ—¥æœŸåˆ†æ–‡ä»¶** | `logs/2026-02-05.log` | âœ… |
| **æ–‡ä»¶å¤§å°è½®è½¬** | å•æ–‡ä»¶è¶…è¿‡é˜ˆå€¼è‡ªåŠ¨è½®è½¬ | âœ… |
| **è‡ªåŠ¨æ¸…ç†** | å¯åŠ¨æ—¶æ¸…ç†è¿‡æœŸæ—¥å¿— | âœ… |
| **Agent å¯è¯»** | æä¾› `log_read`/`log_search` å·¥å…· | âœ… |

**å®ç°æ­¥éª¤**ï¼š

| Step | å†…å®¹ | çŠ¶æ€ |
|------|------|------|
| 1 | Logger æ ¸å¿ƒç±» + ç±»å‹å®šä¹‰ | âœ… å·²å®Œæˆ |
| 2 | ConsoleTransportï¼ˆå½©è‰²è¾“å‡ºï¼‰ | âœ… å·²å®Œæˆ |
| 3 | FileTransportï¼ˆå†™å…¥ + è½®è½¬ï¼‰ | âœ… å·²å®Œæˆ |
| 4 | è‡ªåŠ¨æ¸…ç†é€»è¾‘ | âœ… å·²å®Œæˆ |
| 5 | Gateway é›†æˆï¼ˆæ›¿æ¢ consoleï¼‰ | âœ… å·²å®Œæˆ |
| 6 | Agent/Tools æ¨¡å—é›†æˆï¼ˆMCPã€tool-agent ç­‰æ¥å…¥ loggerï¼‰ | âœ… å·²å®Œæˆ |
| 7 | `log_read` / `log_search` å·¥å…· | âœ… å·²å®Œæˆ |
| 8 | æ€§èƒ½ç›‘æ§ï¼ˆå·¥å…·è°ƒç”¨è€—æ—¶å†™å…¥ auditLoggerï¼‰ | âœ… å·²å®Œæˆ |

**æ–‡ä»¶ç»“æ„**ï¼š

```
packages/belldandy-core/src/
â”œâ”€â”€ logger/
â”‚   â”œâ”€â”€ index.ts              # ç»Ÿä¸€å¯¼å‡º
â”‚   â”œâ”€â”€ logger.ts             # Logger æ ¸å¿ƒç±»
â”‚   â”œâ”€â”€ file-transport.ts     # æ–‡ä»¶å†™å…¥ï¼ˆè½®è½¬ + æ¸…ç†ï¼‰
â”‚   â”œâ”€â”€ console-transport.ts  # æ§åˆ¶å°è¾“å‡ºï¼ˆå½©è‰²ï¼‰
â”‚   â””â”€â”€ types.ts              # ç±»å‹å®šä¹‰

packages/belldandy-skills/src/builtin/
â””â”€â”€ log.ts                    # log_read / log_search å·¥å…·
```

**æ—¥å¿—ç›®å½•ç»“æ„**ï¼š

```
~/.belldandy/
â”œâ”€â”€ logs/                       # æ—¥å¿—ç›®å½•
â”‚   â”œâ”€â”€ 2026-02-05.log          # å½“å¤©æ—¥å¿—
â”‚   â”œâ”€â”€ 2026-02-05.1.log        # å½“å¤©è½®è½¬æ–‡ä»¶ (è¶…è¿‡ 10MB)
â”‚   â”œâ”€â”€ 2026-02-04.log          # æ˜¨å¤©æ—¥å¿—
â”‚   â””â”€â”€ ...
```

**æ—¥å¿—æ ¼å¼**ï¼š

```
[2026-02-05T14:32:15.123+08:00] [INFO] [gateway] Server started on port 28889
[2026-02-05T14:32:15.456+08:00] [DEBUG] [agent] Tool call: file_read {path: "/home/user/code/main.ts"}
[2026-02-05T14:32:15.789+08:00] [WARN] [memory] Slow query detected: 1523ms
[2026-02-05T14:32:16.012+08:00] [ERROR] [tools] web_fetch failed: ECONNREFUSED
```

**æ–°å¢ç¯å¢ƒå˜é‡**ï¼š

| å˜é‡ | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `BELLDANDY_LOG_LEVEL` | æœ€ä½æ—¥å¿—çº§åˆ« | `debug` |
| `BELLDANDY_LOG_DIR` | æ—¥å¿—ç›®å½• | `~/.belldandy/logs` |
| `BELLDANDY_LOG_MAX_SIZE` | å•æ–‡ä»¶æœ€å¤§å¤§å° | `10MB` |
| `BELLDANDY_LOG_RETENTION_DAYS` | æ—¥å¿—ä¿ç•™å¤©æ•° | `7` |
| `BELLDANDY_LOG_CONSOLE` | å¯ç”¨æ§åˆ¶å°è¾“å‡º | `true` |

**è½®è½¬ä¸æ¸…ç†ç­–ç•¥**ï¼š

- **æ–‡ä»¶è½®è½¬**ï¼š
  - æ¯å¤©ä¸€ä¸ªä¸»æ—¥å¿—æ–‡ä»¶ï¼š`2026-02-05.log`
  - å•æ–‡ä»¶è¶…è¿‡ `BELLDANDY_LOG_MAX_SIZE` æ—¶ï¼Œè½®è½¬ä¸º `2026-02-05.1.log`ã€`2026-02-05.2.log`...
  - æ–°æ—¥å¿—å§‹ç»ˆå†™å…¥å½“å¤©çš„ä¸»æ–‡ä»¶

- **è‡ªåŠ¨æ¸…ç†**ï¼š
  - Gateway å¯åŠ¨æ—¶æ‰§è¡Œæ¸…ç†æ£€æŸ¥
  - åˆ é™¤è¶…è¿‡ `BELLDANDY_LOG_RETENTION_DAYS` çš„æ—¥å¿—æ–‡ä»¶
  - æ¸…ç†é€»è¾‘åœ¨åå°å¼‚æ­¥æ‰§è¡Œï¼Œä¸é˜»å¡å¯åŠ¨

**Agent æ—¥å¿—å·¥å…·**ï¼š

```typescript
// log_read - è¯»å–æŒ‡å®šæ—¥æœŸæˆ–æ—¶é—´èŒƒå›´çš„æ—¥å¿—
{
  name: "log_read",
  description: "è¯»å–ç³»ç»Ÿæ—¥å¿—ï¼Œç”¨äºåˆ†æä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ã€é”™è¯¯æ’æŸ¥å’Œæ€§èƒ½åˆ†æ",
  parameters: {
    date: "æ—¥æœŸ (YYYY-MM-DD)ï¼Œé»˜è®¤ä»Šå¤©",
    level: "è¿‡æ»¤çº§åˆ« (debug/info/warn/error)ï¼Œå¯é€‰",
    module: "è¿‡æ»¤æ¨¡å— (gateway/agent/tools/memory)ï¼Œå¯é€‰",
    keyword: "å…³é”®è¯è¿‡æ»¤ï¼Œå¯é€‰",
    tail: "åªè¿”å›æœ€å N è¡Œï¼Œé»˜è®¤ 100"
  }
}

// log_search - æœç´¢æ—¥å¿—ä¸­çš„é”™è¯¯æˆ–ç‰¹å®šäº‹ä»¶
{
  name: "log_search",
  description: "åœ¨æ—¥å¿—ä¸­æœç´¢é”™è¯¯ã€è­¦å‘Šæˆ–ç‰¹å®šå…³é”®è¯",
  parameters: {
    query: "æœç´¢å…³é”®è¯",
    startDate: "å¼€å§‹æ—¥æœŸ",
    endDate: "ç»“æŸæ—¥æœŸ",
    level: "æ—¥å¿—çº§åˆ«è¿‡æ»¤"
  }
}
```

**é›†æˆç‚¹**ï¼š

| æ¨¡å— | é›†æˆæ–¹å¼ |
|------|---------|
| `gateway.ts` | å¯åŠ¨æ—¶åˆå§‹åŒ– Loggerï¼Œæ›¿æ¢æ‰€æœ‰ `console.*` |
| `server.ts` | WebSocket è¿æ¥/æ–­å¼€/é”™è¯¯æ—¥å¿— |
| `tool-agent.ts` | å·¥å…·è°ƒç”¨å‰åè®°å½•ï¼ˆå«è€—æ—¶ï¼‰ |
| `heartbeat/runner.ts` | å¿ƒè·³æ‰§è¡Œè®°å½• |
| `memory/store.ts` | æŸ¥è¯¢æ€§èƒ½æ—¥å¿— |
| `mcp/client.ts` | MCP è¿æ¥ä¸å·¥å…·è°ƒç”¨æ—¥å¿— |

**éªŒæ”¶ç”¨ä¾‹**ï¼š

- [x] Gateway å¯åŠ¨åï¼Œ`~/.belldandy/logs/` ç›®å½•è‡ªåŠ¨åˆ›å»º
- [x] æ—¥å¿—åŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°å’Œæ–‡ä»¶
- [x] å·¥å…·è°ƒç”¨è®°å½•åŒ…å«è€—æ—¶ï¼š`[INFO] [tools] file_read completed in 23ms`
- [x] å•æ–‡ä»¶è¶…è¿‡é…ç½®é˜ˆå€¼æ—¶è‡ªåŠ¨è½®è½¬
- [x] å¯åŠ¨æ—¶è‡ªåŠ¨æ¸…ç†è¶…è¿‡ä¿ç•™å¤©æ•°çš„æ—¥å¿—
- [x] Agent å¯é€šè¿‡ `log_read` å·¥å…·è¯»å–æ—¥å¿—è¿›è¡Œè‡ªæˆ‘åˆ†æ
- [x] é…åˆæ–¹æ³•è®ºç³»ç»Ÿï¼ŒAgent èƒ½åˆ†ææ—¥å¿—å¹¶æ²‰æ·€ç»éªŒ

**ä¸æ–¹æ³•è®ºç³»ç»Ÿçš„ååŒ**ï¼š

æ—¥å¿—ç³»ç»Ÿæ˜¯æ–¹æ³•è®ºç³»ç»Ÿçš„æ•°æ®åŸºç¡€ï¼š
1. Agent æ‰§è¡Œä»»åŠ¡æ—¶ï¼Œè¯¦ç»†æ—¥å¿—è®°å½•æ¯ä¸€æ­¥æ“ä½œä¸è€—æ—¶
2. ä»»åŠ¡å¤±è´¥æ—¶ï¼ŒAgent å¯é€šè¿‡ `log_search` å®šä½é”™è¯¯
3. Agent åˆ†ææ—¥å¿—åï¼Œå¯è°ƒç”¨ `method_create` æ²‰æ·€ç»éªŒ
4. ä¸‹æ¬¡é‡åˆ°ç±»ä¼¼ä»»åŠ¡ï¼ŒAgent å…ˆæŸ¥é˜…æ–¹æ³•è®ºï¼Œé¿å…é‡å¤è¸©å‘

**ä»·å€¼**ï¼š
- **å¯è§‚æµ‹æ€§**ï¼šç³»ç»Ÿè¿è¡ŒçŠ¶æ€å®Œå…¨å¯è¿½æº¯
- **è‡ªæˆ‘è¿›åŒ–**ï¼šAgent èƒ½åŸºäºå†å²æ—¥å¿—å­¦ä¹ å’Œæ”¹è¿›
- **è¿ç»´å‹å¥½**ï¼šè‡ªåŠ¨è½®è½¬å’Œæ¸…ç†ï¼Œæ— éœ€äººå·¥å¹²é¢„
- **è°ƒè¯•åˆ©å™¨**ï¼šè¯¦ç»†æ—¥å¿—å¸®åŠ©å¿«é€Ÿå®šä½é—®é¢˜

### Phase 19ï¼šå®‰å…¨åŠ å›ºï¼ˆSecurity Hardeningï¼‰âœ… å·²å®Œæˆ

**ç›®æ ‡**ï¼šä¿®å¤å®‰å…¨è¯„ä¼°å‘ç°çš„ P0-P3 é£é™©ç‚¹ï¼Œç»¼åˆ OWASP æ¨èæ–¹æ¡ˆä¸ ws æœ€ä½³å®è·µã€‚

**å®Œæˆæ—¶é—´**ï¼š2026-02-08

#### 19.1 P0ï¼šé…å¯¹ç»•è¿‡é£é™©ï¼ˆCriticalï¼‰

| é—®é¢˜ | `workspace.read/list` æœªçº³å…¥ `secureMethods`ï¼Œå¯è¯»å– `allowlist.json` åä¼ªé€  `clientId` |
|------|------|
| ä¿®å¤æ–‡ä»¶ | `packages/belldandy-core/src/server.ts` |
| æ–¹æ¡ˆ | 1. å°† `workspace.read/list` åŠ å…¥ `secureMethods` æ•°ç»„<br>2. å¯¹ `allowlist.json/pairing.json/mcp.json/feishu-state.json` åšæ˜¾å¼æ‹’ç» |
| **çŠ¶æ€** | âœ… å·²å®ç°ï¼ˆL245, L507-512ï¼‰ |

#### 19.2 P1ï¼šCSWSH é˜²æŠ¤ï¼ˆHighï¼‰

| é—®é¢˜ | æœ¬æœºæµè§ˆå™¨æ¶æ„è„šæœ¬å¯è¿æ¥ `ws://127.0.0.1:28889` |
|------|------|
| ä¿®å¤æ–‡ä»¶ | `server.ts` + `gateway.ts` |
| æ–¹æ¡ˆ | 1. æ–°å¢ Origin Header ç™½åå•æ ¡éªŒï¼ˆOWASP æ¨èï¼‰<br>2. `HOST=0.0.0.0` + `AUTH_MODE=none` ç»„åˆå¼ºåˆ¶é€€å‡º |
| **çŠ¶æ€** | âœ… å·²å®ç°ï¼ˆserver.ts L84-112, gateway.ts L281-286ï¼‰ |

**æ–°å¢ç¯å¢ƒå˜é‡**ï¼š`BELLDANDY_ALLOWED_ORIGINS`ï¼ˆWebSocket Origin ç™½åå•ï¼Œé€—å·åˆ†éš”ï¼‰

#### 19.3 P1ï¼šé…ç½®æ³„éœ²ï¼ˆHighï¼‰

| é—®é¢˜ | `config.read` åŸæ ·è¿”å› API Keyï¼Œ`config.update` å¯å†™ä»»æ„é”® |
|------|------|
| ä¿®å¤æ–‡ä»¶ | `packages/belldandy-core/src/server.ts` |
| æ–¹æ¡ˆ | 1. `config.read` å¯¹ `*KEY*/SECRET/TOKEN/PASSWORD*` å­—æ®µè¿”å› `[REDACTED]`<br>2. `config.update` ä»…å…è®¸ä¿®æ”¹ç™½åå•å†…çš„é…ç½®é¡¹ |
| **çŠ¶æ€** | âœ… å·²å®ç°ï¼ˆL346-356, L363-376ï¼‰ |

#### 19.4 P2ï¼šMCP/å±é™©å·¥å…·æ”¶ç´§ï¼ˆMediumï¼‰

| é—®é¢˜ | `run_command/terminal` ä¸€æ—¦æ³¨å†Œå³ä¸º RCE é€šé“ |
|------|------|
| ä¿®å¤æ–‡ä»¶ | `packages/belldandy-core/src/bin/gateway.ts` |
| æ–¹æ¡ˆ | æ–°å¢ `BELLDANDY_DANGEROUS_TOOLS_ENABLED` ç¯å¢ƒå˜é‡ï¼Œé»˜è®¤ `false` |
| **çŠ¶æ€** | âœ… å·²å®ç°ï¼ˆL318-319, L330-331ï¼‰ |

#### 19.5 P2ï¼šSSRF é˜²æŠ¤å¢å¼ºï¼ˆMediumï¼‰

| é—®é¢˜ | æ•´æ•° IPï¼ˆ`http://2130706433/`ï¼‰å’Œ DNS Rebinding å¯ç»•è¿‡æ£€æŸ¥ |
|------|------|
| ä¿®å¤æ–‡ä»¶ | `packages/belldandy-skills/src/builtin/fetch.ts` |
| æ–¹æ¡ˆ | åœ¨å‘é€è¯·æ±‚å‰åš `dns.lookup` è§£æï¼Œå¯¹ç»“æœ IP å†æ¬¡æ ¡éªŒæ˜¯å¦ä¸ºå†…ç½‘ |
| **çŠ¶æ€** | âœ… å·²å®ç°ï¼ˆL2, L99-109, L215-231ï¼‰ |

#### 19.6 P3ï¼šæµè§ˆå™¨åŸŸåæ§åˆ¶ï¼ˆLowï¼‰

| é—®é¢˜ | `browser_open` å¯è®¿é—®ä»»æ„ URL |
|------|------|
| ä¿®å¤æ–‡ä»¶ | `packages/belldandy-skills/src/builtin/browser/tools.ts` |
| æ–¹æ¡ˆ | åŒæ¨¡å¼æ”¯æŒï¼š`BELLDANDY_BROWSER_ALLOWED_DOMAINS`ï¼ˆç™½åå•ï¼‰+ `BELLDANDY_BROWSER_DENIED_DOMAINS`ï¼ˆé»‘åå•ï¼Œä¼˜å…ˆçº§æ›´é«˜ï¼‰ |
| **çŠ¶æ€** | âœ… å·²å®ç°ï¼ˆL11-45, L168-174, L204-210ï¼‰ |

#### 19.7 æ–°å¢ç¯å¢ƒå˜é‡æ±‡æ€»

| å˜é‡ | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `BELLDANDY_ALLOWED_ORIGINS` | WebSocket Origin ç™½åå•ï¼ˆé€—å·åˆ†éš”ï¼‰ | æœ¬åœ°è‡ªåŠ¨å…è®¸ localhost |
| `BELLDANDY_DANGEROUS_TOOLS_ENABLED` | å¯ç”¨ run_command ç­‰å±é™©å·¥å…· | `false` |
| `BELLDANDY_BROWSER_ALLOWED_DOMAINS` | æµè§ˆå™¨ç™½åå•ï¼ˆç©º=ä¸é™åˆ¶ï¼‰ | ç©º |
| `BELLDANDY_BROWSER_DENIED_DOMAINS` | æµè§ˆå™¨é»‘åå•ï¼ˆä¼˜å…ˆäºç™½åå•ï¼‰ | ç©º |

#### 19.8 éªŒæ”¶ç”¨ä¾‹

- [x] `workspace.read('allowlist.json')` â†’ 403 Forbidden
- [x] `config.read` è¿”å› `BELLDANDY_OPENAI_API_KEY="[REDACTED]"`
- [x] `HOST=0.0.0.0` + `AUTH_MODE=none` å¯åŠ¨ â†’ è¿›ç¨‹é€€å‡º
- [x] æ¶æ„ç½‘é¡µ `new WebSocket('ws://127.0.0.1:28889')` â†’ Origin è¢«æ‹’ç»

**ç¯å¢ƒå˜é‡å·²æ›´æ–°åˆ° `.env.example`**

### Phase 20: WebChat UI å¢å¼º (WebChat UI Enhancements) [å·²å®Œæˆ]

**ç›®æ ‡**ï¼šæå‡ WebChat çš„å¯ç”¨æ€§ä¸äº¤äº’ä½“éªŒï¼Œå®ç° 4 ä¸ªå…³é”®åŠŸèƒ½ã€‚

**çŠ¶æ€**: âœ… å·²å®Œæˆ (2026-02-09)

#### 20.1 å¯æ“ä½œåŒºè®¾ç½® (Workspace Roots Config)

| é¡¹ç›® | å†…å®¹ |
|------|------|
| **éœ€æ±‚** | åœ¨ Auth åŒºåŸŸå·¦ä¾§æ–°å¢è¾“å…¥æ¡†ï¼Œå…è®¸ç”¨æˆ·é…ç½® `BELLDANDY_EXTRA_WORKSPACE_ROOTS` |
| **UI ä½ç½®** | `apps/web/public/index.html` - `.panel > .row` åŒºåŸŸ |
| **äº¤äº’** | è¾“å…¥æ ¼å¼ï¼š`E:/,D:/Game`ï¼ˆé€—å·åˆ†éš”ï¼‰ï¼Œä¿å­˜åˆ° localStorage å¹¶é€šè¿‡ `config.update` åŒæ­¥ |
| **åç«¯** | éœ€å°† `BELLDANDY_EXTRA_WORKSPACE_ROOTS` åŠ å…¥ `server.ts` çš„ `SAFE_UPDATE_KEYS` ç™½åå• |

**å®ç°æ­¥éª¤**ï¼š
1. [ ] ä¿®æ”¹ `index.html`ï¼šåœ¨ Auth å·¦ä¾§æ·»åŠ è¾“å…¥ç»„ï¼ˆæ ‡é¢˜ï¼š"å¯æ“ä½œåŒºè®¾ç½®"ï¼Œè¯´æ˜å°å­—ï¼‰
2. [ ] ä¿®æ”¹ `styles.css`ï¼šè°ƒæ•´ `.row` å¸ƒå±€ï¼Œå‹ç¼© Auth åŒºåŸŸå®½åº¦
3. [ ] ä¿®æ”¹ `app.js`ï¼šæ·»åŠ  `workspaceRoots` è¾“å…¥æ¡†çš„è¯»å†™é€»è¾‘
4. [ ] ä¿®æ”¹ `server.ts`ï¼šå°† `BELLDANDY_EXTRA_WORKSPACE_ROOTS` åŠ å…¥ç™½åå•

---

#### 20.2 é…ç½®æŒ‰é’® (.env ç¼–è¾‘å™¨)

| é¡¹ç›® | å†…å®¹ |
|------|------|
| **éœ€æ±‚** | åœ¨"æ™ºèƒ½ä½“è®¾ç½®"ä¸‹æ–¹æ–°å¢"é…ç½®"æŒ‰é’®ï¼Œç‚¹å‡»ååœ¨ä¸»åŒºåŸŸæ‰“å¼€ `.env` æ–‡ä»¶è¿›è¡Œç¼–è¾‘ |
| **UI ä½ç½®** | `apps/web/public/index.html` - ä¾§è¾¹æ åŒºåŸŸ |
| **äº¤äº’** | å¤ç”¨ç°æœ‰ç¼–è¾‘å™¨æ¨¡å¼ï¼ˆ`switchMode('editor')`ï¼‰ï¼Œæ”¯æŒä¿å­˜/å–æ¶ˆ |
| **åç«¯** | ä½¿ç”¨ç°æœ‰ `workspace.read` / `workspace.write` æ¥å£è¯»å†™ `.env` æ–‡ä»¶ |

**å®ç°æ­¥éª¤**ï¼š
1. [ ] ä¿®æ”¹ `index.html`ï¼šåœ¨ä¾§è¾¹æ æ·»åŠ "é…ç½®"æŒ‰é’®
2. [ ] ä¿®æ”¹ `styles.css`ï¼šæ·»åŠ æŒ‰é’®æ ·å¼ï¼ˆä¸"æ™ºèƒ½ä½“è®¾ç½®"ä¸€è‡´ï¼‰
3. [ ] ä¿®æ”¹ `app.js`ï¼šæ·»åŠ ç‚¹å‡»äº‹ä»¶å¤„ç†ï¼Œè¯»å– `.env` å¹¶æ‰“å¼€ç¼–è¾‘å™¨
4. [ ] è€ƒè™‘å®‰å…¨ï¼š`.env` æ–‡ä»¶å·²è¢« `workspace.read` çš„é»‘åå•ä¿æŠ¤ï¼Œéœ€è¯„ä¼°æ˜¯å¦å¼€æ”¾æˆ–ä½¿ç”¨ä¸“ç”¨æ¥å£

> âš ï¸ **å®‰å…¨æ³¨æ„**ï¼šå½“å‰ `.env` åœ¨ Phase 19 çš„å®‰å…¨åŠ å›ºä¸­è¢«åˆ—å…¥é»‘åå•ã€‚éœ€è¦å†³å®šï¼š
> - æ–¹æ¡ˆ Aï¼šä½¿ç”¨ä¸“ç”¨ `config.readRaw` / `config.writeRaw` æ¥å£ï¼ˆä»…é™å·²è®¤è¯å®¢æˆ·ç«¯ï¼‰
> - æ–¹æ¡ˆ Bï¼šå°† `.env` ä»é»‘åå•ç§»é™¤ï¼Œä¾èµ– `secureMethods` ä¿æŠ¤

---

#### 20.3 æ¶ˆæ¯è‡ªåŠ¨æ»šåŠ¨ (Auto-Scroll)

| é¡¹ç›® | å†…å®¹ |
|------|------|
| **éœ€æ±‚** | æ¶ˆæ¯æ›´æ–°æ—¶è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨ï¼›ç”¨æˆ·æ‰‹åŠ¨æ»šåŠ¨æŸ¥çœ‹å†å²æ—¶ä¸æ‰“æ–­ |
| **UI ä½ç½®** | `apps/web/public/app.js` - `appendMessage` / `handleEvent` å‡½æ•° |
| **äº¤äº’** | æ™ºèƒ½æ£€æµ‹ï¼šè‹¥ç”¨æˆ·æ»šåŠ¨æ¡è·ç¦»åº•éƒ¨ < 100pxï¼Œåˆ™æ–°æ¶ˆæ¯æ—¶è‡ªåŠ¨æ»šåŠ¨ï¼›å¦åˆ™ä¸æ‰“æ–­ |

**å®ç°æ­¥éª¤**ï¼š
1. [ ] ä¿®æ”¹ `app.js`ï¼šåœ¨ `appendMessage` ä¸­æ·»åŠ æ™ºèƒ½æ»šåŠ¨é€»è¾‘
2. [ ] æ·»åŠ  `isNearBottom()` è¾…åŠ©å‡½æ•°æ£€æµ‹æ»šåŠ¨ä½ç½®
3. [ ] åœ¨ `chat.delta` äº‹ä»¶å¤„ç†ä¸­ä¹Ÿè§¦å‘æ»šåŠ¨æ£€æµ‹

**ä»£ç ç¤ºä¾‹**ï¼š
```javascript
function isNearBottom(el, threshold = 100) {
  return el.scrollHeight - el.scrollTop - el.clientHeight < threshold;
}

function scrollToBottomIfNeeded() {
  if (isNearBottom(messagesEl)) {
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }
}
```

---

#### 20.4 æ–‡ä»¶é™„ä»¶æ”¯æŒ (File Attachment)

| é¡¹ç›® | å†…å®¹ |
|------|------|
| **éœ€æ±‚** | æ”¯æŒåœ¨è¾“å…¥æ¡†æ·»åŠ æ–‡ä»¶ï¼ˆæ‹–å…¥ + ç‚¹å‡»é€‰æ‹©ï¼‰ï¼Œå‘é€æ—¶åŒ…å«æ–‡ä»¶å†…å®¹ |
| **æ”¯æŒæ ¼å¼** | å›¾ç‰‡ï¼š`jpg, png, gif`ï¼›æ–‡æœ¬ï¼š`txt, md, json, log` |
| **UI ä½ç½®** | `apps/web/public/index.html` - `.composer` åŒºåŸŸ |
| **äº¤äº’** | 1. æ‹–æ‹½åŒºåŸŸé«˜äº® 2. `+` æŒ‰é’®æ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨ 3. é¢„è§ˆå·²æ·»åŠ æ–‡ä»¶ 4. å‘é€æ—¶ç¼–ç å¹¶é™„åŠ  |

**å®ç°æ­¥éª¤**ï¼š
1. [ ] ä¿®æ”¹ `index.html`ï¼šåœ¨ `.composer` æ·»åŠ  `+` æŒ‰é’®å’Œéšè—çš„ `<input type="file">`
2. [ ] ä¿®æ”¹ `styles.css`ï¼šæ·»åŠ æ‹–æ‹½é«˜äº®ã€æ–‡ä»¶é¢„è§ˆç¼©ç•¥å›¾æ ·å¼
3. [ ] ä¿®æ”¹ `app.js`ï¼š
   - æ·»åŠ  `dragover/drop` äº‹ä»¶å¤„ç†
   - æ·»åŠ æ–‡ä»¶é€‰æ‹©å™¨è§¦å‘é€»è¾‘
   - æ·»åŠ æ–‡ä»¶é¢„è§ˆåˆ—è¡¨æ¸²æŸ“
   - ä¿®æ”¹ `sendMessage` ä»¥åŒ…å«é™„ä»¶æ•°æ®ï¼ˆBase64 æˆ– DataURLï¼‰
4. [ ] ä¿®æ”¹åç«¯ `message.send` å¤„ç†ï¼šè§£æé™„ä»¶å¹¶ä¼ é€’ç»™ Agentï¼ˆå¯èƒ½éœ€è¦è°ƒæ•´ `params` ç»“æ„ï¼‰

**é™„ä»¶æ•°æ®ç»“æ„**ï¼š
```typescript
interface Attachment {
  name: string;
  type: 'image' | 'text';
  mimeType: string;
  content: string; // Base64 for images, raw text for text files
}
```

---

#### 20.5 å®æ–½ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | åŠŸèƒ½ | å¤æ‚åº¦ | åŸå›  |
|--------|------|--------|------|
| P1 | 20.3 æ¶ˆæ¯è‡ªåŠ¨æ»šåŠ¨ | ä½ | çº¯å‰ç«¯ï¼Œæ— åç«¯æ”¹åŠ¨ï¼Œä½“éªŒæå‡æ˜æ˜¾ |
| P2 | 20.1 å¯æ“ä½œåŒºè®¾ç½® | ä¸­ | éœ€è¦å‰åç«¯é…åˆï¼Œä½†é€»è¾‘æ¸…æ™° |
| P3 | 20.2 é…ç½®æŒ‰é’® | ä¸­ | éœ€è¦è¯„ä¼°å®‰å…¨ç­–ç•¥ï¼Œå¯èƒ½éœ€è¦æ–°æ¥å£ |
| P4 | 20.4 æ–‡ä»¶é™„ä»¶ | é«˜ | æ¶‰åŠæ–‡ä»¶å¤„ç†ã€é¢„è§ˆã€åç«¯ä¼ è¾“ |

### Phase 21: æœåŠ¡é‡å¯å·¥å…· (Service Restart Tool) [å·²å®Œæˆ]

**ç›®æ ‡**ï¼šè®© Agent èƒ½å¤Ÿé€šè¿‡å·¥å…·è°ƒç”¨ä¸»åŠ¨é‡å¯ Gateway æœåŠ¡ï¼Œé…åˆ 3 ç§’å€’è®¡æ—¶å¹¿æ’­é€šçŸ¥æ‰€æœ‰å®¢æˆ·ç«¯ã€‚

**çŠ¶æ€**: âœ… å·²å®Œæˆ (2026-02-11)

#### 21.1 å®ç°å†…å®¹

| Step | å†…å®¹ | çŠ¶æ€ |
|------|------|------|
| 1 | `service_restart` å·¥å…·å®ç°ï¼ˆ3 ç§’å€’è®¡æ—¶ + `process.exit(100)`ï¼‰ | âœ… å·²å®Œæˆ |
| 2 | ä» `@belldandy/skills` å¯¼å‡º `createServiceRestartTool` | âœ… å·²å®Œæˆ |
| 3 | Gateway æ³¨å†Œå·¥å…· + å»¶è¿Ÿç»‘å®š `server.broadcast` | âœ… å·²å®Œæˆ |
| 4 | WebChat å€’è®¡æ—¶æµ®å±‚ï¼ˆ`#restartOverlay`ï¼‰ | âœ… å·²å®Œæˆ |
| 5 | é‡è¿æˆåŠŸåè‡ªåŠ¨éšè—æµ®å±‚ | âœ… å·²å®Œæˆ |

#### 21.2 æ–‡ä»¶ç»“æ„

```
packages/belldandy-skills/src/
â”œâ”€â”€ builtin/
â”‚   â””â”€â”€ service-restart.ts    # [NEW] service_restart å·¥å…·
â””â”€â”€ index.ts                  # [MODIFIED] å¯¼å‡º createServiceRestartTool

packages/belldandy-core/src/bin/
â””â”€â”€ gateway.ts                # [MODIFIED] æ³¨å†Œå·¥å…· + å»¶è¿Ÿç»‘å®š broadcast

apps/web/public/
â”œâ”€â”€ index.html                # [MODIFIED] æ–°å¢ #restartOverlay DOM
â”œâ”€â”€ styles.css                # [MODIFIED] å€’è®¡æ—¶æµ®å±‚æ ·å¼
â””â”€â”€ app.js                    # [MODIFIED] å¤„ç† agent.status å€’è®¡æ—¶äº‹ä»¶
```

#### 21.3 å·¥ä½œæœºåˆ¶

1. Agent è°ƒç”¨ `service_restart({ reason: "é…ç½®å·²æ›´æ–°" })`
2. å·¥å…·å¼€å§‹ 3 ç§’å€’è®¡æ—¶ï¼Œæ¯ç§’å¹¿æ’­ `agent.status` äº‹ä»¶ï¼ˆ`countdown: 3 â†’ 2 â†’ 1 â†’ 0`ï¼‰
3. WebChat æ”¶åˆ°äº‹ä»¶åæ˜¾ç¤ºå…¨å±å€’è®¡æ—¶æµ®å±‚ï¼ˆæ¯›ç»ç’ƒèƒŒæ™¯ + æ—‹è½¬å›¾æ ‡ + å¤§å·æ•°å­—ï¼‰
4. å€’è®¡æ—¶ç»“æŸå `process.exit(100)`ï¼Œlauncher è‡ªåŠ¨é‡å¯ Gateway
5. WebChat è‡ªåŠ¨é‡è¿ï¼Œæ”¶åˆ° `hello-ok` åéšè—æµ®å±‚

#### 21.4 éªŒæ”¶ç”¨ä¾‹

- [x] ç¼–è¯‘é€šè¿‡ (`pnpm build`)
- [x] Agent è°ƒç”¨ `service_restart` åï¼ŒWebChat æ˜¾ç¤º 3 ç§’å€’è®¡æ—¶
- [x] å€’è®¡æ—¶ç»“æŸåæœåŠ¡è‡ªåŠ¨é‡å¯
- [x] é‡è¿æˆåŠŸåæµ®å±‚è‡ªåŠ¨æ¶ˆå¤±

### Phase 22: FACET æ¨¡ç»„åˆ‡æ¢å·¥å…· (switch_facet) [å·²å®Œæˆ]

**ç›®æ ‡**ï¼šå°† SOUL.md ä¸­ FACET æ¨¡ç»„çš„æ‰‹åŠ¨è¯»å†™åˆ‡æ¢æµç¨‹è‡ªåŠ¨åŒ–ä¸ºåŸå­åŒ–å·¥å…·è°ƒç”¨ï¼Œé™ä½ Token æ¶ˆè€—å’Œå‡ºé”™é£é™©ã€‚

**çŠ¶æ€**: âœ… å·²å®Œæˆ (2026-02-11)

#### 22.1 å®ç°å†…å®¹

| Step | å†…å®¹ | çŠ¶æ€ |
|------|------|------|
| 1 | `switch_facet` å·¥å…·å®ç°ï¼ˆé”šç‚¹å®šä½ + å†…å®¹æ›¿æ¢ + åŸå­å†™å…¥ï¼‰ | âœ… å·²å®Œæˆ |
| 2 | ä» `@belldandy/skills` å¯¼å‡º `switchFacetTool` | âœ… å·²å®Œæˆ |
| 3 | Gateway æ³¨å†Œå·¥å…· | âœ… å·²å®Œæˆ |
| 4 | SOUL.md æç¤ºè¯ç²¾ç®€ï¼ˆ6 æ­¥æ‰‹åŠ¨ â†’ 5 æ­¥å·¥å…·è°ƒç”¨ï¼‰ | âœ… å·²å®Œæˆ |

#### 22.2 æ–‡ä»¶ç»“æ„

```
packages/belldandy-skills/src/
â”œâ”€â”€ builtin/
â”‚   â””â”€â”€ switch-facet.ts       # [NEW] switch_facet å·¥å…·
â””â”€â”€ index.ts                  # [MODIFIED] å¯¼å‡º switchFacetTool

packages/belldandy-core/src/bin/
â””â”€â”€ gateway.ts                # [MODIFIED] å¯¼å…¥å¹¶æ³¨å†Œ switchFacetTool

packages/belldandy-agent/src/templates/
â””â”€â”€ SOUL.md                   # [MODIFIED] ç²¾ç®€ FACET åˆ‡æ¢åè®®
```

#### 22.3 å·¥ä½œæœºåˆ¶

1. Agent è°ƒç”¨ `switch_facet({ facet_name: "coder" })`
2. å·¥å…·è¯»å– `~/.belldandy/SOUL.md`ï¼Œå®šä½é”šç‚¹è¡Œ
3. ä¿ç•™é”šç‚¹è¡Œï¼ˆå«ï¼‰åŠä¹‹å‰çš„æ‰€æœ‰å†…å®¹
4. è¯»å– `~/.belldandy/facets/coder.md` å†…å®¹ï¼Œè¿½åŠ åˆ°é”šç‚¹è¡Œä¹‹å
5. åŸå­å†™å…¥ï¼šå…ˆå†™ `SOUL.md.tmp`ï¼ŒæˆåŠŸå `fs.rename` è¦†ç›–
6. è¿”å›æˆåŠŸä¿¡æ¯ï¼ŒAgent éšåè°ƒç”¨ `service_restart` é‡å¯æœåŠ¡

#### 22.4 å®‰å…¨æªæ–½

- **è·¯å¾„ç©¿è¶Šé˜²æŠ¤**ï¼šæ‹’ç»åŒ…å« `/`ã€`\`ã€`..` çš„ facet_name
- **åŸå­å†™å…¥**ï¼šé€šè¿‡ tmp æ–‡ä»¶ + rename ä¿è¯ SOUL.md ä¸ä¼šå› ä¸­é€”å¤±è´¥è€ŒæŸå
- **å‹å¥½é”™è¯¯**ï¼šæ¨¡ç»„ä¸å­˜åœ¨æ—¶åˆ—å‡ºæ‰€æœ‰å¯ç”¨æ¨¡ç»„åç§°
- **é”šç‚¹æ ¡éªŒ**ï¼šæœªæ‰¾åˆ°é”šç‚¹æ—¶æŠ¥é”™ï¼Œä¸ä¿®æ”¹æ–‡ä»¶

#### 22.5 éªŒæ”¶ç”¨ä¾‹

- [x] ç¼–è¯‘é€šè¿‡ (`pnpm build`)
- [x] ä¼ å…¥æœ‰æ•ˆ facet_name æ—¶ï¼ŒSOUL.md é”šç‚¹è¡Œä¹‹å‰å†…å®¹ä¸å˜ï¼Œä¹‹åæ›¿æ¢ä¸ºç›®æ ‡æ¨¡ç»„å†…å®¹
- [x] ä¼ å…¥ä¸å­˜åœ¨çš„ facet_name æ—¶ï¼Œè¿”å›é”™è¯¯å¹¶åˆ—å‡ºå¯ç”¨æ¨¡ç»„
- [x] ä¼ å…¥å«è·¯å¾„ç©¿è¶Šå­—ç¬¦çš„ facet_name æ—¶ï¼Œè¿”å›é”™è¯¯

---

### Phase 23ï¼šä¸Šä¸‹æ–‡è‡ªåŠ¨å‹ç¼© (Context Compaction) âœ… å·²å®Œæˆ

**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ (2026-02-13)

**ç›®æ ‡**ï¼šè§£å†³é•¿æ—¶é—´å¯¹è¯å’Œè‡ªåŠ¨åŒ–ä»»åŠ¡ä¸­ä¸Šä¸‹æ–‡çª—å£æº¢å‡ºé—®é¢˜ï¼Œå®ç°è¯­ä¹‰çº§å‹ç¼©è€Œéæœºæ¢°æˆªæ–­ã€‚

#### 23.1 é—®é¢˜èƒŒæ™¯

åŸæœ‰ç³»ç»Ÿå­˜åœ¨ä¸‰å±‚ä¸Šä¸‹æ–‡æ§åˆ¶ï¼Œä½†å‡ä¸ºæ— è¯­ä¹‰çš„æœºæ¢°æ“ä½œï¼š
- `maxHistory`ï¼ˆ50 æ¡ï¼‰ï¼šç¡¬æˆªæ–­æ—§æ¶ˆæ¯ï¼Œä¸¢å¤±è¯­ä¹‰
- `compaction.ts`ï¼štoken é˜ˆå€¼è§¦å‘ï¼Œä½†ä»…åšæ–‡æœ¬æˆªæ–­ï¼ˆæ¯æ¡å–å‰ 200 å­—ç¬¦ï¼‰ï¼Œ`summarizer` å‚æ•°ä»æœªè¢«æ³¨å…¥
- `trimMessagesToFit`ï¼šå‘é€å‰æš´åŠ›è£å‰ªï¼Œç›´æ¥åˆ æ¶ˆæ¯

é•¿æ—¶é—´è‡ªåŠ¨åŒ–ä»»åŠ¡ï¼ˆå¿ƒè·³ã€Cronã€å¤æ‚å·¥å…·é“¾ï¼‰ä¼šå¯¼è‡´ä¸Šä¸‹æ–‡å¿«é€Ÿè†¨èƒ€ï¼Œè§¦å‘æš´åŠ›è£å‰ªåä¸¢å¤±å…³é”®å†³ç­–å’Œæ“ä½œç»“æœã€‚

#### 23.2 æ–¹æ¡ˆè®¾è®¡

ä¸‰å±‚æ¸è¿›å¼å‹ç¼©æ¶æ„ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Tier 0: System Promptï¼ˆå›ºå®šï¼Œä¸å‹ç¼©ï¼‰       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Tier 1: Archival Summaryï¼ˆå½’æ¡£æ‘˜è¦ï¼‰        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Tier 2: Rolling Summaryï¼ˆæ»šåŠ¨æ‘˜è¦ï¼‰         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Tier 3: Working Memoryï¼ˆæœ€è¿‘ N æ¡å®Œæ•´æ¶ˆæ¯ï¼‰ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- **Working Memory**ï¼šä¿ç•™æœ€è¿‘ N æ¡æ¶ˆæ¯å®Œæ•´å†…å®¹ï¼ˆé»˜è®¤ 10ï¼‰
- **Rolling Summary**ï¼šæº¢å‡ºæ¶ˆæ¯ç”±æ¨¡å‹å¢é‡åˆå…¥æ‘˜è¦ï¼Œä¸ä»å¤´é‡æ–°ç”Ÿæˆ
- **Archival Summary**ï¼šRolling Summary è¶…è¿‡é˜ˆå€¼æ—¶è¿›ä¸€æ­¥æµ“ç¼©ä¸ºè¶…ç®€æ´ç‰ˆæœ¬

åŒè§¦å‘ç‚¹ï¼š
1. **è¯·æ±‚å‰**ï¼š`getHistoryCompacted()` åŸºäº token é˜ˆå€¼åˆ¤æ–­
2. **ReAct å¾ªç¯å†…**ï¼šæ¯æ¬¡ `callModel` å‰æ£€æŸ¥ä¸Šä¸‹æ–‡ä½¿ç”¨æ¯”ä¾‹ï¼ˆé»˜è®¤ 75%ï¼‰

#### 23.3 æ”¹åŠ¨æ–‡ä»¶

```
packages/belldandy-agent/src/
â”œâ”€â”€ compaction.ts          # [REWRITE] ä¸‰å±‚çŠ¶æ€ã€å¢é‡å‹ç¼©ã€å·¥å…·ç»“æœé¢„å‹ç¼©ã€æ‘˜è¦ Promptã€å…¼å®¹æ—§ API
â”œâ”€â”€ conversation.ts        # [MODIFIED] CompactionState æŒä¹…åŒ–ã€å¢é‡ getHistoryCompacted()ã€hook å›è°ƒ
â”œâ”€â”€ tool-agent.ts          # [MODIFIED] ReAct å¾ªç¯å†…å‹ç¼©æ£€æŸ¥ç‚¹ã€compactInLoop æ–¹æ³•
â”œâ”€â”€ hooks.ts               # [MODIFIED] BeforeCompactionEvent/AfterCompactionEvent å¢åŠ  tier/source å­—æ®µ
â””â”€â”€ index.ts               # [MODIFIED] å¯¼å‡ºæ–°å¢ç±»å‹

packages/belldandy-core/src/bin/
â””â”€â”€ gateway.ts             # [MODIFIED] æ³¨å…¥ summarizer å‡½æ•°ã€æ–°å¢ç¯å¢ƒå˜é‡

.env                       # [MODIFIED] æ–°å¢å‹ç¼©ç›¸å…³é…ç½®é¡¹
.env.example               # [MODIFIED] æ–°å¢å‹ç¼©ç›¸å…³é…ç½®é¡¹
```

#### 23.4 æ–°å¢ç¯å¢ƒå˜é‡

| å˜é‡ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `BELLDANDY_COMPACTION_ENABLED` | `true` | æ€»å¼€å…³ |
| `BELLDANDY_COMPACTION_THRESHOLD` | `12000` | è§¦å‘å‹ç¼©çš„ token é˜ˆå€¼ |
| `BELLDANDY_COMPACTION_KEEP_RECENT` | `10` | ä¿ç•™æœ€è¿‘æ¶ˆæ¯æ¡æ•°ï¼ˆåŸé»˜è®¤ 6ï¼Œè°ƒæ•´ä¸º 10ï¼‰ |
| `BELLDANDY_COMPACTION_TRIGGER_FRACTION` | `0.75` | ReAct å¾ªç¯å†…è§¦å‘æ¯”ä¾‹ |
| `BELLDANDY_COMPACTION_ARCHIVAL_THRESHOLD` | `2000` | Rolling Summary å½’æ¡£é˜ˆå€¼ |
| `BELLDANDY_COMPACTION_MODEL` | ï¼ˆç©ºï¼‰ | æ‘˜è¦ä¸“ç”¨æ¨¡å‹ï¼Œä¸è®¾åˆ™å¤ç”¨ä¸»æ¨¡å‹ |
| `BELLDANDY_COMPACTION_BASE_URL` | ï¼ˆç©ºï¼‰ | æ‘˜è¦ä¸“ç”¨ API åœ°å€ï¼Œä¸è®¾åˆ™å¤ç”¨ä¸»æ¨¡å‹ |
| `BELLDANDY_COMPACTION_API_KEY` | ï¼ˆç©ºï¼‰ | æ‘˜è¦ä¸“ç”¨ API å¯†é’¥ï¼Œä¸è®¾åˆ™å¤ç”¨ä¸»æ¨¡å‹ |

#### 23.5 é™çº§ç­–ç•¥

1. æ¨¡å‹æ‘˜è¦å¯ç”¨ â†’ é«˜è´¨é‡è¯­ä¹‰æ‘˜è¦
2. æ¨¡å‹ä¸å¯ç”¨/è¶…æ—¶ â†’ æ–‡æœ¬æˆªæ–­æ‘˜è¦ï¼ˆ`buildFallbackSummary`ï¼‰
3. å‹ç¼©æœ¬èº«å¤±è´¥ â†’ `trimMessagesToFit` æš´åŠ›è£å‰ªï¼ˆæœ€åé˜²çº¿ï¼‰

#### 23.6 éªŒæ”¶ç”¨ä¾‹

- [x] ç¼–è¯‘é€šè¿‡ (`pnpm build`)
- [x] `compactIncremental` åœ¨ token è¶…è¿‡é˜ˆå€¼æ—¶æ­£ç¡®åˆ†å‰²æ¶ˆæ¯å¹¶ç”Ÿæˆæ‘˜è¦
- [x] `CompactionState` æŒä¹…åŒ–åˆ° `.compaction.json` å¹¶å¯æ¢å¤
- [x] ReAct å¾ªç¯å†…å‹ç¼©æ£€æŸ¥ç‚¹åœ¨ä¸Šä¸‹æ–‡ä½¿ç”¨æ¯”ä¾‹è¶…è¿‡é˜ˆå€¼æ—¶è§¦å‘
- [x] Summarizer æ”¯æŒç‹¬ç«‹é…ç½® BASE_URL / API_KEY / MODEL
- [x] æ¨¡å‹ä¸å¯ç”¨æ—¶é™çº§ä¸ºæ–‡æœ¬æˆªæ–­æ‘˜è¦
- [x] `before_compaction` / `after_compaction` é’©å­æ­£ç¡®è§¦å‘å¹¶æºå¸¦ tier/source ä¿¡æ¯
- [x] ç¯å¢ƒå˜é‡å·²æ›´æ–°åˆ° `.env`ã€`.env.example`
- [x] ä½¿ç”¨æ‰‹å†Œå·²æ›´æ–°ï¼ˆ3.5 å¯¹è¯å‹ç¼©ç« èŠ‚ï¼‰
- [x] å®ç°å†…å®¹è¯´æ˜å·²æ›´æ–°ï¼ˆç¬¬ 16 èŠ‚ï¼‰

