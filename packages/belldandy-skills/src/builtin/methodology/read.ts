import type { Tool, JsonObject, ToolContext } from "../../types.js";
import { promises as fs } from "fs";
import * as path from "path";
import { getMethodsDir } from "./list.js";

export const methodReadTool: Tool = {
    definition: {
        name: "method_read",
        description: "读取指定的方法论文档内容。当通过 method_list 发现相关方法后，使用此工具读取详细步骤。",
        parameters: {
            type: "object",
            properties: {
                filename: {
                    type: "string",
                    description: "方法文件名 (例如: 'Cron-create.md')"
                }
            },
            required: ["filename"]
        }
    },
    execute: async (args: JsonObject, _context: ToolContext) => {
        const filename = args.filename as string;
        if (!filename) {
            return {
                id: "error",
                name: "method_read",
                success: false,
                output: "缺少参数: filename",
                error: "Missing filename",
                durationMs: 0
            };
        }

        const methodsDir = getMethodsDir();
        const filePath = path.join(methodsDir, filename);

        // 安全检查：防止路径遍历
        if (!filePath.startsWith(methodsDir)) {
            return {
                id: "error",
                name: "method_read",
                success: false,
                output: "非法的路径访问。",
                error: "Path traversal detected",
                durationMs: 0
            };
        }

        try {
            const content = await fs.readFile(filePath, "utf-8");
            return {
                id: "method_read",
                name: "method_read",
                success: true,
                output: content,
                durationMs: 0
            };
        } catch (error) {
            const err = error as Error;
            return {
                id: "error",
                name: "method_read",
                success: false,
                output: `无法读取方法文件 '${filename}': ${err.message}`,
                error: err.message,
                durationMs: 0
            };
        }
    }
};
