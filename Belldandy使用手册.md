# Belldandy 使用手册

Belldandy 是一个运行在你本地电脑上的个人 AI 助手。它注重隐私、安全，并具备记忆与工具使用能力。

本手册将指引你完成安装、配置、启动以及日常使用。

---

## 1. 环境准备

在开始之前，请确保你的电脑满足以下要求：

- **操作系统**：Windows, macOS, 或 Linux
- **Node.js**：版本 **22.12.0** 或更高（推荐使用 LTS 版本）
    - [下载 Node.js](https://nodejs.org/)
- **包管理器**：推荐使用 `pnpm`（本项目已启用 corepack，可自动管理版本）

## 2. 安装步骤

1.  **获取代码**
    将项目代码下载到你的本地目录（例如 `Belldandy/`）。

2.  **安装依赖**
    在项目根目录下打开终端（Terminal 或 PowerShell），运行：

    ```bash
    cd Belldandy
    corepack pnpm install
    ```

    这就完成了所有的安装工作。

## 3. 配置指南

Belldandy 使用 **环境变量** 进行配置。为了方便管理，推荐在项目根目录创建一个名为 `.env.local` 的文件（Git 会自动忽略它，保护你的隐私）。

### 3.1 基础配置（必选）

决定你使用什么 AI 模型服务。

**方案 A：使用 OpenAI 协议兼容服务（推荐）**
如果你有 OpenAI、Gemini、DeepSeek 或本地 LLM（如 Ollama）的 API Key。

在 `.env.local` 中添加：

```env
# 启用 OpenAI 协议 Provider
BELLDANDY_AGENT_PROVIDER=openai

# API 服务地址 (例如 Gemini)
BELLDANDY_OPENAI_BASE_URL=https://generativelanguage.googleapis.com/v1beta/openai
# 或者本地 Ollama
# BELLDANDY_OPENAI_BASE_URL=http://127.0.0.1:11434/v1

# 你的 API Key
BELLDANDY_OPENAI_API_KEY=sk-proj-xxxxxxxxxxxxxxxx

# 模型名称
BELLDANDY_OPENAI_MODEL=gemini-2.0-flash-exp
# 或者本地模型
# BELLDANDY_OPENAI_MODEL=llama3
BELLDANDY_OPENAI_MODEL=gemini-2.0-flash-exp
# 或者本地模型
# BELLDANDY_OPENAI_MODEL=llama3
```

> **✨ 也可以在网页界面设置！**
>  Phase 2.5 版本新增了可视化配置面板。你只需要先运行起来（哪怕 Key 是空的），然后在网页右上角点击设置图标（⚙️）即可修改这些配置。
>  修改后系统会自动重启生效。如果使用此方式，可以跳过手动编辑 `.env.local`。

**方案 B：使用 Mock 模式（测试用）**
如果你只是想跑通流程，不消耗 Token。

```env
BELLDANDY_AGENT_PROVIDER=mock
```

# Gateway 服务端口（默认 28889）
BELLDANDY_PORT=28889

# 鉴权模式：none (默认) | token | password
# 注意：即使是 none，新设备连接也需要 Pairing 配对
BELLDANDY_AUTH_MODE=none
# BELLDANDY_AUTH_TOKEN=my-secret-token

# ------ AI 能力开关 ------
# 启用工具调用（联网、读写文件）
BELLDANDY_TOOLS_ENABLED=true

# 启用记忆检索（向量搜索）
BELLDANDY_EMBEDDING_ENABLED=true
# 向量模型配置（通常与 Chat 模型用同一家服务）
BELLDANDY_EMBEDDING_MODEL=text-embedding-004

# ------ 心跳定时任务 ------
# 启用心跳（Agent 定期检查 HEARTBEAT.md 并主动联系你）
BELLDANDY_HEARTBEAT_ENABLED=true
# 心跳间隔（支持 30m, 1h, 300s 格式）
BELLDANDY_HEARTBEAT_INTERVAL=30m
# 活跃时段（可选，深夜不打扰）
BELLDANDY_HEARTBEAT_ACTIVE_HOURS=08:00-23:00

# ------ 定时任务 (Cron) ------
# 启用 Cron 调度引擎（Agent cron 工具始终可用，此开关仅控制自动执行）
# BELLDANDY_CRON_ENABLED=true

# ------ 日志系统 ------
# 最低日志级别 (debug/info/warn/error)
BELLDANDY_LOG_LEVEL=debug
# 日志目录，默认 ~/.belldandy/logs
# BELLDANDY_LOG_DIR=~/.belldandy/logs
# 单文件最大大小，超过则轮转 (如 10MB)
# BELLDANDY_LOG_MAX_SIZE=10MB
# 日志保留天数，超过自动清理
# BELLDANDY_LOG_RETENTION_DAYS=7
# 是否输出到控制台 / 是否写入文件
# BELLDANDY_LOG_CONSOLE=true
# BELLDANDY_LOG_FILE=true
```

### 3.3 工具权限与策略

Belldandy 的工具系统默认处于 **Safe Mode**，并可通过策略文件进行精细化控制：

- **文件读写范围**：默认只允许工作区内读写，敏感文件（如 `.env` / `SOUL.md`）受保护。
- **`file_write` 能力**：支持 `overwrite/append/replace/insert`，可按行号或正则替换；默认自动创建目录；在非 Windows 下写入 `.sh` 会自动 `chmod +x`。
- **多工作区**：可通过 `BELLDANDY_EXTRA_WORKSPACE_ROOTS` 追加可读写根目录，实现跨项目协作。
- **系统命令**：白名单执行 + 非交互参数注入 + 快速/构建命令分级超时（5s/300s）+ 超时强制 kill；危险参数（如 `rm -r/-rf`、`del /s /q`）会被拦截。
- **策略覆盖**：通过 `BELLDANDY_TOOLS_POLICY_FILE` 指定 JSON 策略文件，覆盖默认策略（示例见 `.env.example`）。**未设置该变量时，`extraSafelist` 不生效。**

可选配置示例（添加到 `.env.local`或`.env`）：

```env
# 工具策略文件（JSON）
BELLDANDY_TOOLS_POLICY_FILE=E:\project\belldandy\config\tools-policy.json

# 额外允许的工作区根目录（多项目协作）
BELLDANDY_EXTRA_WORKSPACE_ROOTS=E:\projects,D:\workspace
```

### 3.4 模型容灾配置 (Model Failover)

当主模型因限流 (429)、余额不足 (402)、服务器故障 (5xx) 或超时等问题不可用时，Belldandy 可以 **自动切换到备用模型**，保证不中断服务。

**快速开始**：在 `~/.belldandy/` 目录下创建 `models.json` 文件：

```json
{
  "fallbacks": [
    {
      "id": "deepseek-backup",
      "baseUrl": "https://api.deepseek.com",
      "apiKey": "sk-your-deepseek-key",
      "model": "deepseek-chat"
    }
  ]
}
```

可在 `fallbacks` 数组中添加多个备用 Profile，系统会按顺序尝试。

**配置说明**：

| 字段 | 必填 | 说明 |
|------|------|------|
| `id` | 否 | 标识名称，用于日志显示（如 `deepseek-backup`） |
| `baseUrl` | 是 | API 服务地址（OpenAI 协议兼容） |
| `apiKey` | 是 | 该服务的 API Key |
| `model` | 是 | 模型名称（如 `deepseek-chat`、`gpt-4o`） |

**环境变量**：

```env
# 自定义配置文件路径（默认 ~/.belldandy/models.json）
BELLDANDY_MODEL_CONFIG_FILE=E:\\config\\my-models.json
```

**工作原理**：

1. 每次 AI 调用时，先尝试 `.env` 中的 **主模型**。
2. 若主模型返回可重试错误（429/5xx/超时），自动切换到 `models.json` 中的 **第一个备用 Profile**。
3. 若该备用也失败，继续尝试 **下一个备用**，直到成功或全部失败。
4. 失败的 Profile 会进入 **冷却期**（限流 2 分钟，余额不足 10 分钟），冷却期间自动跳过。
5. **不可重试错误**（如 400 请求格式错误）不会触发切换——因为换 Provider 也解决不了。

**优先级顺序**：严格按 `fallbacks` 数组顺序，从上到下依次尝试：

```
.env 主模型 (Primary) → fallbacks[0] → fallbacks[1] → fallbacks[2] → ...
```

**多模型配置示例**：

```json
{
  "fallbacks": [
    { "id": "kimi-k2.5",     "baseUrl": "https://api.moonshot.cn/v1", "apiKey": "sk-...", "model": "kimi-k2.5" },
    { "id": "deepseek-chat", "baseUrl": "https://api.deepseek.com",   "apiKey": "sk-...", "model": "deepseek-chat" },
    { "id": "ollama-local",  "baseUrl": "http://127.0.0.1:11434/v1",  "apiKey": "ollama", "model": "llama3" }
  ]
}
```

> **⚡ Cooldown 机制**：已知故障的 Profile 会被标记冷却并自动跳过（不浪费时间重试），冷却结束后自动恢复参与轮询。

> **💡 提示**：不创建 `models.json` 时，Belldandy 的行为与之前完全一致（仅使用 `.env` 中的单一配置），完全向后兼容。

### 3.5 可视化配置 (Settings UI)

如果你觉得编辑文本文件太麻烦，Belldandy 提供了全新的 Web 配置面板：

1.  启动 Belldandy (`start.bat` 或 `./start.sh`)。
2.  在 WebChat 界面右上角，点击 **⚙️ 设置图标**。
3.  在弹出的面板中，你可以：
    *   查看 **System Doctor** 诊断信息（检查 Node 版本、数据库状态、配置有效性）。
    *   修改 **OpenAI API Key**、**Base URL**、**Model**。
    *   修改 **心跳间隔**。
4.  点击 **Save**，系统会自动保存配置到 `.env.local` 并重启服务。

### 3.6 视觉与视频理解 (New!)

Belldandy 现在支持**图片**和**视频**的理解能力（需配置支持视觉的模型，如 Kimi k2.5）。

#### 3.6.1 发送图片
1. 点击聊天输入框左侧的 `+` 号（或附件按钮）。
2. 选择本地图片文件（jpg, png, webp 等）。
3. 在输入框中输入你的问题（例如：“这张图里有什么？”）。
4. 发送消息，模型将能够“看到”图片并回答。

#### 3.6.2 发送视频 (Kimi K2.5 专属)
1. 同样点击附件按钮。
2. 选择本地视频文件（mp4, mov, avi 等，建议 < 100MB）。
3. 输入问题（例如："这个视频讲了什么故事？"）。
4. 发送消息。
   - **注意**：视频上传需要一定时间，界面会显示"上传视频中"的状态提示，请耐心等待。
   - **原理**：Agent 会自动将视频上传到 Moonshot AI 的云端文件服务，获取文件 ID 后通过 `ms://` 协议引用，模型直接读取云端文件进行分析。
   - **工具模式也支持**：无论是普通对话模式还是启用了工具调用（`BELLDANDY_TOOLS_ENABLED=true`）的模式，视频理解都能正常工作。

#### 3.6.3 视频上传独立配置（高级）

如果你的 AI 服务使用了代理/网关（如 API 中转站），而该代理不支持 Moonshot 的 `/files` 文件上传端点，你可以在 `models.json` 中为视频上传配置独立的直连地址：

```json
{
  "videoUpload": {
    "apiUrl": "https://api.moonshot.cn/v1",
    "apiKey": "sk-your-moonshot-key"
  },
  "fallbacks": [...]
}
```

这样，聊天请求走代理，视频上传直连 Moonshot，互不影响。

#### 3.6.4 配置要求
使用视觉能力前，请确保 `.env` 中配置了支持视觉的模型：
```bash
# 推荐配置 (Kimi K2.5)
BELLDANDY_OPENAI_BASE_URL="https://api.moonshot.cn/v1"
BELLDANDY_OPENAI_API_KEY="sk-xxxxxxxx"
BELLDANDY_OPENAI_MODEL="kimi-k2.5-preview"
```

## 4. 启动与运行

### 4.1 极速启动 (推荐)

我们为 Windows 和 Linux/macOS 用户准备了“一键启动脚本”，它会自动完成以下所有工作：
1. 检查 Node.js 环境
2. 自动安装/更新依赖
3. 启动 Gateway 服务
4. **自动打开浏览器**并登录
5. 如果服务意外崩溃，会自动尝试重启

**Windows 用户**:
双击项目根目录下的 `start.bat`。

**macOS / Linux 用户**:
在终端运行：
```bash
./start.sh
```

### 4.2 手动启动 (高级)

如果你想更精细地控制启动过程（例如查看详细日志、调试），可以使用手动方式。

在项目根目录运行：

```bash
# 进入项目目录
cd Belldandy

# 启动 (Windows 推荐使用 PowerShell)
corepack pnpm dev:gateway
```

看到类似 `[Gateway] Listening on http://localhost:28889` 的日志，说明启动成功。

### 4.3 访问界面

打开浏览器，访问：
http://localhost:28889/
或者
[http://127.0.0.1:28889/](http://127.0.0.1:28889/)

> **✨ 首次唤醒仪式**：
> 第一次由本机访问时，你可能会看到一段 **"Initializing..."** 的终端启动动画。这是 Belldandy 的唤醒仪式，稍等其自我检查完毕即可进入聊天界面。

你会看到 WebChat 聊天界面。

### 4.4 首次配对（Pairing）

为了防止你家猫咪或邻居连上你的 AI，首次使用新设备（即使是本机浏览器）连接时，Belldandy 会启动安全配对流程：

1.  在 WebChat 发送第一条消息（例如 "你好"）。
2.  界面会提示：`Pairing required. Code: ABC123XY`。
3.  回到**运行 Gateway 的终端**，开启一个新的终端窗口，执行批准命令：

    ```bash
    cd Belldandy
    corepack pnpm pairing:approve ABC123XY
    ```

4.  回到 WebChat，再次发送消息，现在可以正常对话了。

## 5. 个性化与记忆（让它变成你的专属 AI）

Belldandy 的数据存储在你的用户主目录下的 `.belldandy` 文件夹中（例如 Windows 下是 `C:\Users\YourName\.belldandy`，Linux/Mac 下是 `~/.belldandy`）。

### 5.1 塑造人格 (SOUL)

你可以通过编辑 `.belldandy` 目录下的 Markdown 文件来定义 AI 的性格：

-   **`SOUL.md`**：核心性格文件。
    -   *例子*：`你是一个严谨的 TypeScript 专家，喜欢用代码解释问题...`
-   **`IDENTITY.md`**：身份设定。
    -   *例子*：`你的名字叫 Belldandy，是一级神，喜欢红茶...`
-   **`USER.md`**：关于你的信息。
    -   *例子*：`用户叫 vrboyzero，全栈工程师，喜欢简洁的代码...`

修改这些文件后，**重启 Gateway** 即可生效。

### 5.2 长期记忆 (Memory)

Belldandy 会自动读取并索引 `.belldandy/MEMORY.md` 和 `.belldandy/memory/*.md` 文件。

-   **`MEMORY.md`**：存放你希望它永远记住的关键事实。
-   **`memory/2026-01-31.md`**：你可以手动记录当天的笔记，Belldandy 会自动索引并在相关对话中回忆起来。

### 5.3 定时提醒 (Heartbeat)

让 Belldandy 主动提醒你！编辑 `~/.belldandy/HEARTBEAT.md`：

```markdown
# 定时任务

- [ ] 每天早上提醒我查看日程
- [ ] 喝水提醒
- [ ] 检查待办事项
```

当启用心跳功能后（`BELLDANDY_HEARTBEAT_ENABLED=true`），Belldandy 会定期读取这个文件：

- **有任务内容**：执行检查并可能主动联系你
- **文件为空**：跳过，节省 API 调用
- **深夜时段**：如果设置了 `BELLDANDY_HEARTBEAT_ACTIVE_HOURS=08:00-23:00`，深夜不会打扰你

> **注意**：心跳推送功能目前输出到日志，飞书推送正在开发中。

### 5.4 定时任务 (Cron)

比 Heartbeat 更灵活的精确定时任务系统。你可以让 Belldandy 在特定时间或按固定间隔执行任务。

**启用方式**：在 `.env.local` 中添加：

```env
BELLDANDY_CRON_ENABLED=true
```

**使用方法**：直接在对话中告诉 Belldandy，它会通过 `cron` 工具自动管理：

| 你说的话 | Belldandy 做的事 |
|----------|------------------|
| "下午 3 点提醒我开会" | 创建一次性任务 (`at`)，到点推送提醒 |
| "每 4 小时提醒我喝水" | 创建周期任务 (`every`)，循环执行 |
| "每天早上 9 点汇报新闻" | 创建周期任务，24h 间隔 |
| "列出所有定时任务" | 显示任务列表 + 状态 |
| "删掉喝水提醒" | 移除指定任务 |
| "定时任务状态" | 查看调度器运行信息 |

**与 Heartbeat 的区别**：

| | Heartbeat | Cron |
|---|-----------|------|
| **用途** | 周期性“意识”检查 | 精确定时任务 |
| **配置** | 编辑 `HEARTBEAT.md` | 对话中自然语言创建 |
| **灵活性** | 固定间隔 | 一次性 / 任意间隔 |
| **任务管理** | 修改文件 | `cron list/add/remove` |

> **💡 提示**：即使未启用 `BELLDANDY_CRON_ENABLED`，你仍可以使用 `cron` 工具创建和管理任务列表。启用后调度器才会自动执行到期的任务。

### 5.5 服务重启 (Service Restart)

Belldandy 提供了 `service_restart` 工具，让 Agent 能够主动重启 Gateway 服务。这在 Agent 修改了配置文件后特别有用——它可以自主完成"改配置 → 重启生效"的完整流程。

**使用方法**：直接在对话中告诉 Belldandy：

| 你说的话 | Belldandy 做的事 |
|----------|------------------|
| "重启一下服务" | 调用 `service_restart` 工具，3 秒倒计时后重启 |
| "刚才改了配置，帮我重启" | 调用 `service_restart({ reason: "配置已更新" })`  |

**倒计时机制**：

重启不会立即执行，而是先进行 **3 秒倒计时**：
1. WebChat 界面会弹出全屏倒计时浮层（显示 3 → 2 → 1）
2. 倒计时结束后服务自动重启
3. WebChat 会自动重连，重连成功后浮层消失

> **💡 提示**：这与 `.env` 文件保存后的自动重启、以及设置面板的"保存并重启"使用的是同一套 launcher 重启机制（exit code 100）。区别在于 Agent 调用时会有 3 秒倒计时通知。

> **⚠️ 注意**：`service_restart` 需要通过 `pnpm start`（launcher 模式）启动服务才能自动重启。如果使用 `pnpm dev:gateway` 直接启动，exit code 100 会直接终止进程而不会重启。

### 5.6 FACET 模组切换

FACET 是 Belldandy 的"职能模组"系统——通过切换不同的模组文件，可以让同一个 Agent 在不同角色之间快速转换（例如"程序员模式"、"翻译模式"、"创意写作模式"等）。

**模组文件位置**：`~/.belldandy/facets/` 目录下的 `.md` 文件。

**使用方法**：直接在对话中告诉 Belldandy：

| 你说的话 | Belldandy 做的事 |
|----------|------------------|
| "切换模组为 coder" | 调用 `switch_facet` 工具替换 SOUL.md 中的模组内容，然后自动重启服务 |
| "切换 FACET 为 translator" | 同上，切换到翻译模组 |

**工作原理**：

1. `switch_facet` 工具读取 `~/.belldandy/facets/{模组名}.md` 文件
2. 在 SOUL.md 中找到锚点行，保留锚点行及之前的所有内容（人格核心不变）
3. 将锚点行之后的内容替换为新模组内容（原子写入，不会损坏文件）
4. Agent 随后调用 `service_restart` 重启服务，清空旧模组的推理惯性

**创建自定义模组**：

在 `~/.belldandy/facets/` 目录下创建 `.md` 文件即可。文件内容会被完整追加到 SOUL.md 的锚点行之后。建议以 `## 【FACET | 模组 | 文件名】` 开头，保持格式一致。

> **💡 提示**：模组切换不会影响 SOUL.md 中的 TABOO、ETHOS、SYSTEM 等核心章节——这些内容位于锚点行之前，始终保持不变。

### 5.7 日志系统 (Logs)

Belldandy 的运行日志保存在 `~/.belldandy/logs/` 目录，支持：

- **双输出**：同时输出到控制台和文件
- **按日期分文件**：如 `gateway-2025-02-05.log`
- **按大小轮转**：单文件超过设定大小（默认 10MB）自动切分
- **自动清理**：超过保留天数（默认 7 天）的日志自动删除
- **Agent 可读**：Agent 可通过 `log_read`、`log_search` 工具回溯日志，理解任务执行情况

如需调整日志行为，可在 `.env.local` 中配置 `BELLDANDY_LOG_*` 相关变量（参见 3.2 进阶配置）。

## 6. 管理命令

Belldandy 提供了一套 CLI 工具来管理授权设备：

-   **查看已授权列表**：
    ```bash
    cd Belldandy
    corepack pnpm pairing:list
    ```
-   **查看待批准请求**：
    ```bash
    cd Belldandy
    corepack pnpm pairing:pending
    ```
-   **清理过期请求**：
    ```bash
    cd Belldandy
    corepack pnpm pairing:cleanup
    ```
-   **撤销某设备的授权**：
    ```bash
    cd Belldandy
    corepack pnpm pairing:revoke <CLIENT_ID>
    ```

## 7. 飞书渠道（手机可用）

除了 WebChat，你还可以通过飞书与 Belldandy 对话——无需公网 IP 或内网穿透！

### 7.1 配置飞书

详细配置步骤请参考 [飞书对接说明](./Belldandy飞书对接说明.md)。

简要步骤：
1. 在 [飞书开放平台](https://open.feishu.cn/) 创建企业自建应用
2. 获取 App ID 和 App Secret
3. 开启机器人能力并配置权限
4. 设置事件订阅为"长连接模式"
5. 发布应用

### 7.2 配置 Belldandy

在 `.env.local` 中添加：

```env
BELLDANDY_FEISHU_APP_ID=cli_xxxxxxxxxxxxxxxx
BELLDANDY_FEISHU_APP_SECRET=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

### 7.3 使用

1. 启动 Gateway：`corepack pnpm dev:gateway`
2. 终端显示 `Feishu WebSocket Channel started.` 和 `ws client ready` 说明连接成功
3. 打开飞书，搜索你的应用名称，开始对话！

### 7.4 渠道架构说明

Belldandy 采用了标准化的 **Channel 接口** 设计，使扩展新渠道变得简单：

- **统一接口**：所有渠道（飞书、Telegram、Discord 等）都实现相同的 `Channel` 接口
- **ChannelManager**：统一管理多个渠道的启动、停止和消息广播
- **易于扩展**：新增渠道只需实现 `start()`、`stop()`、`sendProactiveMessage()` 方法

**当前已支持的渠道**：
- ✅ 飞书 (FeishuChannel) - 已完整实现

**计划中的渠道**：
- ⏳ Telegram
- ⏳ Discord
- ⏳ Slack

> **开发者注意**：如果你想贡献新渠道实现，请参考 `packages/belldandy-channels/src/types.ts` 中的 `Channel` 接口定义。


## 8. 浏览器自动化

让 Belldandy 控制你的浏览器打开网页、截图或提取内容的黑科技功能！

### 8.1 启用方式

**推荐：自动启动**

在 `.env.local` 中添加：

```env
# 启用浏览器中继自动启动
BELLDANDY_BROWSER_RELAY_ENABLED=true
```

下次启动 Gateway 时，后台会自动运行 Relay Server。

**手动启动（备选）**

如果你想单独调试，可以手动运行：

```bash
cd Belldandy
node packages/belldandy-browser/dist/bin/relay.js
```

### 8.2 安装浏览器扩展

1.  打开 Chrome 浏览器，进入 **扩展管理页面** (`chrome://extensions`)。
2.  开启右上角的 **"开发者模式" (Developer mode)**。
3.  点击 **"加载已解压的扩展程序" (Load unpacked)**。
4.  选择项目目录下的 `apps/browser-extension` 文件夹。

### 8.3 连接使用

1.  在浏览器右上角找到 **Belldandy Relay** 的图标（一个紫色的小幽灵👻或 B 图标）。
2.  点击它，图标应该会变色或显示 "Connected"，表示已连接到 Relay Server。
3.  现在的 Agent 就可以通过 `browser_open` 等工具控制你的当前浏览器了！

## 9. 视觉感知 (Loopback Vision)

让 Belldandy 拥有“眼睛”，可以看到你通过宿主机 webcam 看到的画面。

### 9.1 原理简介 (Loopback Vision)

这是一种“回环视觉”技术：
1.  Agent 指挥浏览器打开一个镜像页面（Mirror Page）。
2.  该页面调用你的本地摄像头显示画面。
3.  Agent 对该页面进行截图，从而“看到”了画面。

### 9.2 如何使用

**前提条件**：必须先完成 **8. 浏览器自动化** 的连接步骤（安装插件并连接）。

#### 方法 A：使用内置技能 (推荐)

直接对 Belldandy 说：

> **"拍张照"** 或 **"看看我现在在哪"** 或 **"启动视觉"**

Agent 会自动调用 `camera_snap` 工具：
1.  自动打开 `/mirror.html` 页面。
2.  **关键步骤**：此时浏览器会弹窗提示“允许使用摄像头？”，**请务必点击【允许】**。
3.  等待 2 秒（你可以调整姿势）。
4.  完成拍摄并进行分析。

#### 方法 B：手动操作 (硬核模式)

## 10. 方法论系统 (Methodology System)

这是 Belldandy 的"程序性记忆"核心。它允许 Agent 将一次性的经验沉淀为标准操作流程 (SOP)，并在后续任务中自动调用。

### 10.1 核心理念
- **查阅优先**: 在执行复杂任务前，Agent 会先检查是否有现成的方法 (`method_list/search`).
- **经验沉淀**: 任务成功或踩坑后，Agent 会将经验记录为 Markdown 文件 (`method_create`).
- **自我进化**: 随着使用时间的增加，`methods/` 目录下的 SOP 越多，Agent 越聪明。

### 10.2 常用工具
- `method_list`: 列出所有已沉淀的方法。
- `method_search`: 搜索特定关键词的方法。
- `method_read`: 读取方法的具体步骤。
- `method_create`: 创建或更新方法文档。

### 10.3 给用户的建议
- 您可以在对话中显式要求 Belldandy："把刚才的操作总结为一个方法保存下来。"
- 您也可以手动在 `~/.belldandy/methods/` 目录下编写 `.md` 文件，教 Belldandy 做事。

## 11. 插件与钩子系统 (Plugin & Hook System)

Belldandy 提供了完整的插件系统，允许开发者扩展 Agent 的能力。

### 11.1 钩子系统

钩子是插件干预 Agent 行为的核心机制。Belldandy 支持 **13 种生命周期钩子**：

| 类别 | 钩子名称 | 用途 |
|------|---------|------|
| **Agent** | `before_agent_start` | 在 Agent 开始前注入系统提示词或上下文 |
| **Agent** | `agent_end` | Agent 完成后分析对话、记录日志 |
| **消息** | `message_received` | 收到消息时触发（日志/触发器） |
| **消息** | `message_sending` | 发送前修改或取消消息 |
| **消息** | `message_sent` | 消息发送后触发（日志） |
| **工具** | `before_tool_call` | 工具调用前修改参数或阻止执行 |
| **工具** | `after_tool_call` | 工具调用后结果审计 |
| **会话** | `session_start` / `session_end` | 会话开始/结束时触发 |
| **网关** | `gateway_start` / `gateway_stop` | 服务启动/停止时触发 |

### 11.2 开发插件

插件是一个导出 `activate(context)` 方法的 JS/MJS 文件：

```javascript
// my-plugin.mjs
export const id = "my-plugin";
export const name = "My Plugin";

export function activate(context) {
  // 注册钩子
  context.hooks.register({
    source: id,
    hookName: "before_tool_call",
    priority: 10, // 优先级越高越先执行
    handler: (event, ctx) => {
      console.log(`工具调用: ${event.toolName}`);
      // 返回 { block: true } 可阻止执行
      // 返回 { params: {...} } 可修改参数
    }
  });

  // 注册新工具
  context.tools.register({
    name: "my_tool",
    description: "我的自定义工具",
    execute: async (params) => {
      return { success: true, output: "Hello from my tool!" };
    }
  });
}
```

### 11.3 加载插件

将插件文件放到 `~/.belldandy/plugins/` 目录下，Gateway 启动时会自动加载。

## 12. MCP 支持 (Model Context Protocol)

MCP 是 Anthropic 提出的标准化协议，让 AI 助手能够连接外部数据源和工具。

### 12.1 启用 MCP

在 `.env.local` 中添加：

```env
# 启用 MCP 支持（需要同时启用工具系统）
BELLDANDY_TOOLS_ENABLED=true
BELLDANDY_MCP_ENABLED=true
```

### 12.2 配置 MCP 服务器

在 `~/.belldandy/mcp.json` 中定义要连接的 MCP 服务器：

```json
{
  "version": "1.0.0",
  "servers": [
    {
      "id": "filesystem",
      "name": "文件系统",
      "description": "提供文件系统访问能力",
      "transport": {
        "type": "stdio",
        "command": "npx",
        "args": ["-y", "@modelcontextprotocol/server-filesystem", "/home/user/documents"]
      },
      "autoConnect": true,
      "enabled": true
    },
    {
      "id": "github",
      "name": "GitHub",
      "description": "GitHub API 访问",
      "transport": {
        "type": "stdio",
        "command": "npx",
        "args": ["-y", "@modelcontextprotocol/server-github"],
        "env": {
          "GITHUB_PERSONAL_ACCESS_TOKEN": "ghp_xxxxxxxxxxxx"
        }
      },
      "autoConnect": true,
      "enabled": true
    }
  ],
  "settings": {
    "defaultTimeout": 30000,
    "debug": false,
    "toolPrefix": true
  }
}
```

### 12.3 传输类型

| 类型 | 说明 | 适用场景 |
|------|------|----------|
| `stdio` | 通过子进程的 stdin/stdout 通信 | 本地 MCP 服务器（推荐） |
| `sse` | 通过 HTTP Server-Sent Events 通信 | 远程 MCP 服务器 |

### 12.4 常用 MCP 服务器

| 服务器 | 命令 | 功能 |
|--------|------|------|
| `@modelcontextprotocol/server-filesystem` | `npx -y @modelcontextprotocol/server-filesystem /path` | 文件系统访问 |
| `@modelcontextprotocol/server-github` | `npx -y @modelcontextprotocol/server-github` | GitHub API |
| `@modelcontextprotocol/server-sqlite` | `npx -y @modelcontextprotocol/server-sqlite` | SQLite 数据库 |
| `@modelcontextprotocol/server-puppeteer` | `npx -y @modelcontextprotocol/server-puppeteer` | 浏览器自动化 |

### 12.5 工具命名

MCP 工具在 Belldandy 中的命名格式为：`mcp_{serverId}_{toolName}`

例如：
- `mcp_filesystem_read_file` - 文件系统服务器的读取文件工具
- `mcp_github_create_issue` - GitHub 服务器的创建 Issue 工具

> **💡 提示**：启动 Gateway 后，日志会显示已连接的 MCP 服务器和注册的工具数量。

如果你想体验控制感，可以手动指挥 Agent：

1.  **"打开镜像页"** -> Agent 导航至 `http://.../mirror.html`。
2.  **"允许摄像头"** -> 你手动在浏览器点击允许。
3.  **"现在截图"** -> Agent 截图并分析。

---

## 13. 语音交互 (Voice Interaction)

让 Belldandy 开口说话！支持免费且高质量的 Edge TTS（微软晓晓/云希）。

### 13.1 快速开启/关闭

无需配置复杂文件，直接在对话中对 Agent 说：

*   **开启语音**：对它说 "开启语音模式" 或 "我想听你说话"。
    *   Agent 会自动进入 TTS 模式，每条回复都会附带语音播放器。
*   **关闭语音**：对它说 "关闭语音" 或 "太吵了"。
    *   Agent 会立即停止生成音频。

> **原理**：Agent 会在你的工作区目录创建/删除一个名为 `TTS_ENABLED` 的信号文件。

### 13.2 进阶配置

默认使用 **Edge TTS**（免费）。如果你想使用 **OpenAI TTS**（付费但声线不同），可以通过调用工具时指定参数，或者让 Agent 帮你设置。

**支持的声音（Edge TTS - 推荐）**：
*   `zh-CN-XiaoxiaoNeural` (晓晓 - 温暖女声)
*   `zh-CN-YunxiNeural` (云希 - 干练男声)
*   `en-US-AriaNeural` (Aria - 通用女声)

---

## 14. 常见问题 (FAQ)

**Q: 启动时提示 `EADDRINUSE` 端口被占用？**
A: 说明端口 28889 已经被占用了。你可以修改 `.env.local` 中的 `BELLDANDY_PORT=28890` 换一个端口。

**Q: 如何让从外网访问？**
A: Belldandy 默认监听 `0.0.0.0`，在局域网内可以直接通过 IP 访问（需要配对）。若要公网访问，建议使用 Cloudflare Tunnel 或 Frp 等内网穿透工具，并务必开启 `BELLDANDY_AUTH_MODE=token` 增加安全性。

**Q: 记忆检索有时候不准？**
A: 目前使用的是混合检索（关键词+向量）。请确保你的 `.env.local` 中正确配置了 Embedding 模型，且 `BELLDANDY_EMBEDDING_ENABLED=true`。

**Q: Windows 下可以执行 CMD 命令吗？**
A: 可以。Belldandy 已对 Windows 原生命令 (`copy`, `move`, `del`, `ipconfig` 等) 进行了特别支持。注意：为了安全起见，`del` 命令禁止使用 `/s` (递归) 或 `/q` (静默) 参数。

---
*Belldandy - Your Personal AI Assistant*
