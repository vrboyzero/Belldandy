# 飞书 (Feishu) 机器人配置指南

为了让 Belldandy 能通过飞书与你在手机上对话，你需要创建一个飞书应用并获取相关凭证。

不用担心，**个人用户**也可以免费创建（无需企业认证，或者可以自己创建一个只有一个人的企业）。

## 1. 创建应用

1.  登录 [飞书开放平台](https://open.feishu.cn/)（用你的飞书账号扫码即可）。
2.  点击右上角的 **“开发者后台”**。
3.  点击 **“创建企业自建应用”**。
4.  填写应用信息：
    -   **名称**：`Belldandy` (或者你喜欢的名字)
    -   **描述**：`My AI Assistant`
    -   **图标**：随便上传一张图片。
    -   点击 **“创建”**。

## 2. 获取凭证 (Credentials)

创建成功后，进入应用详情页的 **“凭证与基础信息”** 页面：

-   找到 **App ID** 和 **App Secret**。
-   👀 **请记下这两个值**，稍后我们配置 Belldandy 时需要用到。
test App ID:cli_a9f5a7362838dbd9
App Secret:V7uVxVTVdw2EBhaXUXVBXcM0m45j4dcq
## 3. 开启机器人能力

1.  在左侧菜单点击 **“应用功能” -> “机器人”**。
2.  点击 **“启用机器人”** 开关。

## 4. 配置权限 (Permissions)

为了能收发消息，我们需要申请权限。
在左侧菜单点击 **“开发配置” -> “权限管理”**，搜索并勾选以下权限（点击“批量开通”或逐个开通）：

-   **核心权限**：
    -   `im:message` (获取用户发给机器人的单聊消息)
    -   `im:message:send_as_bot` (以应用身份发送消息)
    -   `im:chat` (获取群组信息 - 可选，为了将来支持群聊)
    -   `im:resource` (获取与上传图片或文件资源)

> 💡 **注意**：开通权限后，需要发布版本才能生效。但我们最后统一发布。

## 5. 配置 Belldandy (填入凭证)

在配置长连接之前，我们需要将刚才获取的 **App ID** 和 **App Secret** 配置到 Belldandy 中。

1.  在 Belldandy 项目根目录下创建或编辑 `.env` 文件。
2.  添加以下配置（替换为你实际获取的值）：
    ```bash
    BELLDANDY_FEISHU_APP_ID=cli_a9f5a7362838dbd9    # 你的 App ID
    BELLDANDY_FEISHU_APP_SECRET=V7uVxVTVdw2EBhaXUXVBXcM0m45j4dcq   # 你的 App Secret
    ```
3.  保存文件。

## 6. 配置长连接 (WebSocket) - **关键步骤**

这是我们无需公网 IP 就能使用的黑科技。

1.  在左侧菜单点击 **“开发配置” -> “事件订阅”**。
2.  配置方式选择：**“长连接模式”** (WebSocket)。
    -   *(如果没看到这个选项，说明你的企业可能还在旧版，通常新创建的都支持。或者你找一下是否有"配置方式"的切换按钮)*
3.  **添加事件**：
    -   点击 **“添加事件”** 按钮。
    -   搜索并选择：`接收消息 (v2.0)` 或 `im.message.receive_v1`。
    -   点击确认。

## 7. 发布应用

所有配置改动（包括权限申请）都需要发布版本才会生效。

1.  在左侧菜单点击 **“应用发布” -> “版本管理与发布”**。
2.  点击 **“创建版本”**。
3.  **版本号**：填 `1.0.0`。
4.  **注**：随便填个 `Init`。
5.  **可用范围**：
    -   点击 **“编辑”**。
    -   选择 **“所有员工”** 或者 **“按人员选择”**（把你自己的名字选上）。
    -   点击保存。
6.  点击 **“申请发布”**（如果你是管理员，通常会自动通过；如果不是，需要去飞书管理后台审核通过）。

---

## ✅ 准备完毕

现在，你的 Belldandy 已经配置好了飞书凭证，并且飞书应用也配置了长连接模式。

## 7. 启动与使用

1.  在 Belldandy 项目根目录运行：

    ```bash
    corepack pnpm dev:gateway
    ```

2.  检查终端输出，应该能看到类似：
    ```
    [info]: [ 'client ready' ]
    [info]: [ 'event-dispatch is ready' ]
    Feishu WebSocket Channel started.
    [info]: [ '[ws]', 'ws client ready' ]
    ```

3.  现在打开飞书，搜索你创建的应用名称（如 `Belldandy`），开始对话！

## 8. 常见问题

**Q: 发送消息后 Belldandy 不回复？**
A: 检查 Gateway 终端是否有错误日志。确保：
-   应用已发布且审核通过
-   权限已正确开通
-   已添加 `im.message.receive_v1` 事件订阅

**Q: 出现"系统繁忙"错误？**
A: 这可能是 Feishu 服务端暂时问题，或应用未正确发布。尝试重新发布应用版本。

**Q: 模型调用失败 (HTTP 400) - thinking/reasoning 相关错误？**
A: 如果使用 Kimi K2.5，这是已知问题。Belldandy 已自动禁用 thinking 模式以兼容工具调用。如果仍有问题，尝试换用其他模型（如 `moonshot-v1-8k`）。

---
*Belldandy - 现在可以通过飞书随时与你的 AI 助手对话了！*
